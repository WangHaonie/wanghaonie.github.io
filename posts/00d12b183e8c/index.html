

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="WangHaonie">
  <meta name="keywords" content="">
  
    <meta name="description" content="æ–‡ç« è¾ƒé•¿ï¼Œè¯·è€å¿ƒé˜…è¯»~  å‰è¨€å¦‚æœä½ ä¸å–œæ¬¢ WinForms ä»…ä»…æ˜¯å› ä¸ºå®ƒä¸æ”¯æŒæ·±è‰²ä¸»é¢˜çš„è¯ï¼Œé‚£ä¸€å®šè¦çœ‹çœ‹è¿™ç¯‡æ–‡ç« ã€‚è¦æ³¨æ„çš„æ˜¯ï¼š  æœ€æ–°ç‰ˆ .NET è²Œä¼¼å·²ç»æ”¯æŒæ·±è‰²æ¨¡å¼ï¼Œä½†æœ¬æ–‡åªé’ˆå¯¹ä½ç‰ˆæœ¬ .NETï¼› æ¨èæœ‰ä¸€å®š Win32&amp;#x2F;C++ ç¼–ç¨‹ç»éªŒçš„æœ‹å‹ä»¬é˜…è¯»ï¼Œæ²¡æœ‰ä¹Ÿæ²¡å…³ç³»ï¼Œå¾ˆç®€å•çš„ï¼› åŸç”Ÿæ·±è‰²ä¸»é¢˜ä½œç”¨èŒƒå›´æœ‰é™ (æ¯•ç«Ÿä¸æ˜¯å…¬å¼€çš„)ï¼Œä¸èƒ½è¾¾åˆ° 100% è¦†ç›–ï¼Œä¸”ä»…æ”¯æŒ Windows 10 1">
  
  
  
  <title>ä»é›¶å¼€å§‹è®©ä½ çš„ WinForms åº”ç”¨ç¨‹åºä¹Ÿç”¨ä¸ŠåŸç”Ÿæ·±è‰²ä¸»é¢˜ | WangHaonie çš„åšå®¢</title>
  <link rel="stylesheet" href="/css/frosted.css">
  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wanghaonie.github.io","root":"/","version":"1.9.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true,"scope":"home"},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":"G-N644FC8JLJ"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-N644FC8JLJ", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-N644FC8JLJ');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WangHaonie çš„åšå®¢</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span id="wanghaonie-nav" candidate-icon="ğŸ§¿ğŸ””ğŸ“…ğŸš©ğŸ§¡">ğŸ‰æ›´å¤š</span>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                
                <span>ğŸ ä¸»é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                
                <span>ğŸ˜å…³äº</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                
                <span>ğŸ·ï¸æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                
                <span>ğŸ“–æ–‡ç« </span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                
                <span>ğŸŒåˆ†ç«™</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2gh()" href="#" target="_self">
                    
                    <span>ğŸŒä¸»ç«™ï¼šGitHub Pages</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2lan()" href="#" target="_self">
                    
                    <span>ğŸŒä¸»ç«™ï¼šæœ¬åœ°å±€åŸŸç½‘</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2v()" href="#" target="_self">
                    
                    <span>ğŸŒåˆ†ç«™ï¼šVercel</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2n()" href="#" target="_self">
                    
                    <span>ğŸŒåˆ†ç«™ï¼šNetlify</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/reward" target="_self">
                
                <span>ğŸ’°æ‰“èµ</span>
              </a>
            </li>
          
        <!--
        -->
        <!--
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        -->
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" false
     style="background: url('/null') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">ä»é›¶å¼€å§‹è®©ä½ çš„ WinForms åº”ç”¨ç¨‹åºä¹Ÿç”¨ä¸ŠåŸç”Ÿæ·±è‰²ä¸»é¢˜</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-23 08:31" pubdate>
          2025-07-23 08:31:03
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.3k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          78 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">ä»é›¶å¼€å§‹è®©ä½ çš„ WinForms åº”ç”¨ç¨‹åºä¹Ÿç”¨ä¸ŠåŸç”Ÿæ·±è‰²ä¸»é¢˜</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š3 åˆ†é’Ÿå‰
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p class="note note-danger">æ–‡ç« è¾ƒé•¿ï¼Œè¯·è€å¿ƒé˜…è¯»~</p>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¦‚æœä½ ä¸å–œæ¬¢ WinForms ä»…ä»…æ˜¯å› ä¸ºå®ƒä¸æ”¯æŒæ·±è‰²ä¸»é¢˜çš„è¯ï¼Œé‚£ä¸€å®šè¦çœ‹çœ‹è¿™ç¯‡æ–‡ç« ã€‚è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>æœ€æ–°ç‰ˆ .NET è²Œä¼¼å·²ç»æ”¯æŒæ·±è‰²æ¨¡å¼ï¼Œä½†æœ¬æ–‡åªé’ˆå¯¹ä½ç‰ˆæœ¬ .NETï¼›</li>
<li>æ¨èæœ‰ä¸€å®š Win32&#x2F;C++ ç¼–ç¨‹ç»éªŒçš„æœ‹å‹ä»¬é˜…è¯»ï¼Œæ²¡æœ‰ä¹Ÿæ²¡å…³ç³»ï¼Œå¾ˆç®€å•çš„ï¼›</li>
<li>åŸç”Ÿæ·±è‰²ä¸»é¢˜ä½œç”¨èŒƒå›´æœ‰é™ (æ¯•ç«Ÿä¸æ˜¯å…¬å¼€çš„)ï¼Œä¸èƒ½è¾¾åˆ° 100% è¦†ç›–ï¼Œä¸”ä»…æ”¯æŒ <strong>Windows 10 1903 åŠä»¥ä¸Š</strong> ç³»ç»Ÿã€‚æœ¬æ–‡å°†å¯¹ä»¥ä¸‹ç±»å‹çš„æ§ä»¶çš„æ·±è‰²ä¸»é¢˜è¿›è¡Œè®¨è®ºï¼Œå…¶ä»–æ§ä»¶è¯·è‡ªè¡Œå°è¯• <strong>å¥—ç”¨ç±»ä¼¼çš„æ–¹æ³•</strong> æˆ–è€… <strong>æŸ¥é˜…ç›¸å…³èµ„æ–™</strong> æˆ–è€… <strong>ç›´æ¥ä½¿ç”¨ç¬¬ä¸‰æ–¹ UI åº“</strong> æˆ–è€… <strong>è½¬å‘ WPF</strong> æˆ–è€… <strong>æ”¾å¼ƒ</strong>ã€‚ğŸ˜…</li>
<li>ç†è®ºä¸Šæ¥è¯´æ·±è‰²ä¸»é¢˜æ”¯æŒçƒ­é‡è½½ï¼Œå³åœ¨è¿è¡Œæ—¶å¼€å¯æˆ–å…³é—­æ·±è‰²ä¸»é¢˜ã€‚ä½†æˆ‘ä¸æ¨èï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯ç”¨æˆ·æ›´æ”¹ä¸»é¢˜æ—¶è¯¢é—®æ˜¯å¦é‡å¯åº”ç”¨ç¨‹åºï¼Œè‹¥ä½ æœ‰éœ€æ±‚ä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹ã€‚</li>
<li>ä»¥ä¸‹æ‰€æœ‰è¯¦ç»†å®ç°éƒ½èƒ½åœ¨ <a target="_blank" rel="noopener" href="https://github.com/WangHaonie/PlainCEETimer">PlainCEETimer</a> ä¸­æ‰¾åˆ°ã€‚</li>
</ul>
<h2 id="æ”¯æŒçš„æ§ä»¶"><a href="#æ”¯æŒçš„æ§ä»¶" class="headerlink" title="æ”¯æŒçš„æ§ä»¶"></a>æ”¯æŒçš„æ§ä»¶</h2><h3 id="ç®€å•å®ç°"><a href="#ç®€å•å®ç°" class="headerlink" title="ç®€å•å®ç°"></a>ç®€å•å®ç°</h3><p>ä¿®æ”¹ <code>ForeColor</code> å’Œ <code>BackColor</code> å±æ€§å°±èƒ½å®ç°ã€‚</p>
<ul>
<li>Form (é™¤æ ‡é¢˜æ ä»¥å¤–)</li>
<li>Panel</li>
<li>GroupBox (é™¤æ ‡é¢˜ä»¥å¤–)</li>
<li>Label (è·Ÿéšçˆ¶å®¹å™¨è‡ªåŠ¨é€‚åº”)</li>
<li>LinkLabel (è·Ÿéšçˆ¶å®¹å™¨è‡ªåŠ¨é€‚åº”)</li>
<li>PictureBox (è·Ÿéšçˆ¶å®¹å™¨è‡ªåŠ¨é€‚åº”)</li>
</ul>
<h3 id="åŸç”Ÿæ”¯æŒ"><a href="#åŸç”Ÿæ”¯æŒ" class="headerlink" title="åŸç”Ÿæ”¯æŒ"></a>åŸç”Ÿæ”¯æŒ</h3><p>è°ƒç”¨ Win32 API å³å¯å®ç°ã€‚</p>
<ul>
<li>Form (æ ‡é¢˜æ )</li>
<li>ContextMenu</li>
<li>Button</li>
<li>TextBox</li>
<li>CheckBox</li>
<li>RadioButton</li>
<li>ComboBox</li>
<li>TreeView</li>
<li>NumericUpDown</li>
<li>ListView (åˆ—è¡¨éƒ¨åˆ†)</li>
<li><del>TabControl</del> (æ¢ç”¨ TreeView)</li>
<li><del>ContextMenuStrip</del> (æ¢ç”¨ ContextMenu)</li>
</ul>
<h3 id="è‡ªç»˜å®ç°"><a href="#è‡ªç»˜å®ç°" class="headerlink" title="è‡ªç»˜å®ç°"></a>è‡ªç»˜å®ç°</h3><p>é‡å†™ <code>OnPaint</code> ç­‰æ–¹æ³•æ‰èƒ½å®ç°</p>
<ul>
<li>GroupBox</li>
</ul>
<h3 id="Hook-å®ç°"><a href="#Hook-å®ç°" class="headerlink" title="Hook å®ç°"></a>Hook å®ç°</h3><ul>
<li>é‡å†™ <code>HookProc</code> æ‹¦æˆªç›¸å…³æ¶ˆæ¯å³å¯å®ç°<ul>
<li>ColorDialog</li>
<li>FontDialog</li>
</ul>
</li>
<li>å­ç±»åŒ–å³å¯å®ç°<ul>
<li>ListView (åˆ—è¡¨å¤´)</li>
</ul>
</li>
<li>éœ€è¦å€ŸåŠ© IAT Hook æ‰èƒ½å®ç°<ul>
<li>ScrollBar</li>
</ul>
</li>
</ul>
<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="çª—å£å¥æŸ„"><a href="#çª—å£å¥æŸ„" class="headerlink" title="çª—å£å¥æŸ„"></a>çª—å£å¥æŸ„</h3><p>çª—å£å¥æŸ„ (hWnd, Handle of Window)ï¼Œå¯ä»¥ç†è§£ä¸ºç”¨äºçª—å£çš„ä¸€ç§å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ‰€æœ‰çš„æ§ä»¶å’Œçª—å£åœ¨åˆ›å»ºæ—¶éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå…¨æ–°çš„ HWNDï¼Œæœ‰äº†å®ƒæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸Šé¢è¿›è¡Œä¸€åˆ‡æˆ‘ä»¬æƒ³åšçš„äº‹æƒ…ã€‚å®ƒåœ¨ Win32 ä¸­ç±»å‹ä¸º HWNDï¼Œåœ¨ C# WinForms ä¸­å¯¹åº”å®ç°äº† IWin32Window çš„å¯¹è±¡çš„ Handle å±æ€§ï¼Œç±»å‹ä¸º IntPtrã€‚</p>
<p>å¦å¤–ï¼Œåœ¨ Win32 ä¸­ æ§ä»¶å³çª—å£ï¼Œçª—å£å³æ§ä»¶ï¼Œä¸¤è€…æ¦‚å¿µå‡ ä¹ç›¸åŒã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ WinForms é‡Œ Form å’Œå…¶ä»–å¤§å¤šæ•°æ§ä»¶éƒ½ç»§æ‰¿è‡ª Controlï¼Œå› ä¸º WinForms æœ¬è´¨å°±æ˜¯å¯¹ Win32 çš„å°è£…ï¼Œç±»ä¼¼äº MFCï¼Œæ¶æ„ä»€ä¹ˆçš„è‚¯å®šè¦ä¸ Win32 ä¸€è‡´ã€‚</p>
<p>ä¸è¿‡åªè¦æœ‰äº† HWNDï¼Œæˆ‘ä»¬å°±èƒ½å¾—çŸ¥å¯¹æ–¹ç©¶ç«Ÿæ˜¯çª—å£è¿˜æ˜¯æ§ä»¶ã€‚</p>
<h3 id="æ¶ˆæ¯å¾ªç¯"><a href="#æ¶ˆæ¯å¾ªç¯" class="headerlink" title="æ¶ˆæ¯å¾ªç¯"></a>æ¶ˆæ¯å¾ªç¯</h3><p>æ¶ˆæ¯å¾ªç¯æ˜¯ Win32 ä¸­æ¯ä¸ªæ§ä»¶çš„æ ¸å¿ƒã€‚æœ‰äº†å®ƒï¼Œæ§ä»¶æ‰èƒ½è·å–ç³»ç»Ÿã€ç”¨æˆ·å¯¹å®ƒçš„æŒ‡ç¤ºï¼Œä»è€Œåšå‡ºç›¸åº”çš„å›åº”ã€‚</p>
<p>æ¶ˆæ¯çš„è½½ä½“åœ¨ Win32 å’Œ WinForms ä¸­è¢«å®šä¹‰ä¸º MSG&#x2F;Message ç±»å‹ï¼Œå®ƒæ˜¯ä¸€ç§ç»“æ„ä½“ (struct)ï¼Œä¸»è¦å­—æ®µæœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>Win32 å£°æ˜</th>
<th>WinForms å£°æ˜</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>HWND hwnd</td>
<td>IntPtr HWnd</td>
<td>æ¶ˆæ¯æ¥æ”¶æ–¹çš„å¥æŸ„</td>
</tr>
<tr>
<td>UINT message</td>
<td>int Msg</td>
<td>æ¶ˆæ¯ç¼–å·ï¼ŒåŒºåˆ†æ˜¯ä»€ä¹ˆæ¶ˆæ¯</td>
</tr>
<tr>
<td>WPARAM wParam</td>
<td>IntPtr WParam</td>
<td>å¯å¤§è‡´ç†è§£ä¸ºé™„åŠ çš„å°å‹æ•°æ®</td>
</tr>
<tr>
<td>LPARAM lParam</td>
<td>IntPtr LParam</td>
<td>å¯å¤§è‡´ç†è§£ä¸ºé™„åŠ çš„å¤§å‹æ•°æ®</td>
</tr>
<tr>
<td>&lt;æ¶ˆæ¯å‡½æ•°è¿”å›å€¼&gt;</td>
<td>IntPtr Result</td>
<td>è¯¥æ¶ˆæ¯çš„å¤„ç†ç»“æœ</td>
</tr>
</tbody></table>
<p>ä½ å¯èƒ½æ³¨æ„åˆ° æ¶ˆæ¯ç¼–å· åœ¨ Win32 æ˜¯ UINT (C# é‡Œä¹Ÿæœ‰ uint)ï¼Œåœ¨ WinForms é‡Œæ˜¯ intï¼Œéš¾é“ä¸ä¼šå‡ºé”™å—ï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜æˆ‘åªèƒ½è¯´ Win32 é‡Œå¤šåŠåˆæ˜¯ä»€ä¹ˆå†å²é—ç•™ä¸‹æ¥çš„åŸå› ï¼Œæ‰ç”¨ UINTã€‚ä½†å¯ä»¥è‚¯å®šçš„æ˜¯ï¼ŒWin32 ä½¿ç”¨çš„æ¶ˆæ¯ï¼ŒèŒƒå›´éƒ½ä¸ä¼šè¶…å‡º int çš„æœ€å¤§å€¼ï¼Œè€Œåœ¨ C# ä¸­ int åˆæ˜¯å¾ˆå¸¸ç”¨çš„ç±»å‹ï¼Œæ‰€ä»¥å°±ç†æ‰€å½“ç„¶çš„å˜æˆäº† intï¼Œè¿™æ ·ä¹Ÿä¸ä¼šæº¢å‡ºã€‚</p>
<h3 id="çª—å£è¿‡ç¨‹"><a href="#çª—å£è¿‡ç¨‹" class="headerlink" title="çª—å£è¿‡ç¨‹"></a>çª—å£è¿‡ç¨‹</h3><p>çª—å£è¿‡ç¨‹ (WndProc, Window Procedure)ï¼Œå°±æ˜¯è¯¥çª—å£ç”¨äºå¤„ç†æ¶ˆæ¯çš„ â€œå·¥å‚â€ï¼Œåœ¨ Win32 é‡Œå¯¹åº” WNDPROCï¼Œä»–ä¸€èˆ¬é•¿è¿™ä¸ªæ ·å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">LRESULT CALLBACK <span class="hljs-title">WndProc</span><span class="hljs-params">(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (uMsg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_CREATE:<br>            <span class="hljs-comment">// å‡†å¤‡åˆ›å»ºçª—å£</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// è¡¨ç¤ºå·²è¢«å¤„ç†</span><br><br>        <span class="hljs-comment">// å…¶ä»–æ¶ˆæ¯</span><br><br>        <span class="hljs-keyword">case</span> WM_DESTROY:<br>            <span class="hljs-comment">// çª—å£å·²é”€æ¯</span><br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// è·³å‡º switchï¼Œèµ°å¤–é¢çš„è¯­å¥</span><br><br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">DefWindowProc</span>(hWnd, uMsg, wParam, lParam); <span class="hljs-comment">// è®©é»˜è®¤çš„æ¶ˆæ¯å‡½æ•°å¤„ç†ä¸Šæ–¹æœªå¤„ç†çš„æ¶ˆæ¯</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// è¢« break è·³åˆ°è¿™é‡Œ</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ WinForms é‡Œï¼Œä»–é•¿è¿™ä¸ªæ ·å­ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WndProc</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> Message m</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (m.Msg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_CREATE:<br>            <span class="hljs-comment">// å‡†å¤‡åˆ›å»ºçª—å£</span><br>            m.Result = IntPtr.Zero; <span class="hljs-comment">// è¡¨ç¤ºå·²è¢«å¤„ç†</span><br>            <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-comment">// å…¶ä»–æ¶ˆæ¯</span><br><br>        <span class="hljs-keyword">case</span> WM_DESTROY:<br>            <span class="hljs-comment">// çª—å£å·²é”€æ¯</span><br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// è·³å‡º switchï¼Œèµ°å¤–é¢çš„è¯­å¥</span><br><br>        <span class="hljs-literal">default</span>:<br>            m.Result = DefWindowProc(hWnd, uMsg, wParam, lParam); <span class="hljs-comment">// è®©é»˜è®¤çš„æ¶ˆæ¯å‡½æ•°å¤„ç†ä¸Šæ–¹æœªå¤„ç†çš„æ¶ˆæ¯</span><br>            <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    m.Result = IntPtr.Zero; <span class="hljs-comment">// è¢« break è·³åˆ°è¿™é‡Œ</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¯è§å°½ç®¡ä¸¤è€…çš„å‡½æ•°ç­¾åä¸åŒï¼Œä½†å†…éƒ¨éƒ½å¹²ç€åŒæ ·çš„äº‹ï¼Œå½“ç„¶ä»¥ä¸Šä»£ç ä»…ä¾›å‚è€ƒï¼Œå®é™…ä¼šæ¯”è¿™æ›´å¤æ‚ã€‚</p>
<h3 id="é’©å­è¿‡ç¨‹"><a href="#é’©å­è¿‡ç¨‹" class="headerlink" title="é’©å­è¿‡ç¨‹"></a>é’©å­è¿‡ç¨‹</h3><p>é’©å­è¿‡ç¨‹ (HookProc, Hook Procedureï¼Œä¹Ÿå«æŒ‚é’©è¿‡ç¨‹) æœ‰ä¸¤ç§å«ä¹‰ï¼Œä¸€æ˜¯é€šè¿‡ SetWindowsHookEx å‡½æ•°è®¾ç½®çš„å…¨å±€é’©å­ï¼ŒäºŒæ˜¯ Common Dialogs çš„ ColorDialogã€FontDialog æ¨¡æ¿ (CHOOSECOLORã€CHOOSEFONT) æä¾›çš„ä¸€ä¸ªç§æœ‰çš„ç±»ä¼¼äº WndProc çš„ä¸œè¥¿ï¼Œä»…ä¾›è‡ªå·±ä½¿ç”¨ï¼Œä¸å‰è€…æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚æœ¬æ–‡ä¸»è¦è®¨è®ºåè€…ã€‚</p>
<p>åœ¨ WinForms é‡Œï¼Œå®ƒé€šå¸¸é•¿è¿™ä¸ªæ ·å­ï¼Œéå¸¸ç±»ä¼¼äº Win32 çš„ WndProcï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wparam, IntPtr lparam</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (msg)<br>	&#123;<br>        <span class="hljs-comment">// ... å¤„ç†å„æ¶ˆæ¯</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> IntPtr.Zero; <span class="hljs-comment">// é’©å­è¿‡ç¨‹ä¸€èˆ¬éƒ½è¿”å› 0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="å­ç±»åŒ–"><a href="#å­ç±»åŒ–" class="headerlink" title="å­ç±»åŒ–"></a>å­ç±»åŒ–</h3><p>å­ç±»åŒ– (Subclassing) çš„ä½œç”¨æœ‰ç‚¹ç±»ä¼¼äºé’©å­ï¼Œåªä¸è¿‡å®ƒå¤šç”¨äºé’©ä½çª—å£ä¸­çš„å­æ§ä»¶ã€‚åªæœ‰åœ¨é€šå¸¸ç”¨äºæ— æ³•é€šè¿‡å¸¸è§„æ‰‹æ®µæ›´æ”¹æ§ä»¶æ ·å¼æˆ–è¡Œä¸ºæ—¶ä½¿ç”¨ã€‚</p>
<p>å› ä¸ºä¸Šé¢è¯´äº†ï¼Œæ¯ä¸ªæ§ä»¶&#x2F;çª—å£éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ WndProcï¼Œè€Œæˆ‘ä»¬åœ¨çª—å£ä¸­å¤„ç†æ§ä»¶æ ·å¼&#x2F;è¡Œä¸ºæ—¶åªèƒ½è·å–åˆ°æœ¬çª—ä½“çš„ WndProcï¼Œè™½ç„¶èƒ½æ”¶åˆ°ä¸€äº›å‘é€ç»™æ§ä»¶çš„æ¶ˆæ¯ï¼Œä½†æœ‰å…³ç»˜åˆ¶çš„æ¶ˆæ¯å°±å¿…é¡»æ‹¦æˆªæ§ä»¶è‡ªå·±çš„ WndProcï¼Œæ‰€ä»¥ å­ç±»åŒ– å°±ç›¸å½“äºåœ¨çª—å£ä¸­ç›‘å¬æ‰€æœ‰ç³»ç»Ÿå‘é€ç»™æ§ä»¶çš„æ¶ˆæ¯ (å› ä¸ºç³»ç»Ÿç»™æ§ä»¶å‘é€æ¶ˆæ¯åŸºæœ¬ä¸ä¼šç»è¿‡æ‰€åœ¨çª—ä½“çš„ WndProc)ï¼Œä»è€Œè¿›è¡Œæ›´å¤šè‡ªå®šä¹‰çš„åŠŸèƒ½ã€‚</p>
<p>åœ¨ Win32 ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ CommCtrl.h æä¾›çš„ SetWindowSubclass å’Œ RemoveWindowSubclass æ¥å¯¹çª—ä½“è¿›è¡Œ&#x2F;ç§»é™¤å­ç±»åŒ–ã€‚</p>
<p>ä½†åœ¨ WinForms ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¼å…¥è¿™ä¸¤ä¸ªå‡½æ•°æ¥å­ç±»åŒ–ï¼Œ.NET ä¸ºæˆ‘ä»¬æä¾›äº†ç±»ä¼¼å­ç±»åŒ–çš„åŠŸèƒ½ï¼Œå« NativeWindow ç±»ã€‚å®ƒç»§æ‰¿è‡ª Componentï¼Œæ˜¯å¯¹ Win32 çª—å£çš„ä½çº§å°è£… (åªæä¾› WndProcï¼Œä¸æä¾›æˆ–æä¾›å°‘é‡å…¶ä»–åŠŸèƒ½å°±å«ä½çº§å°è£…)ï¼Œä¹Ÿå°±æ˜¯ä¼ å…¥ å¥æŸ„ ç»™ NativeWindowï¼Œæˆ‘ä»¬ç›¸å½“äºè·å–åˆ°äº†ç›®æ ‡çª—å£çš„å®ä¾‹ï¼Œè€Œè¿™ä¸ªç±»ä¹Ÿæä¾›äº† WndProc è™šæ–¹æ³•ï¼Œå¯ä¾›æˆ‘ä»¬é‡å†™ï¼Œæ¥è¾¾åˆ°å­ç±»åŒ–çš„æ•ˆæœã€‚</p>
<h3 id="è°ƒç”¨çº¦å®š"><a href="#è°ƒç”¨çº¦å®š" class="headerlink" title="è°ƒç”¨çº¦å®š"></a>è°ƒç”¨çº¦å®š</h3><p>è°ƒç”¨çº¦å®š (CallingConvention)ï¼Œå°±æ˜¯è°ƒç”¨æœ¬æœºå‡½æ•°çš„æ–¹å¼ (å¥½æ¯”ä½ ä¸Šç½‘çš„æ–¹å¼ï¼ŒWiFiï¼Œç§»åŠ¨æ•°æ®ç­‰ã€‚ç®€å•çŸ¥é“æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿å°±è¡Œäº†ï¼Œä¸ç”¨çº ç»“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¿æŒçº¦å®šä¸€è‡´å°±è¡Œ)ï¼ŒWinAPI é»˜è®¤å°±æ˜¯ StdCallï¼ŒC# é‡Œ Interop çš„ [DllImport] é»˜è®¤ä¹Ÿæ˜¯ StdCallï¼Œåé¢æˆ‘ä»¬å¯¼å‡ºå‡½æ•°ä¹Ÿè¦å£°æ˜ä¸º StdCallã€‚</p>
<h3 id="å°é€"><a href="#å°é€" class="headerlink" title="å°é€"></a>å°é€</h3><p>å°é€ (Marshaling)ï¼ŒæŒ‡ä»éæ‰˜ç®¡ç¯å¢ƒ (Unmanagedï¼Œå³ Win32) ä¸­å°†å¯¹è±¡è½¬æ¢ä¸ºæ‰˜ç®¡ç¯å¢ƒ (Managedï¼Œå³ C#) å¯¹è±¡çš„è¿‡ç¨‹ï¼Œä»¥åŠåå‘è½¬æ¢çš„è¿‡ç¨‹ã€‚å¸¸è§çš„å°±æ˜¯å°†è¿”å›å€¼ä¸º Win32 BOOL çš„å‡½æ•°è½¬æ¢ä¸º C# boolï¼Œä¸€èˆ¬è¿™ä¹ˆå†™ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">return: MarshalAs(UnmanagedType.Bool)</span>]<br></code></pre></td></tr></table></figure>

<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><h3 id="å®‰è£…-C"><a href="#å®‰è£…-C" class="headerlink" title="å®‰è£… C++"></a>å®‰è£… C++</h3><p>æŸäº› Interopï¼Œæˆ‘ä»¬äº¤ç»™ C++ ä¼šæ›´å¥½ï¼Œç”¨ C# çš„è¯è¿‡äºéº»çƒ¦ç”šè‡³æ— æ³•å®Œæˆã€‚æ‰€ä»¥éœ€è¦ç”¨åˆ° C++ã€‚</p>
<p class="note note-warning">ä¸è¦è§‰å¾—éš¾ä»¥ç»´æŠ¤ä»€ä¹ˆçš„ï¼Œæ¯•ç«Ÿéœ€è¦åŒæ—¶ç¼–å†™ C# å’Œ C++ï¼Œè¦çŸ¥é“ "å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨"ï¼Œè¿™äº›éƒ½æ˜¯å†™å¥½ä¸€ä¸ªè½¯ä»¶çš„å…³é”®ï¼Œæœ‰åŠ©äºå¢å¼ºç”¨æˆ·ä½“éªŒçš„æˆ‘ä»¬æ€ä¹ˆèƒ½ä¸åšå‘¢ï¼ŸVisual Studio é‡Œä¸€ä¸ªè§£å†³æ–¹æ¡ˆå¤šä¸ªé¡¹ç›®çš„ä¹Ÿä¸å°‘è§ï¼Œéš¾é“ä¸æ˜¯å—ï¼Ÿ</p>

<p>é¦–å…ˆå…³é—­ Visual Studioï¼Œæ‰“å¼€ Visual Studio Installerï¼Œç‚¹å‡» ä¿®æ”¹ã€‚åœ¨å¼¹å‡ºçš„é¡µé¢ä¸­å‹¾é€‰ ä½¿ç”¨ C++ çš„æ¡Œé¢å¼€å‘</p>
<p><img src="/../archive-imgs/38/34-vs-inst-cpp.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨å³ä¾§æŒ‰å›¾ç¤ºå‹¾é€‰æˆ–å–æ¶ˆå‹¾é€‰ç›¸åº”çš„ç»„ä»¶ï¼Œä¹‹åç‚¹å‡»å³ä¸‹è§’ä¿®æ”¹ï¼Œå¼€å§‹å®‰è£…</p>
<p><img src="/../archive-imgs/38/35-vs-inst-cpp-select.png" srcset="/img/loading.gif" lazyload></p>
<p>å®‰è£…å®Œæˆåï¼Œæ‰“å¼€ C# é¡¹ç›®ï¼Œå³é”®<strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼Œé€‰æ‹© æ·»åŠ  &gt;æ–°é¡¹ç›®</p>
<p><img src="/../archive-imgs/38/2-create-cpp-dll-pre.png" srcset="/img/loading.gif" lazyload></p>
<p>æ‰¾åˆ° åŠ¨æ€é“¾æ¥åº“ (C++)</p>
<p><img src="/archive-imgs/38/2-create-cpp-dll.png" srcset="/img/loading.gif" lazyload></p>
<p>å‘½åä¸º <code>MyApp.Natives</code> ç„¶ååˆ›å»ºå°±è¡Œäº†ï¼Œè¿™æ ·æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆé‡Œå°±æœ‰ä¸¤ä¸ªé¡¹ç›®äº†ã€‚</p>
<p><img src="/archive-imgs/38/3-cs-cpp-proj.png" srcset="/img/loading.gif" lazyload></p>
<p>æ¥ç€æŠŠ C++ é¡¹ç›®è®¾ç½®ä¸º C# çš„ä¾èµ–é¡¹ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬ç¼–è¯‘ C# æ—¶ï¼Œå…ˆç¼–è¯‘ C++ï¼šå³é”® C# é¡¹ç›®ï¼Œé€‰æ‹© æ„å»ºä¾èµ– &gt;é¡¹ç›®ä¾èµ–<br><img src="/archive-imgs/38/4-assoc-cs-to-cpp.png" srcset="/img/loading.gif" lazyload></p>
<p>æŠŠ C++ é¡¹ç›®å‹¾é€‰ä¸Š<br><img src="/archive-imgs/38/5-assoc-cs-to-cpp-dep.png" srcset="/img/loading.gif" lazyload></p>
<p>å½“ç„¶è¿™ä¹Ÿè¦æ±‚ä¸¤ä¸ªé¡¹ç›®çš„è¾“å‡ºç›®å½•æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘å°±åªè®¾ç½® C++ äº†ï¼Œå› ä¸º C# çš„è®¾ç½®è¿‡äº†ã€‚å³é”® C++ é¡¹ç›®é€‰æ‹©å±æ€§ï¼Œç¬¬ä¸€ä¸ªé¡µé¢å°±æ˜¯<br><img src="/archive-imgs/38/6-set-cpp-out-dir.png" srcset="/img/loading.gif" lazyload></p>
<p>ä¸ºäº†åé¢ç¼–è¯‘ C++ ä¸ä¼šé”™è¯¯ï¼Œæˆ‘ä»¬å…ˆè®¾ç½®é“¾æ¥å™¨ã€‚</p>
<p>å³é”® C++ é¡¹ç›®é€‰æ‹©å±æ€§ &gt;é“¾æ¥å™¨ &gt;è¾“å…¥ &gt;ç¼–è¾‘</p>
<p><img src="/archive-imgs/38/7-cpp-linker.png" srcset="/img/loading.gif" lazyload></p>
<p>å¡«å…¥è¿™ä¸‰ä¸ªé™æ€é“¾æ¥åº“ï¼Œæ³¨æ„ä¸è¦åˆ ä¸Šé¢çš„é‚£ä¸¤ä¸ªï¼Œæœ€åç‚¹å‡»ä¿å­˜</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">uxtheme.lib<br>comctl32.lib<br>ucrt.lib<br></code></pre></td></tr></table></figure>

<p><img src="/archive-imgs/38/8-edit-cpp-linker.png" srcset="/img/loading.gif" lazyload></p>
<p>ç„¶åæ‰¾åˆ°è¿™ä¸ª dllmain.cppï¼Œå³é”®æŠŠå®ƒåˆ é™¤ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦ç”¨äºå¯¼å‡ºå‡½æ•°ä¾› C# è°ƒç”¨ï¼Œä¸éœ€è¦æŒ‡å®šå…¥å£</p>
<p><img src="/../archive-imgs/38/17-del-cppdll-main.png" srcset="/img/loading.gif" lazyload></p>
<p>æ¥ç€æ‰“å¼€ pch.hï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå®å®šä¹‰ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¼å‡ºè°ƒç”¨çº¦å®šä¸º StdCall çš„å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> cexport(type) extern <span class="hljs-string">&quot;C&quot;</span> __declspec(dllexport) type WINAPI</span><br></code></pre></td></tr></table></figure>

<p><img src="/../archive-imgs/38/18-add-cpp-export-macro.png" srcset="/img/loading.gif" lazyload></p>
<p>å¤§æ¦‚å°±å…ˆè¿™æ ·ï¼Œç•™ç€åé¢è¦ç”¨ã€‚</p>
<h3 id="C-ç‰ˆæœ¬"><a href="#C-ç‰ˆæœ¬" class="headerlink" title="C# ç‰ˆæœ¬"></a>C# ç‰ˆæœ¬</h3><p>ç”±äºé¢å‘ .NET Framework 4.8 æˆ–å…¶ä»–ç‰ˆæœ¬ï¼Œä¸”æœ¬æ–‡éƒ¨åˆ†ä»£ç ä½¿ç”¨æ–°ç‰¹æ€§å†™ç€æ¯”è¾ƒèˆ’æœï¼Œå»ºè®®å°† C# ç‰ˆæœ¬å‡çº§åˆ° previewã€‚</p>
<p>VSCode æˆ–è®°äº‹æœ¬æ‰“å¼€é¡¹ç›®æ–‡ä»¶ <code>XXX.csproj</code>ï¼Œæ›´æ”¹ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Project</span> <span class="hljs-attr">ToolsVersion</span>=<span class="hljs-string">&quot;15.0&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Import</span> <span class="hljs-attr">Project</span>=<span class="hljs-string">&quot;$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props&quot;</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;Exists(&#x27;$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props&#x27;)&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>preview<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span> <span class="hljs-comment">&lt;!-- æ–°å»ºä¸€ä¸ª PropertyGroup åŠ å…¥è¿™è¡Œ --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;&#x27;$(Configuration)|$(Platform)&#x27; == &#x27;Debug|x64&#x27;&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>7.3<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span> <span class="hljs-comment">&lt;!-- åˆ é™¤è¿™è¡Œ --&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;&#x27;$(Configuration)|$(Platform)&#x27; == &#x27;Release|x64&#x27;&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>7.3<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span> <span class="hljs-comment">&lt;!-- åˆ é™¤è¿™è¡Œ --&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- ... --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶"><a href="#åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶" class="headerlink" title="åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶"></a>åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶</h3><p>ç”¨äºç¡®ä¿æˆ‘ä»¬å¯ä»¥æ­£ç¡®è·å–åˆ°å½“å‰ç³»ç»Ÿç‰ˆæœ¬ (å¾®è½¯çš„åŠç‰¹æ€§)ï¼Œå¯ä»¥åœ¨ Visual Studio å³é”® C# é¡¹ç›®çš„ Properties æ–‡ä»¶å¤¹ï¼Œç‚¹å‡»æ·»åŠ ï¼Œé€‰æ‹© <code>åº”ç”¨ç¨‹åºæ¸…å• (ä»… Windows)</code>ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">assembly</span> <span class="hljs-attr">manifestVersion</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v1&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">assemblyIdentity</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0.0&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;MyApplication.app&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">compatibility</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:compatibility.v1&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;35138b9a-5d96-4fbd-8e2d-a2440225f93a&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- è¡¨ç¤ºæ”¯æŒ Windows 7 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- è¡¨ç¤ºæ”¯æŒ Windows 8 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;1f676c76-80e1-4239-95bb-83d0f6d0da78&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- è¡¨ç¤ºæ”¯æŒ Windows 8.1 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- è¡¨ç¤ºæ”¯æŒ Windows 10/11 --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">compatibility</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">application</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">windowsSettings</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dpiAware</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/SMI/2005/WindowsSettings&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">dpiAware</span>&gt;</span> <span class="hljs-comment">&lt;!-- ä¸æƒ³æ”¯æŒé«˜ DPI çš„è¯å¯ä»¥åˆ é™¤è¿™æ®µ --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">longPathAware</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/SMI/2016/WindowsSettings&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">longPathAware</span>&gt;</span> <span class="hljs-comment">&lt;!-- è¿™æ˜¯å¯ç”¨ Windows çš„è·¯å¾„è¿‡é•¿æ„ŸçŸ¥ï¼Œä¿æŒé»˜è®¤å³å¯ --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">windowsSettings</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">assembly</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="ä»£ç å¸ƒå±€"><a href="#ä»£ç å¸ƒå±€" class="headerlink" title="ä»£ç å¸ƒå±€"></a>ä»£ç å¸ƒå±€</h3><p>æ¨èå°†æ‰€æœ‰æœ‰å…³ä¸»é¢˜çš„ä»£ç æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„é™æ€ç±»é‡Œï¼Œæ¯”å¦‚ ThemeManagerï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThemeManager</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> CanUseDarkTheme &#123; <span class="hljs-keyword">get</span>; <span class="hljs-comment">/* private set; */</span> &#125; <span class="hljs-comment">// æŒ‡ç¤ºæ˜¯å¦è¦ç”¨æ·±è‰²ä¸»é¢˜</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkFore &#123; <span class="hljs-keyword">get</span>; &#125; = Color.White; <span class="hljs-comment">// æ–‡å­—é¢œè‰²</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkForeLink &#123; <span class="hljs-keyword">get</span>; &#125; = Color.FromArgb(<span class="hljs-number">153</span>, <span class="hljs-number">235</span>, <span class="hljs-number">255</span>); <span class="hljs-comment">// è¶…é“¾æ¥é¢œè‰²</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkBack &#123; <span class="hljs-keyword">get</span>; &#125; = Color.FromArgb(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>); <span class="hljs-comment">// èƒŒæ™¯é¢œè‰²</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkBorder &#123; <span class="hljs-keyword">get</span>; &#125; = Color.FromArgb(<span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>); <span class="hljs-comment">// è¾¹æ¡†é¢œè‰²</span><br><br>    <span class="hljs-comment">// ç³»ç»Ÿæ„å»ºå·ï¼Œç”¨äºç‰ˆæœ¬åˆ¤æ–­</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> OSBuild =&gt; field == <span class="hljs-number">0</span> ? field = Environment.OSVersion.Version.Build : field; <span class="hljs-comment">// è·å–å½“å‰ç³»ç»Ÿç‰ˆæœ¬çš„æ„å»ºå·</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> Windows10_1903 = <span class="hljs-number">18362</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> Windows10_20H1 = <span class="hljs-number">18985</span>;<br><br>    <span class="hljs-comment">// ä¸€äº› WinAPI Interopï¼Œåé¢ä¼šä»‹ç»</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>çª—ä½“&#x2F;æ§ä»¶çš„è¯æœ€å¥½å•ç‹¬ç»§æ‰¿å‡ºæ¥ï¼Œæ–¹ä¾¿å¤ç”¨å„è‡ªçš„ä¸»é¢˜ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFormBase</span> : <span class="hljs-title">Form</span><br>&#123;<br>    <span class="hljs-comment">// ç„¶ä½ åº”ç”¨ç¨‹åºæ‰€æœ‰çª—ä½“ç»§æ‰¿è‡ª MyFormBase</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-comment">/* sealed */</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyButton</span> : <span class="hljs-title">Button</span> <span class="hljs-comment">// å…¶ä»–æ§ä»¶ä¹Ÿæ˜¯ï¼Œå¯é€‰æ˜¯å¦å¯†å° sealed</span><br>&#123;<br>    <span class="hljs-comment">// ä¹‹åç›´æ¥ä½¿ç”¨è‡ªå·±å°è£…çš„ MyButton è€Œä¸æ˜¯ .NET çš„</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h2><p>ä¸‹é¢æˆ‘ä»¬å°±æ­£å¼å¼€å§‹æŒ¨ä¸ªå¯¹æ§ä»¶åº”ç”¨æ·±è‰²ä¸»é¢˜äº†ã€‚</p>
<h3 id="Form"><a href="#Form" class="headerlink" title="Form"></a>Form</h3><p>çª—ä½“çš„æ·±è‰²ä¸»é¢˜éå¸¸ç®€å•ï¼Œåªéœ€è¦è®¾ç½® ForeColorã€BackColor å°±è¡Œäº†ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFormBase</span> : <span class="hljs-title">Form</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyFormBase</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Form1</span> : <span class="hljs-title">MyFormBase</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Form1</span>()</span><br>    &#123;<br>        InitializeComponent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ­¤æ—¶ç¼–è¯‘å¹¶æ‰“å¼€ Form1ï¼Œä½ ä¼šå‘ç°çª—ä½“æ ‡é¢˜æ æ²¡æœ‰å˜é»‘ï¼Œè¿™æ˜¯å› ä¸º Formï¼Œå³çª—å£ï¼Œç”±ç³»ç»Ÿç®¡ç†ï¼Œ.NET ç®¡ä¸åˆ°ï¼Œæ‰€ä»¥è¦å¼•å…¥ WinAPIã€‚</p>
<p>è½¬åˆ° ThemeManagerï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> DWMWA_USE_IMMERSIVE_DARK_MODE_BEFORE_20H1 = <span class="hljs-number">19</span>; <span class="hljs-comment">// â‰¥ 1903 ä¸” â‰¤ 20H1</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> DWMWA_USE_IMMERSIVE_DARK_MODE = <span class="hljs-number">20</span>; <span class="hljs-comment">// 20H1 ä¹‹å</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FlushWindow</span>(<span class="hljs-params">IntPtr hWnd</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (OSBuild &gt;= Windows10_1903)<br>    &#123;<br>        <span class="hljs-keyword">var</span> type = OSBuild &gt;= Windows10_20H1 ? DWMWA_USE_IMMERSIVE_DARK_MODE : DWMWA_USE_IMMERSIVE_DARK_MODE_BEFORE_20H1;<br>        <span class="hljs-keyword">var</span> enable = <span class="hljs-number">1</span>; <span class="hljs-comment">// 1 è¡¨ç¤ºå¯ç”¨ï¼Œ0 ç¦ç”¨</span><br>        DwmSetWindowAttribute(hWnd, type, <span class="hljs-keyword">ref</span> enable, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">int</span>));<br>    &#125;<br>&#125;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;dwmapi.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">DwmSetWindowAttribute</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> dwAttribute, <span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> pvAttribute, <span class="hljs-built_in">int</span> cbAttribute</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>å›åˆ° MyFormBaseï¼Œé‡å†™ OnHandleCreated (è¡¨ç¤ºå½“çª—å£å¥æŸ„ (HWND) åˆ›å»ºæ—¶ï¼Œæ­¤æ—¶å¯ä»¥æ‹¿åˆ° Handle)ï¼Œå¹¶å¯†å°é˜²æ­¢å­ç±»ä¿®æ”¹ (æ ¹æ®å…·ä½“éœ€æ±‚å†³å®š)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFormBase</span> : <span class="hljs-title">Form</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.FlushWindow(Handle);<br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ•ˆæœï¼š</p>
<p><img src="/archive-imgs/38/1-dark-form.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Panel-Label-LinkLabel-PictureBox"><a href="#Panel-Label-LinkLabel-PictureBox" class="headerlink" title="Panel&#x2F;Label&#x2F;LinkLabel&#x2F;PictureBox"></a>Panel&#x2F;Label&#x2F;LinkLabel&#x2F;PictureBox</h3><p>è¿™äº›æ§ä»¶éƒ½èƒ½è·Ÿéš <code>Form</code> çš„å‰èƒŒæ™¯é¢œè‰²ï¼Œåªä¸è¿‡ <code>LinkLabel</code> è¦æ‰‹åŠ¨è®¾ç½® <code>LinkColor</code>ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyLinkLabel</span> : <span class="hljs-title">LinkLabel</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyLinkLabel</span>()</span><br>    &#123;<br>        AutoSize = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            LinkColor = ThemeManager.DarkForeLink;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ•ˆæœï¼š</p>
<p><img src="/archive-imgs/38/9-dark-panel-label-link-picbox.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="GroupBox"><a href="#GroupBox" class="headerlink" title="GroupBox"></a>GroupBox</h3><p>GroupBox çš„è¡¨ç°æœ‰ç‚¹å¥‡æ€ªï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é»˜è®¤æ•ˆæœï¼š</p>
<p><img src="/archive-imgs/38/10-undark-gbox.png" srcset="/img/loading.gif" lazyload></p>
<p>å¯è§æ ‡é¢˜ä¾æ—§æ˜¯é»‘è‰²çš„ï¼Œä½†é‡Œé¢çš„ Label å´æ­£å¸¸ï¼Œè¿™è¯´æ˜ ForeColorã€BackColor åªå¯¹å®ƒçš„å­æ§ä»¶ç”Ÿæ•ˆï¼Œä¸åŒ…æ‹¬æ ‡é¢˜çš„é¢œè‰²ã€‚è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ä¸çŸ¥é“ä½ å‘ç°æ²¡æœ‰ï¼Œè¿™ä¸ªè¾¹æ¡†çš„é¢œè‰²å¤ªç™½äº†ï¼Œä½¿å¾—æ•´ä¸ªæ§ä»¶æ˜¾å¾—æœ‰ç‚¹å¤å¤ï¼Œä½†è¾¹æ¡†é¢œè‰²ä¹Ÿä¸èƒ½æ›´æ”¹ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>è¿™ç§æƒ…å†µä¸‹å°±è¦è¯·å‡ºæˆ‘ä»¬ä¸‡èƒ½çš„ è‡ªç»˜ äº†ï¼Œå…¨ç§° è‡ªå®šä¹‰ç»˜åˆ¶ (Owner Draw)ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨ GDI&#x2F;GDI+ è‡ªå·±ç”»æ§ä»¶çš„æ ·å¼ï¼Œè™½ç„¶å¬ç€éº»çƒ¦ï¼Œä½†å®é™…ä¹Ÿèƒ½æ¥å—ã€‚ä¹Ÿä¸ç”¨æ‹…å¿ƒä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºæ§ä»¶æœ¬æ¥ä¹Ÿæ˜¯è¿™ä¹ˆç”»å‡ºæ¥çš„ï¼Œåªä¸è¿‡éƒ½æ˜¯ç³»ç»Ÿé¢„è®¾è€Œå·²ï¼Œæˆ‘ä»¬è‡ªå·±ç”»è¯´ä¸å®šæ¯”ç³»ç»Ÿè¿˜é«˜æ•ˆã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª MyGroupBox ç»§æ‰¿è‡ª GroupBox</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyGroupBox</span> : <span class="hljs-title">GroupBox</span><br>&#123;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç„¶åé‡å†™ OnPaint æ–¹æ³•ï¼Œè¿™é‡Œå‚è€ƒäº† <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=_7NwVqfNU1g">@mikecodz2821</a> çš„ä»£ç ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnPaint</span>(<span class="hljs-params">PaintEventArgs e</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>    &#123;<br>        <span class="hljs-keyword">var</span> g = e.Graphics; <span class="hljs-comment">// è·å– Graphicsï¼Œç”¨æ¥ç”»ç”»</span><br>        <span class="hljs-keyword">var</span> client = ClientSize; <span class="hljs-comment">// è·å– GroupBox çš„å®¢æˆ·åŒºå¤§å°</span><br>        <span class="hljs-keyword">var</span> text = Text; <span class="hljs-comment">// è·å–æ ‡é¢˜</span><br>        <span class="hljs-keyword">var</span> font = Font; <span class="hljs-comment">// è·å–å­—ä½“</span><br>        <span class="hljs-keyword">var</span> textHeight = font.Height / <span class="hljs-number">2</span> + <span class="hljs-number">2</span>; <span class="hljs-comment">// è·å–æ ‡é¢˜çš„é«˜åº¦ï¼Œå³å­—ä½“çš„é«˜åº¦ï¼Œ/2 +2 æ˜¯è®©æ–‡å­—åœ¨ä¸­å¿ƒçº¿ä¸Šå†å‘ä¸Šåç§» 2pxï¼Œ</span><br>                                              <span class="hljs-comment">// å› ä¸º GroupBox çš„æ–‡å­—å’Œè¾¹æ¡†ä¸Šè¾¹ç¼˜æœ¬æ¥å°±æœ‰åç§»ï¼Œæ²¡åœ¨ç«–ç›´ä¸­å¿ƒ</span><br>        <span class="hljs-keyword">var</span> rect = <span class="hljs-keyword">new</span> Rectangle(<span class="hljs-number">0</span>, textHeight, client.Width, client.Height - textHeight); <span class="hljs-comment">// è¡¨ç¤º GroupBox çš„è¾¹æ¡†ä½ç½®å’Œå¤§å°</span><br>        <span class="hljs-keyword">var</span> textRect = Rectangle.Inflate(ClientRectangle, <span class="hljs-number">-4</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// è®©æ ‡é¢˜å‘å³åç§»ä¸€ç‚¹ï¼Œä¸ç„¶å¤ªé å‰äº†</span><br><br>        ControlPaint.DrawBorder(g, rect, ThemeManager.DarkBorder, ButtonBorderStyle.Solid); <span class="hljs-comment">// GDI+ ç”»è¾¹æ¡†ï¼Œé¢œè‰²ç”¨æˆ‘ä»¬å®šä¹‰çš„ï¼Œçœ‹èµ·æ¥æ˜¯æ·±ç°è‰²</span><br>        TextRenderer.DrawText(g, text, font, textRect, ForeColor, BackColor, TextFormatFlags.Top | TextFormatFlags.Left | TextFormatFlags.LeftAndRightPadding | TextFormatFlags.EndEllipsis); <span class="hljs-comment">// GDI ç”»æ–‡å­—ï¼Œå¹¶ä½¿ç”¨è®¾ç½®çš„ ForeColor, BackColor</span><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.OnPaint(e); <span class="hljs-comment">// ä¸æ˜¯æ·±è‰²æ¨¡å¼å°±äº¤ç»™ç³»ç»Ÿæ¥ç”»</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/archive-imgs/38/11-dark-gbox.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="ContextMenu"><a href="#ContextMenu" class="headerlink" title="ContextMenu"></a>ContextMenu</h3><p>ä¸åŒäº ContextMenuStripï¼ŒContextMenu æ˜¯ WinForms å¯¹ Win32 åŸç”Ÿå¿«æ·èœå•çš„ä½çº§å°è£… (ç»§æ‰¿è‡ª Component)ï¼Œå¤–è§‚ä¹Ÿæ¯” Strip å¥½çœ‹å¾ˆå¤šã€‚æœ¬æ–‡åªå¯¹ ContextMenu çš„æ·±è‰²ä¸»é¢˜è¿›è¡Œè®¨è®ºï¼ŒåŒæ—¶å¦‚æœä½ å¯¹å³é”®èœå•æ²¡æœ‰æ”¾ç½®ç‰¹æ®Šæ§ä»¶çš„éœ€æ±‚çš„è¯ï¼Œä¹Ÿå»ºè®®è¿ç§»åˆ° ContextMenuã€‚</p>
<p>æœ‰å…³å¦‚ä½•åˆ›å»º ContextMenuï¼Œå¯ä»¥çœ‹çœ‹<a href="https://wanghaonie.github.io/posts/95b4fdac793d/">è¿™ç¯‡</a>æ–‡ç« ã€‚</p>
<p>ContextMenu çš„æ·±è‰²ä¸»é¢˜å¯ä»¥ç”¨ç³»ç»Ÿæä¾›çš„ APIï¼Œè¿™æ˜¯ä¸€ä¸ªæœªå…¬å¼€çš„ APIï¼Œä¸æ’é™¤å¾®è½¯æœ‰å¯èƒ½åœ¨æœªæ¥ä¿®æ”¹&#x2F;åˆ é™¤å®ƒçš„å¯èƒ½ï¼Œä½†ç°é˜¶æ®µæ²¡æœ‰é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å°±æ‚„æ‚„çš„ç”¨ã€‚è°ƒç”¨ä¹‹åæ•´ä¸ªåº”ç”¨ç¨‹åºèŒƒå›´å†…çš„ ContextMenu å…¨éƒ¨éƒ½æœ‰æ·±è‰²ä¸»é¢˜äº†ã€‚</p>
<p>è½¬åˆ° ThemeManagerï¼Œæ·»åŠ ä»¥ä¸‹ WinAPI ä»¥åŠæšä¸¾ã€‚ç”±äºè¿™ä¸ªå‡½æ•°æ²¡æœ‰å…¬å¼€ï¼Œä¸”é€šè¿‡ä¸€äº›æ‰‹æ®µå‘ç°å®ƒåœ¨ uxtheme.dll ä¸­å¯¼å‡ºçš„åºå·ä¸º 135ï¼Œæ•…éœ€è¦æ˜¾å¼æŒ‡å®š EntryPointï¼Œç”¨ # è¡¨ç¤ºè®© CLR (.NET è¿è¡Œæ—¶) å°† 135 å½“ä½œåºå·å»è°ƒç”¨å‡½æ•°è€Œä¸æ˜¯åç§°ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThemeManager</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br><br>    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;uxtheme.dll&quot;</span>, EntryPoint = <span class="hljs-string">&quot;#135&quot;</span>)</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetPreferredAppMode</span>(<span class="hljs-params">PreferredAppMode preferredAppMode</span>)</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> PreferredAppMode <span class="hljs-comment">// æˆ‘ä»¬ä¸€èˆ¬æŠŠæšä¸¾å†™åœ¨ç±»çš„å¤–é¢ï¼Œé¿å…åµŒå¥—ï¼Œä¸ç„¶åœ¨è®¿é—®çš„æ—¶å€™è¿˜è¦åŠ ç±»å</span><br>&#123;<br>    Default,<br>    AllowDark,<br>    ForceDark, <span class="hljs-comment">// ä¸€èˆ¬ç”¨è¿™ä¸ªæšä¸¾ï¼Œè¡¨ç¤ºå¼ºåˆ¶å°†åº”ç”¨ç¨‹åºä¸»é¢˜è®¾ç½®ä¸ºæ·±è‰²ï¼Œå€¼ä¸º 2</span><br>    ForceLight,<br>    Max<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è½¬åˆ°ç¨‹åºçš„å…¥å£ (Program.cs)ï¼Œåœ¨ Main æ–¹æ³•ä¸­çš„ Application ç³»åˆ—æ–¹æ³•ä¹‹å‰è°ƒç”¨å®ƒã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><br>&#123;<br>    [<span class="hljs-meta">STAThread</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.SetPreferredAppMode(PreferredAppMode.ForceDark);<br>        &#125;<br><br>        Application.EnableVisualStyles();<br>        Application.SetCompatibleTextRenderingDefault(<span class="hljs-literal">false</span>);<br>        Application.Run(<span class="hljs-keyword">new</span> Form1());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å³é”®çª—ä½“æ ‡é¢˜æ å°±èƒ½çœ‹åˆ°äº†ï¼Œè¿™æ˜¯æœ€ç»ˆæ•ˆæœï¼š</p>
<p><img src="/archive-imgs/38/12-dark-contextmenu.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h3><p>æŒ‰é’®çš„æ·±è‰²ä¸»é¢˜çš„åº”ç”¨å°±ç®€å•å¾ˆå¤šäº†ï¼Œåªéœ€åœ¨ ThemeManager é‡Œæ·»åŠ ä»¥ä¸‹ WinAPI</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;uxtheme.dll&quot;</span>, CharSet = CharSet.Unicode)</span>] <span class="hljs-comment">// Unicode è¡¨ç¤ºä¼ å…¥çš„å­—ç¬¦ä¸²éƒ½è¢«å½“ä½œ å®½å­—ç¬¦ å¤„ç†</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetWindowTheme</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">string</span> pszSubAppName, <span class="hljs-built_in">string</span> pszSubIdList</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>ç„¶ååˆ›å»º MyButton ç»§æ‰¿è‡ª Buttonï¼Œé‡å†™ OnHandleCreated</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PlainButton</span> : <span class="hljs-title">Button</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PlainButton</span>(<span class="hljs-params">ContextMenu menu</span>)</span><br>    &#123;<br>        FlatStyle = FlatStyle.System; <span class="hljs-comment">// è®©æŒ‰é’®ä½¿ç”¨ç³»ç»Ÿæ ·å¼</span><br>        UseVisualStyleBackColor = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€œDarkMode_Explorerâ€ æ˜¯ç³»ç»Ÿå†…ç½®çš„ (ä½äº aero.msstyles æ–‡ä»¶) åŒ…å«æ·±è‰² Button çš„ä¸»é¢˜çš„åç§°ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‰ç†æ¥è¯´åº”è¯¥ä¼ å…¥ â€œButtonâ€ï¼Œä½†ä¼ å…¥ null ä¼šè®© API è‡ªå·±å»åˆ¤æ–­ç”¨å“ªä¸ªï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç›´æ¥ä¼  nullã€‚</p>
<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/13-dark-button.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="RadioButton-CheckBox"><a href="#RadioButton-CheckBox" class="headerlink" title="RadioButton&#x2F;CheckBox"></a>RadioButton&#x2F;CheckBox</h3><p>è¿™ä¸¤ä¸ªæ§ä»¶å…¶å®ä¹Ÿå’Œ Button å·®ä¸å¤šï¼Œä½†åœ¨ç¦ç”¨çŠ¶æ€æ—¶ï¼Œæ–‡å­—ä¼šçœ‹ä¸æ¸…ï¼Œå¯èƒ½æ˜¯ WinForms å°è£…æ—¶æŸäº›ä»£ç å¹²æ‰°äº†ä¸»é¢˜è¿ä½œï¼Œæ‰€ä»¥å°±å•ç‹¬æå‡ºæ¥äº†ã€‚</p>
<p>ç”±äºè¿™ä¸¤ä¸ªæ§ä»¶åœ¨ WinForms&#x2F;Win32 ä¸­éƒ½ç»§æ‰¿è‡ª ButtonBase&#x2F;Buttonï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè¾…åŠ©ç±»æ¥ä¾§è½½ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyButtonBase</span> <span class="hljs-comment">// æ³¨æ„ï¼Œä¸ç”¨æ˜¾å¼ç»§æ‰¿è‡ªä»»ä½•åŸºç±»</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ButtonBase Target;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyButtonBase</span>(<span class="hljs-params">ButtonBase target</span>)</span><br>    &#123;<br>        target.UseVisualStyleBackColor = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            Target = target;<br>            Target.EnabledChanged += Button_EnabledChanged; <span class="hljs-comment">// ç»‘å®šå¯ç”¨çŠ¶æ€æ›´æ”¹äº‹ä»¶</span><br>            UpdateStyle();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Button_EnabledChanged</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs e</span>)</span><br>    &#123;<br>        UpdateStyle();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateStyle</span>()</span><br>    &#123;<br>        Target.FlatStyle = Target.Enabled ? FlatStyle.Standard : FlatStyle.System;<br>        ThemeManager.SetWindowTheme(Target.Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// æ ¹æ®å¤šæ¬¡è¯•éªŒï¼Œæˆ‘å‘ç°å½“å¯ç”¨æ—¶ä½¿ç”¨ Standard ä¸»é¢˜ï¼Œç¦ç”¨æ—¶ç”¨ System ä¸»é¢˜å¯ä»¥æœ‰æ•ˆè§£å†³æ–‡å­—çœ‹ä¸æ¸…çš„é—®é¢˜</span><br>        <span class="hljs-comment">// è®°å¾—è¦å†æ¬¡è°ƒç”¨ API åˆ·æ–°ä¸»é¢˜ã€‚</span><br>    &#125;<br><br>    ~MyButtonBase()<br>    &#123;<br>        <span class="hljs-keyword">if</span> (Target != <span class="hljs-literal">null</span>)<br>        &#123;<br>            Target.EnabledChanged -= Button_EnabledChanged; <span class="hljs-comment">// ææ„å‡½æ•°è§£ç»‘äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŒæ ·æˆ‘ä»¬ä¹Ÿéœ€è¦åˆ›å»º MyRadioButton å’Œ MyCheckBoxï¼Œç„¶ååœ¨æ„é€ å‡½æ•°ä¸­ç›´æ¥åˆ›å»ºè¾…åŠ©ç±»å®ä¾‹å°±å®Œæˆäº†</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyRadioButton</span> : <span class="hljs-title">RadioButton</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyRadioButton</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> MyButtonBase(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyCheckBox</span> : <span class="hljs-title">CheckBox</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyCheckBox</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> MyButtonBase(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/14-dark-rb-cb.png" srcset="/img/loading.gif" lazyload></p>
<p>ä½ ä¼šå‘ç°åœ¨ç¦ç”¨çŠ¶æ€ä¸‹ï¼Œæ–‡å­—ä¼šæ›´åå‘å·¦ä¾§ï¼Œä½†è¿™åœ¨ Win32 ä¸­æ˜¯æ²¡æœ‰çš„ï¼ŒWinForms çš„è¯ä¹Ÿåªèƒ½æš‚æ—¶è¿™æ ·äº†ã€‚</p>
<h3 id="TextBox-ComboBox"><a href="#TextBox-ComboBox" class="headerlink" title="TextBox&#x2F;ComboBox"></a>TextBox&#x2F;ComboBox</h3><p>è¿™ä¸¤ç©æ„å„¿ä¹Ÿæ¯”è¾ƒå¥½æï¼Œä¸è¿‡é™¤äº†éœ€è¦è°ƒç”¨ APIï¼Œè¿˜éœ€è¦è®¾ç½® ForeColorã€BackColorã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyComboBox</span> : <span class="hljs-title">ComboBox</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyComboBox</span>()</span><br>    &#123;<br>        DropDownStyle = ComboBoxStyle.DropDownList; <span class="hljs-comment">// è¡¨ç¤º ComboBox åº”å…·æœ‰ä¸‹æ‹‰èœå•</span><br>        FlatStyle = FlatStyle.System;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_CFD&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyTextBox</span> : <span class="hljs-title">TextBox</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_CFD&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„åŒ…å«å®ƒä»¬ä¸¤ä¸ªçš„æ·±è‰²ä¸»é¢˜çš„åç§°æ˜¯ â€œDarkMode_CFDâ€ã€‚</p>
<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/15-dark-textbox-combobox.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="TreeView-TabControl"><a href="#TreeView-TabControl" class="headerlink" title="TreeView&#x2F;TabControl"></a>TreeView&#x2F;TabControl</h3><p>å¯èƒ½å¤§å®¶å¾ˆå°‘ç”¨è¿™ä¸ªæ§ä»¶ï¼Œè¿™é‡Œæå‡ºæ¥ä¹Ÿæ˜¯åˆ©ç”¨å®ƒä½œä¸ºå‚ç›´å¯¼èˆªæ æ¥ä»£æ›¿ TabControlï¼Œå› ä¸º TabControl çš„æ·±è‰²ä¸»é¢˜ä¸å¥½æï¼Œè¯¦è§ <a href="https://wanghaonie.github.io/posts/818a54b277f2/">æ‘†è„± TabControlï¼Œæ•™ä½ æ‰“é€ é«˜é¢œå€¼åŸç”Ÿæ ·å¼çš„å‚ç›´å¯¼èˆªæ </a>ã€‚</p>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ï¼Œé¦–å…ˆæ¥åˆ›å»º MyTreeView</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyTreeView</span> : <span class="hljs-title">TreeView</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/16-dark-treeview.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="NumericUpDown"><a href="#NumericUpDown" class="headerlink" title="NumericUpDown"></a>NumericUpDown</h3><p>NumericUpDown æ˜¯æœ¬æ–‡ä¸­é‡åˆ°çš„ç¬¬ä¸€ä¸ªå¤åˆæ§ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒç”±ä¸¤ä¸ªæ§ä»¶ç»„æˆï¼šUpDownEdit å’Œ UpDownButtonsï¼Œå½“ç„¶è¿™ä¸¤ä¸ªç±»å‹æ˜¯ä¸“æœ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åœ¨å…¬å¼€ç±»å‹é‡Œæ‰¾åˆ°ã€‚</p>
<p><img src="/../archive-imgs/38/19-nud-components.png" srcset="/img/loading.gif" lazyload></p>
<p>ä½†è¿™å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¸èƒ½é€šè¿‡ä»£ç è·å¾—å®ƒä»¬çš„å®ä¾‹ï¼Œå½“ç„¶ä¹Ÿä¸éœ€è¦åå°„ã€‚æƒ³æƒ³ï¼Œå¦‚æœæ˜¯ä½ ï¼Œè¦å°†å¤šä¸ªæ§ä»¶æ”¾åœ¨ä¸€ä¸ªå®¹å™¨é‡Œé¢ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ</p>
<p>æ˜¯ä¸æ˜¯å¾€ Controls é›†åˆé‡Œå¡å°±å¯¹äº†ï¼Ÿæ‰€ä»¥æˆ‘ä»¬ç›´æ¥éå† NumericUpDown çš„ Controls é›†åˆå°±èƒ½çœ‹åˆ°å®ƒä¿©äº†ã€‚</p>
<p>é¦–å…ˆè€è§„çŸ©ï¼Œåˆ›å»º MyNumericUpDownï¼Œè®¾ç½®å¿…è¦å±æ€§ï¼Œé‡å†™ OnHandleCreatedï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyNumericUpDown</span> : <span class="hljs-title">NumericUpDown</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyNumericUpDown</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>        &#125;<br><br>        TextAlign = HorizontalAlignment.Right;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆè¯•ç€åœ¨ OnHandleCreated é‡Œéå†ä¸€ä¸‹ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ”¶è·ã€‚é¡ºä¾¿åœ¨ foreach è¿™é‡Œæ‰“ä¸ªæ–­ç‚¹</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>&#123;<br>    <span class="hljs-keyword">foreach</span> (Control control <span class="hljs-keyword">in</span> Controls) <span class="hljs-comment">// &lt;- æ–­ç‚¹</span><br>    &#123;<br>        <br>    &#125;<br><br>    <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœ</p>
<p><img src="/../archive-imgs/38/20-nud-components-vsbpoint.png" srcset="/img/loading.gif" lazyload></p>
<p>å¯è§ç¡®å®ç”±ä¸¤ä¸ªæ§ä»¶ç»„æˆï¼Œåˆ†åˆ«æ˜¯ UpDownButtons å’Œ UpDownEditã€‚</p>
<p>é‚£æˆ‘ä»¬å°±ç›´æ¥åº”ç”¨ä¸»é¢˜ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">foreach</span> (Control control <span class="hljs-keyword">in</span> Controls) <span class="hljs-comment">// &lt;- æ–­ç‚¹</span><br>&#123;<br>    ThemeManager.SetWindowTheme(control.Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶å® DarkMode_CFD ä¹Ÿå¯ä»¥ï¼Œä½†åªå¯¹ UpDownEdit ç”Ÿæ•ˆï¼Œä½¿ç”¨ DarkMode_Explorer çš„è¯ä¸¤è€…éƒ½å¯ä»¥è¢«åº”ç”¨æ·±è‰²ä¸»é¢˜ã€‚</p>
<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/21-dark-nud.png" srcset="/img/loading.gif" lazyload></p>
<p>æ³¨æ„ï¼ŒWindows 11 ä¹‹å‰çš„ç³»ç»Ÿï¼ŒUpDownButtons æ²¡æœ‰æ·±è‰²ä¸»é¢˜æ˜¯æ­£å¸¸ç°è±¡ã€‚</p>
<h3 id="ListView"><a href="#ListView" class="headerlink" title="ListView"></a>ListView</h3><p>ListView å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯å¤åˆæ§ä»¶ï¼Œæ ‡é¢˜æ å°±æ˜¯ä¸€ä¸ªæ§ä»¶ (SysHeader32)ï¼Œåˆ—è¡¨å°±æ˜¯ ListView æœ¬èº«ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€åŠæ³•æ¥çœ‹çœ‹ Controls é›†åˆã€‚</p>
<p>å…ˆåˆ›å»º MyListViewï¼Œè®¾ç½®å¿…è¦å±æ€§</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyListView</span> : <span class="hljs-title">ListView</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyListView</span>()</span><br>    &#123;<br>        View = View.Details; <span class="hljs-comment">// åˆ—è¡¨è¯¦ç»†è§†å›¾</span><br>        FullRowSelect = <span class="hljs-literal">true</span>; <span class="hljs-comment">// æ•´è¡Œé€‰æ‹©</span><br>        HideSelection = <span class="hljs-literal">false</span>; <span class="hljs-comment">// å¤±å»ç„¦ç‚¹ä¸éšè—é€‰ä¸­é¡¹</span><br>        ShowItemToolTips = <span class="hljs-literal">true</span>; <span class="hljs-comment">// å†…å®¹è¶…å‡ºèŒƒå›´æ˜¾ç¤º ToolTip</span><br>        BorderStyle = BorderStyle.None; <span class="hljs-comment">// ä¸æ˜¾ç¤ºç™½è‰²è¾¹æ¡†ï¼Œè¿™ä¸ªçœ‹å…·ä½“éœ€æ±‚</span><br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>        &#125;<br><br>        SetStyle(ControlStyles.AllPaintingInWmPaint | ControlStyles.OptimizedDoubleBuffer, <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// å¼€å¯åŒç¼“å†²ï¼Œé˜²æ­¢é—ªçƒä¸å¡é¡¿</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> b = Controls; <span class="hljs-comment">// &lt;- æ‰“æ–­ç‚¹</span><br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ ListView çš„ä¸»é¢˜åç§°åº”è¯¥æ˜¯ DarkMode_ItemsViewã€‚</p>
<p>çœ‹çœ‹ Controls é›†åˆï¼š</p>
<p><img src="/../archive-imgs/38/22-listview-controls.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™ä¸å¤©å¡Œäº†ï¼ŸControls é‡Œå•¥ä¹Ÿæ²¡æœ‰ï¼Œæ ‡é¢˜æ æ ¹æœ¬å°±æ²¡åœ¨ Controls é‡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸ºæ ‡é¢˜æ æ˜¯ ListView åº•å±‚åŠ¨æ€åˆ›å»ºçš„æ§ä»¶ï¼ŒWinForms æ ¹æœ¬æ²¡æœ‰å°è£…ï¼Œè‡ªç„¶å°±çœ‹ä¸åˆ°äº†ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆçœ‹åˆ°ï¼Ÿ</p>
<p>è¿˜è®°å¾—æˆ‘ä»¬å®‰è£…çš„ C++ å—ï¼Œå®ƒä¼šè‡ªå¸¦ Spy++ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªå·¥å…·æ¢æµ‹ä¸€ä¸‹ï¼Œåœ¨ Visual Studio å·¥å…·æ ï¼šå·¥å…· &gt;Spy++</p>
<p><img src="/../archive-imgs/38/23-listviewheader-spyxx.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™ä¸ï¼Œå®ƒåœ¨è¿™å‘¢ã€‚åŒæ—¶ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ ‡é¢˜æ æ ¹æœ¬æ²¡æœ‰è¢«åº”ç”¨ä¸»é¢˜ã€‚</p>
<p>æ˜¾ç„¶ï¼Œå¦‚æœèƒ½è·å–åˆ°æ ‡é¢˜æ çš„å¥æŸ„çš„è¯ï¼Œä¸€åˆ‡éƒ½å¥½åŠäº†ã€‚ä½ å¯èƒ½ä¼šæƒ³åˆ°ç”¨ EnumChildWindows å‡½æ•°æšä¸¾å­çª—å£ï¼Œåªèƒ½è¯´æœ‰æ€è·¯äº†ï¼Œä½†ä¸å¤Ÿã€‚</p>
<p>å¦‚æœä½ åœ¨æœç´¢å¼•æ“é‡Œæœç´¢ listview get headerï¼Œä½ ä¼šå‘ç°ï¼š</p>
<p><img src="/../archive-imgs/38/24-google-lvh.png" srcset="/img/loading.gif" lazyload></p>
<p>å¥½å®¶ä¼™ï¼Œå±…ç„¶æœ‰ä¸€ä¸ªè·Ÿå…³é”®è¯ä¸€æ¨¡ä¸€æ ·çš„å‡½æ•° (å…¶å®æ˜¯å®)ï¼Œè¿™ä¹Ÿå¤ªæ£’äº†ã€‚<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/commctrl/nf-commctrl-listview_getheader">ç‚¹</a>è¿›å»çœ‹çœ‹ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">è¿”å›å€¼<br>ç±»å‹ï¼šHWND<br><br>è¿”å›æ ‡å¤´æ§ä»¶çš„å¥æŸ„ã€‚<br></code></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™è¡Œæè¿°æ²¡æœ‰ï¼Ÿâ€”â€” è¿”å›æ ‡å¤´æ§ä»¶çš„å¥æŸ„ã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªå®æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯ç”¨ SendMessage ç»™ ListView å‘äº†ä¸€ä¸ª LVM_GETHEADER æ¶ˆæ¯ï¼Œç„¶åè¯¥å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯æ ‡é¢˜æ çš„å¥æŸ„ã€‚</p>
<p>å¯èƒ½è¿™å¯¹åˆšæ¥è§¦æ¶ˆæ¯å¾ªç¯çš„æœ‹å‹æ¯”è¾ƒéš¾æ‡‚ï¼Œé‚£æˆ‘ä»¬æ¥ä»¿ç”Ÿä¸€ä¸‹ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">(ä½ è°ƒç”¨äº† SendMessage ...)<br><br>SendMessage: @ListViewï¼Œäº¤å‡ºä½ æ ‡é¢˜æ çš„å¥æŸ„ã€‚<br>(SendMessage å‘ ListView çš„ HWND å‘é€äº† LVM_GETHEADER æ¶ˆæ¯ ...)<br><br>ListView: æ”¶åˆ°ï¼Œå“¥ä»¬å„¿ï¼<br>(ListView å†…éƒ¨è·å–æ ‡é¢˜æ çš„ HWND å¹¶ä¼ ç»™äº† SendMessage ...)<br><br>(ä½ æ‹¿åˆ°äº† SendMessage çš„è¿”å›å€¼ï¼Œå®ƒå°±æ˜¯æ ‡é¢˜æ çš„ HWND)<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°æ“ä½œåœ¨ WinAPI é‡Œå¾ˆå¸¸è§ï¼Œéœ€è¦æ–°æ‰‹æœ‹å‹ä»¬åŠ æ·±ç†è§£ï¼Œä»¥åŠé€‚åº”è¿™ç§æœºåˆ¶ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥è½¬åˆ° C++ äº†ï¼Œå› ä¸º ListView æ·±è‰²ä¸»é¢˜æœ¬æ¥å°±å¾ˆå¤æ‚ã€‚</p>
<p>å³é”®æˆ‘ä»¬çš„ Natives é¡¹ç›®ï¼Œé€‰æ‹©æ·»åŠ  &gt;æ–°é¡¹<br><img src="/../archive-imgs/38/25-cpp-new-item.png" srcset="/img/loading.gif" lazyload></p>
<p>é€‰æ‹©å¤´æ–‡ä»¶ (*.h)ï¼Œå‘½åä¸º ListViewHelper<br><img src="/../archive-imgs/38/26-cpp-new-h.png" srcset="/img/loading.gif" lazyload></p>
<p>å¤´æ–‡ä»¶ç¬¬ä¸€è¡Œé»˜è®¤å°±æ˜¯ <code>#pragma once</code>ï¼Œå®ƒæ˜¯ç”¨äºé˜²æ­¢å¤šæ¬¡å¼•ç”¨çš„ï¼Œä¸è¦åˆ é™¤</p>
<p>åŒæ ·æ–¹å¼æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæºæ–‡ä»¶ (*.cpp)ï¼Œä¹Ÿå‘½åä¸º ListViewHelperï¼Œå¹¶åŠ ä¸Šé¢„ç¼–è¯‘å¤´ (Visual Studio è§„å®šçš„) å’Œæˆ‘ä»¬çš„ ListViewHelper.h</p>
<p><img src="/../archive-imgs/38/27-created-h-cpp.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;pch.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ListViewHelper.h&quot;</span></span><br></code></pre></td></tr></table></figure>
<p><img src="/../archive-imgs/38/28-cpp-add-include.png" srcset="/img/loading.gif" lazyload></p>
<p>è½¬åˆ°å¤´æ–‡ä»¶ï¼Œæ·»åŠ å¼•ç”¨ï¼Œä»¥åŠå£°æ˜å¯¼å‡ºå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Uxtheme.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;CommCtrl.h&gt;</span></span><br><br><span class="hljs-built_in">cexport</span>(<span class="hljs-type">void</span>) <span class="hljs-built_in">SetListViewTheme</span>(HWND hListView);<br></code></pre></td></tr></table></figure>
<p>å‚æ•° hListView çš„å‘½åæ–¹å¼è¡¨ç¤º Handle of ListViewï¼Œè·Ÿ hWnd (Handle of Window) ä¿æŒä¸€è‡´çš„æ ¼å¼å³å¯ï¼Œæœ‰åŠ©äºæé«˜å¯è¯»æ€§</p>
<p>è½¬åˆ°æºæ–‡ä»¶ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetListViewTheme</span><span class="hljs-params">(HWND hListView)</span> <span class="hljs-comment">// ä¿æŒç­¾åä¸å¤´æ–‡ä»¶å£°æ˜çš„ä¸€è‡´</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">SetWindowTheme</span>(hListView, <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// åº”ç”¨åˆ° ListView è‡ªå·±</span><br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetHeader</span>(hListView), <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// åº”ç”¨åˆ°æ ‡é¢˜æ </span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯¹äº Win32 æ–°æ‰‹æœ‹å‹ä»¬ï¼Œè¯·æ³¨æ„ï¼š</p>
<ul>
<li>C# çš„ null åœ¨ C++ é‡Œå¯¹åº” nullptr</li>
<li>C# çš„ string <strong>åœ¨è¿™é‡Œ</strong>å¯¹åº” C++ çš„ LPCWSTR (åº•å±‚ç±»å‹ <code>const w_char*</code>ï¼Œå®½å­—ç¬¦ï¼ŒUnicode)ï¼Œä¹¦å†™æ—¶éœ€è¦åœ¨ <code>&quot;&quot;</code> å·¦ä¾§åŠ ä¸Š <code>L</code>ï¼š<code>L&quot;&quot;</code></li>
</ul>
<p>è½¬åˆ° C# é¡¹ç›®ï¼Œåœ¨ ThemeManager é‡Œï¼Œå£°æ˜å¯¼å…¥å‡½æ•°ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;Natives.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetListViewTheme</span>(<span class="hljs-params">IntPtr hListView</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>è½¬åˆ° MyListViewï¼Œåˆ é™¤ä¹‹å‰çš„ï¼Œç›´æ¥æ›´æ”¹ä¸ºï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>    &#123;<br>        ThemeManager.SetListViewTheme(Handle);<br>    &#125;<br><br>    <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœ</p>
<p><img src="/../archive-imgs/38/29-half-dark-listview.png" srcset="/img/loading.gif" lazyload></p>
<p>æœ‰ç‚¹å°´å°¬ï¼Œä½ å°±è¯´æœ‰æ²¡æœ‰ä¸»é¢˜å§ï¼Œåªæ˜¯æ–‡å­—æ²¡æœ‰é€‚åº”ç½¢äº†ã€‚</p>
<p>é‚£æˆ‘ä»¬è¿˜å¾—ç»§ç»­ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿç›´æ¥åæ‰‹å°±æ˜¯ä¸ªå­ç±»åŒ–ï¼Œè¿™é‡Œå‚è€ƒäº† <a target="_blank" rel="noopener" href="https://github.com/ysc3839/win32-darkmode/blob/master/win32-darkmode/ListViewUtil.h">ysc3839&#x2F;win32-darkmode</a> çš„ä»£ç ã€‚</p>
<p>è½¬åˆ° ListViewHelper.cppï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•°è¡¨ç¤ºå­ç±»åŒ–è¿‡ç¨‹ï¼Œè¦å†™åœ¨ SetListViewTheme å‰é¢</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> LRESULT CALLBACK <span class="hljs-title">ListViewSubclass</span><span class="hljs-params">(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam, UINT_PTR uIdSubclass, DWORD_PTR)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (uMsg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_NOTIFY:<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">reinterpret_cast</span>&lt;LPNMHDR&gt;(lParam)-&gt;code == NM_CUSTOMDRAW)<br>            &#123;<br>                LPNMCUSTOMDRAW nmcd = <span class="hljs-built_in">reinterpret_cast</span>&lt;LPNMCUSTOMDRAW&gt;(lParam);<br><br>                <span class="hljs-keyword">switch</span> (nmcd-&gt;dwDrawStage)<br>                &#123;<br>                    <span class="hljs-keyword">case</span> CDDS_PREPAINT:<br>                        <span class="hljs-keyword">return</span> CDRF_NOTIFYITEMDRAW;<br>                    <span class="hljs-keyword">case</span> CDDS_ITEMPREPAINT:<br>                        <span class="hljs-built_in">SetTextColor</span>(nmcd-&gt;hdc, <span class="hljs-built_in">RGB</span>(<span class="hljs-number">222</span>, <span class="hljs-number">222</span>, <span class="hljs-number">222</span>));<br>                        <span class="hljs-comment">// (222, 222, 222) è¿™ä¸ªé¢œè‰²è·Ÿ Windows èµ„æºç®¡ç†å™¨çš„ ListView çš„æ ‡é¢˜æ çš„æ–‡å­—é¢œè‰²ä¸€æ ·çš„ï¼Œè¡¨ç°ä¸ºæµ…ç°è‰²</span><br>                        <span class="hljs-keyword">return</span> CDRF_DODEFAULT;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> WM_NCDESTROY:<br>        &#123;<br>            <span class="hljs-built_in">RemoveWindowSubclass</span>(hWnd, ListViewSubclass, uIdSubclass);<br>            <span class="hljs-comment">// è®°å¾—åœ¨ ListView å…³é—­æ—¶ç§»é™¤å­ç±»åŒ–å‡½æ•°</span><br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">DefSubclassProc</span>(hWnd, uMsg, wParam, lParam); <span class="hljs-comment">// è®© DefSubclassProc å¤„ç†æˆ‘ä»¬æ²¡æœ‰å¤„ç†çš„æ¶ˆæ¯</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŸç†å…¶å®ä¹Ÿç›¸å½“äºè‡ªç»˜ï¼Œåªä¸è¿‡æ¯”è¾ƒé«˜æ˜ï¼Œè¿™ä¹Ÿæ˜¯å¾®è½¯æ¨èçš„æ–¹å¼ï¼Œè€Œä¸æ˜¯é‡å†™ OnPaint (WM_PAINT)ã€‚</p>
<p>è½¬åˆ° SetListViewTheme å‡½æ•°ï¼Œå¯ç”¨å­ç±»åŒ–</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetListViewTheme</span><span class="hljs-params">(HWND hListView)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">SetWindowSubclass</span>(hListView, ListViewSubclass, <span class="hljs-built_in">reinterpret_cast</span>&lt;UINT_PTR&gt;(hListView), <span class="hljs-number">0</span>);<br><br>	<span class="hljs-built_in">SetWindowTheme</span>(hListView, <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetHeader</span>(hListView), <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>çœ‹çœ‹æ•ˆæœ</p>
<p><img src="/../archive-imgs/38/30-dark-listview-no-tt.png" srcset="/img/loading.gif" lazyload></p>
<p>ä½ ä»¥ä¸ºå°±å®Œäº†å—ï¼Œå¦‚æœæˆ‘ä»¬æŠŠå†…å®¹å¼„é•¿ä¸€ç‚¹ï¼Œç„¶åé¼ æ ‡æ”¾ä¸Šå»ï¼Œä½ å°±ä¼šå‘ç°â€¦</p>
<p><img src="/../archive-imgs/38/31-undark-listview-tt.png" srcset="/img/loading.gif" lazyload></p>
<p>æƒŠä¸æƒŠå–œï¼Œæ„ä¸æ„å¤–ï¼è¿˜æœ‰ä¸€ä¸ªæ§ä»¶å‘¢ï¼</p>
<p>è¿™æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„å­¦åå« ToolTipï¼Œç”¨äºâ€¦ emmm â€¦ åæ­£å°±é•¿è¿™æ ·ï¼Œä½†å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªçª—å£ã€‚é‚£ä¹ˆè¿™ä¸ªç©æ„å„¿çš„å¥æŸ„æ€ä¹ˆè·å–ï¼Œç„¶ååº”ç”¨æ·±è‰²ä¸»é¢˜å‘¢ï¼Ÿè€æ ·å­ï¼Œå…ˆçœ‹æ–‡æ¡£ï¼Œæ–‡æ¡£æ²¡æœ‰å†æƒ³å…¶ä»–åŠæ³•ã€‚</p>
<p>è½¬åˆ°æˆ‘ä»¬ä¹‹å‰æ‰¾åˆ°çš„ ListView_GetHeader çš„<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/commctrl/nf-commctrl-listview_getheader">é¡µé¢</a>ï¼Œçœ‹çœ‹å·¦ä¾§ï¼Œè¿™æ˜¯ä»€ä¹ˆï¼Ÿä½ ä¸è§‰å¾—å¯¹å®ƒæœ‰ä¸ªå¾ˆå¾®å¦™çš„æ„Ÿè§‰å—ï¼Œæ„Ÿè§‰æœ‰ä»€ä¹ˆå¥½ä¸œè¥¿å°±è¦æ¥äº†ï¼Ÿ</p>
<p><img src="/../archive-imgs/38/32-msdoc-lv-get-tt-mac.png" srcset="/img/loading.gif" lazyload></p>
<p>ç›´æ¥ç‚¹è¿›å»ï¼Œçœ‹çœ‹å®ƒæ˜¯å¹²ä»€ä¹ˆçš„</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">è¿”å›å€¼<br>ç±»å‹ï¼šHWND<br><br>è¿”å›å·¥å…·æç¤º (ToolTip) æ§ä»¶çš„å¥æŸ„ã€‚<br></code></pre></td></tr></table></figure>
<p>çœ‹å§ï¼Œæœç„¶ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Ÿå¼€æï¼</p>
<p>è½¬åˆ° ListViewHelper.cpp çš„ SetListViewTheme é‚£é‡Œï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetListViewTheme</span><span class="hljs-params">(HWND hListView)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">SetWindowSubclass</span>(hListView, ListViewSubclass, <span class="hljs-built_in">reinterpret_cast</span>&lt;UINT_PTR&gt;(hListView), <span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(hListView, <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetHeader</span>(hListView), <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetToolTips</span>(hListView), <span class="hljs-string">L&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/33-dark-listview-tt.png" srcset="/img/loading.gif" lazyload></p>
<p>ä½ ä»¥ä¸ºåˆå®Œäº†å—ï¼Ÿå¦‚æœæˆ‘ä»¬æŠŠ ListView çš„åˆ—å’Œè¡Œå¤šå¼„å‡ ä¸ªï¼Œè¿™é‡Œå°±ç¼©å°çª—ä½“åŠ ListView æ¥æ¨¡æ‹ŸåŒæ ·çš„æ•ˆæœã€‚ä½ ä¼šå‘ç°â€¦</p>
<p><img src="/../archive-imgs/38/36-undark-lv-sb.png" srcset="/img/loading.gif" lazyload></p>
<p>æ˜¯ä¸æ˜¯æœ‰ç‚¹å¿ƒè‚ºéª¤åœï¼Œè¿™ä¿©æ»šåŠ¨æ¡ (H&#x2F;VScrollBar) å¤ªåˆºçœ¼äº†ï¼Œè¿™å¯æ€ä¹ˆåŠå‘¢ï¼Ÿå…ˆæ¥çœ‹çœ‹ Spy++ æœ‰æ²¡æœ‰æ¢æµ‹åˆ°</p>
<p><img src="/../archive-imgs/38/37-undark-lvsb-spyxx.png" srcset="/img/loading.gif" lazyload></p>
<p>å®Œè¾£ï¼ç®€ç›´å°±æ˜¯é“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆï¼Œæˆ‘ä»¬æ¯æƒ³ä¸ªæ–°æ–¹æ³•æ€»èƒ½é‡åˆ°æŠŠæˆ‘ä»¬æ‰“å›åŸå½¢çš„æƒ…å†µã€‚è¿™ä¿©å°ç™½æ¡å‹æ ¹å°±æ²¡å¥æŸ„ï¼Œé‚£æˆ‘ä»¬ä¹Ÿæ²¡å¿…è¦æŒ‡æœ›ä»€ä¹ˆ ListView_GetH&#x2F;VScrollBar äº†ï¼Œå› ä¸ºå¾®è½¯ä¹Ÿæ²¡æœ‰æä¾›ç›¸å…³çš„å®ã€‚</p>
<p>ä½†è¦çŸ¥é“ï¼Œåœ¨æ ‡å‡† Win32 æ§ä»¶é‡Œï¼ŒScrollBar æ˜¯ä¸ªç‹¬ç«‹çš„æ§ä»¶ï¼Œæ‹¥æœ‰ HWNDã€‚é‚£è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p>
<p>å› ä¸ºè¿™ä¸¤å°ç™½æ¡æ˜¯ ListView çš„ â€œç§ç”Ÿå­â€ï¼Œæ˜¯è¢« ListView ç”»å‡ºæ¥çš„ï¼Œå‹æ ¹å°±æ²¡æœ‰èµ°åˆ›å»ºæ§ä»¶çš„æ–¹å¼ï¼Œè‡ªç„¶å°±æ²¡æœ‰ HWND äº†ã€‚</p>
<p>é‚£è¿™è¦æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°æ›´åº•å±‚çš„åŸç†äº†ï¼Œå¦‚æœæˆ‘ä»¬å°†æ§ä»¶çš„ç»˜åˆ¶æƒ³è±¡ä¸ºè´´å›¾çš„æ¸²æŸ“ï¼Œé‚£è¿™äº›è´´å›¾æ€»å¾—æœ‰ä¸ªæ¥æºå§ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹å†…éƒ¨è´´å›¾ï¼Ÿä¸ï¼Œè¿™å·¥ä½œé‡å¤ªå¤§äº†ã€‚æˆ‘ä»¬å¯ä»¥åŠ«æŒï¼ç”¨ IAT Hookã€‚è¿™ä¸ª Hook çš„å·¥ä½œåŸç†é€šä¿—æ¥è¯´å°±æ˜¯åœ¨å¯¹æ–¹æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¿›è¡Œå·æ¢æ¢æŸ±ã€‚å½“ ListView è®¿é—®æ»šåŠ¨æ¡çš„è´´å›¾æ—¶ï¼Œæˆ‘ä»¬ç»™å®ƒæ¥ä¸ªé‡å®šå‘ï¼Œè®©å®ƒå»ç”»æœ‰æ·±è‰²ä¸»é¢˜çš„æ»šåŠ¨æ¡ã€‚</p>
<p>å¯èƒ½å¯¹äºæ–°æ‰‹æœ‹å‹æ¥è¯´ç†è§£èµ·æ¥åˆæœ‰äº›åƒåŠ›äº†ï¼Œé‚£æˆ‘ä»¬å†æ¥ä»¿ç”Ÿä¸€ä¸‹ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">(ListView æ¥åˆ°è´´å›¾å•†åº— ...)<br><br>ListView: è€æ¿ï¼Œç»™æˆ‘æ¥ä¸€ä»½ ScrollBar çš„è´´å›¾<br>(ListView è°ƒç”¨äº†ä¸€ä¸ªæœªå…¬å¼€çš„ API)<br><br>UxTheme: å¥½çš„ï¼Œç»™ä½  Explorer::ScrollBar<br>(è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œä½†ç°åœ¨æˆ‘ä»¬é€šè¿‡ IAT Hook é»‘äº†è€æ¿çš„å·ï¼Œäºæ˜¯å°±å˜æˆäº†...)<br><br>System: (å°å£°) @Natives (æˆ‘ä»¬çš„ DLL)ï¼Œå¿«å¿«å¿«ï¼ŒListView æ¥ä¹° ScrollBar äº†<br><br>Natives: æ”¶åˆ°ï¼<br>(æˆ‘ä»¬æ›´æ¢äº†å•†åº—çš„è€æ¿ï¼Œè¿™ä¸ªè€æ¿åªå¬æˆ‘ä»¬çš„è¯ï¼Œä¸”è®©æ–°è€æ¿ç«™åœ¨æ—§è€æ¿çš„ä½ç½®)<br><br>UxTheme (Hacked): å¥½çš„ï¼Œç»™ä½  DarkMode_Explorer::ScrollBar<br></code></pre></td></tr></table></figure>

<p>å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œå…·ä½“å®ç°ï¼Œæˆ‘ä»¬æ”¾åˆ°ä¸‹ä¸€ä¸ªä¸“é¢˜ã€‚</p>
<h3 id="ScrollBar"><a href="#ScrollBar" class="headerlink" title="ScrollBar"></a>ScrollBar</h3><p>ScrollBarï¼Œå³æ»šåŠ¨æ¡ï¼Œæ˜¯æ ‡å‡†çš„ Win32 æ§ä»¶ (ä¹Ÿå°±æ˜¯æœ‰ HWND)ï¼ŒWinForms é‡Œä¹Ÿæœ‰å°è£… (HScrollBar å’Œ VScrollBar)ã€‚åœ¨åˆ›å»º ScrollBar æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š SBS_HORZ æˆ– SBS_VERT æ¥å†³å®šæ»šåŠ¨æ¡çš„æœå‘ã€‚</p>
<p>å¦‚æœèƒ½è·å–åˆ°å¥æŸ„çš„è¯ï¼Œé‚£æˆ‘ä»¬ç›´æ¥è°ƒç”¨ SetWindowTheme å‡½æ•°è®¾ç½®ä¸º DarkMode_Explorer ä¸»é¢˜å°±å®Œäº‹äº†ï¼Œé‚£æ²¡æœ‰å¥æŸ„å‘¢ï¼Ÿ</p>
<p>æ²¡æœ‰å¥æŸ„çš„æƒ…å†µå¸¸è§äºå¤šæ•°å¯æ»šåŠ¨çš„æ§ä»¶ (æ¯”å¦‚ä¸Šæ–¹æåˆ°çš„ ListViewã€TreeView)ï¼Œå®ƒä»¬çš„æ»šåŠ¨æ¡éƒ½æ˜¯è‡ªå·±ç”»çš„ï¼Œè€Œä¸æ˜¯åˆ›å»ºçš„æ ‡å‡†æ§ä»¶ï¼Œæ˜¯ä¸å…·æœ‰ HWND çš„ã€‚</p>
<p>æ’æ’­ä¸€æ¡ï¼Œä½ æœ‰æ²¡æœ‰å‘ç° TreeView çš„æ»šåŠ¨æ¡åœ¨æˆ‘ä»¬å¤„ç†åå°±ç›´æ¥å˜æ·±è‰²äº†ï¼Œè€Œ ListView å´ä¸è¡Œï¼Ÿå› ä¸º TreeView ä¹Ÿæ˜¯ç”¨çš„æ˜¯ DarkMode_Explorer ä¸»é¢˜ï¼Œè¿™ä¸ªä¸»é¢˜æ˜¯åŒ…æ‹¬æ»šåŠ¨æ¡çš„ï¼Œè€Œ ListView ä½¿ç”¨çš„ DarkMode_ItemsView æ˜¯ä¸åŒ…æ‹¬æ»šåŠ¨æ¡çš„ï¼Œè‡ªç„¶å°±æ²¡æœ‰æ·±è‰²ä¸»é¢˜äº†ã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œè¦æƒ³åº”ç”¨æ·±è‰²ä¸»é¢˜ï¼Œå°±è¦å…ˆæ˜ç™½å®ƒä»¬æ˜¯é€šè¿‡æ€ä¹ˆæ ·çš„æ–¹å¼è·å–åˆ°è´´å›¾ã€‚</p>
<p>é€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œæˆ‘ä»¬å‘ç°åœ¨ uxtheme.dll çš„ç¬¬ 49 ä¸ªå…¥å£ï¼Œå¯¼å‡ºäº†ä¸€ä¸ªå« OpenNcThemeData çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥è·å–æ§ä»¶çš„éå®¢æˆ·åŒºçš„ä¸»é¢˜çš„æ•°æ®çš„ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†æ»šåŠ¨æ¡ã€‚</p>
<p>å¦‚æœèƒ½ç›‘æµ‹åº”ç”¨ç¨‹åºè®¿é—® OpenNcThemeData çš„è¯ï¼Œæˆ‘ä»¬å°±èƒ½è¿›è¡Œå·æ¢æ¢æŸ±ï¼Œè®©åº”ç”¨ç¨‹åºè·å–åˆ° DarkMode_Explorer é‡Œçš„ ScrollBarã€‚</p>
<p>è¿™ä¸ªç›‘æµ‹æ‰‹æ®µå°±å« IAT Hookï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¿®æ”¹ç›®æ ‡æ¨¡å—çš„å¯¼å…¥è¡¨ï¼ŒæŠŠåŸæœ¬æŒ‡å‘æŸä¸ª API çš„å‡½æ•°æŒ‡é’ˆæ›¿æ¢æˆæˆ‘ä»¬å®šä¹‰çš„é’©å­å‡½æ•°ã€‚</p>
<p>å…·ä½“æ€ä¹ˆå®ç°å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬åˆå‚è€ƒäº† <a target="_blank" rel="noopener" href="https://github.com/ysc3839/win32-darkmode/blob/master/win32-darkmode/IatHook.h">ysc3839&#x2F;win32-darkmode</a> çš„ä»£ç ã€‚</p>
<p>æˆ‘ä»¬ä¸‹è½½å¹¶å¯¼å…¥ (å³é”® C++ é¡¹ç›®ï¼Œé€‰æ‹© æ·»åŠ  &gt;ç°æœ‰é¡¹) ysc3839 å¤§ä½¬æä¾›çš„å¤´æ–‡ä»¶</p>
<p><img src="/../archive-imgs/38/38-cpp-import-iathook.png" srcset="/img/loading.gif" lazyload></p>
<p>å¹¶åœ¨ ListViewHelper.cpp é‡Œæ·»åŠ å¼•ç”¨</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;IatHook.h&quot;</span></span><br></code></pre></td></tr></table></figure>

<p>è½¬åˆ° ListViewHelper.hï¼Œæ·»åŠ ä¸€ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œè¡¨ç¤º ä¿®å¤æ»šåŠ¨æ¡(çš„æ·±è‰²ä¸»é¢˜)ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">cexport</span>(<span class="hljs-type">void</span>) <span class="hljs-built_in">FixScrollBar</span>();<br></code></pre></td></tr></table></figure>

<p>è½¬åˆ° ListViewHelper.cppï¼Œæ·»åŠ  OpenNcThemeData å‡½æ•°æŒ‡é’ˆå’Œ FixScrollBar ä¸»ä½“</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> fnOpenNcThemeData = <span class="hljs-built_in">HTHEME</span> (WINAPI*)(HWND hWnd, LPCWSTR pszClassList);<br>fnOpenNcThemeData OpenNcThemeData = <span class="hljs-literal">nullptr</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FixScrollBar</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    HMODULE hUxtheme = <span class="hljs-built_in">LoadLibraryEx</span>(<span class="hljs-string">L&quot;uxtheme.dll&quot;</span>, <span class="hljs-literal">nullptr</span>, LOAD_LIBRARY_SEARCH_SYSTEM32);<br>    HMODULE hComctl = <span class="hljs-built_in">LoadLibraryEx</span>(<span class="hljs-string">L&quot;comctl32.dll&quot;</span>, <span class="hljs-literal">nullptr</span>, LOAD_LIBRARY_SEARCH_SYSTEM32);<br>    <span class="hljs-comment">// åŠ¨æ€åŠ è½½ uxtheme.dll å’Œ comctl32.dll (è¿™ä¸ªæ˜¯ Win32 æ§ä»¶åº“)</span><br><br>    <span class="hljs-keyword">if</span> (hUxtheme)<br>    &#123;<br>        <span class="hljs-keyword">auto</span> addr = <span class="hljs-built_in">GetProcAddress</span>(hUxtheme, <span class="hljs-built_in">MAKEINTRESOURCEA</span>(<span class="hljs-number">49</span>));<br><br>        <span class="hljs-keyword">if</span> (addr)<br>        &#123;<br>            OpenNcThemeData = <span class="hljs-built_in">reinterpret_cast</span>&lt;fnOpenNcThemeData&gt;(addr);<br>            <span class="hljs-comment">// å°†æŒ‡é’ˆæŒ‡å‘ 49 å·å…¥å£ï¼Œæˆ‘ä»¬å°±èƒ½ç›´æ¥è°ƒç”¨ OpenNcThemeData äº†ï¼Œè¿™å°±ç±»ä¼¼äºæˆ‘ä»¬åœ¨ C# Interop æŒ‡å®š DllImport #49</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (hComctl)<br>    &#123;<br>        <span class="hljs-keyword">auto</span>* addr = <span class="hljs-built_in">FindDelayLoadThunkInModule</span>(hComctl, <span class="hljs-string">&quot;uxtheme.dll&quot;</span>, <span class="hljs-number">49</span>);<br><br>        <span class="hljs-keyword">if</span> (addr)<br>        &#123;<br>            DWORD oldProtect;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">VirtualProtect</span>(addr, <span class="hljs-built_in">sizeof</span>(IMAGE_THUNK_DATA), PAGE_READWRITE, &amp;oldProtect))<br>            &#123;<br>                <span class="hljs-keyword">auto</span> MyOpenThemeData = [](HWND hWnd, LPCWSTR classList) -&gt; HTHEME<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">wcscmp</span>(classList, <span class="hljs-string">L&quot;ScrollBar&quot;</span>) == <span class="hljs-number">0</span>)<br>                    &#123;<br>                        hWnd = <span class="hljs-literal">nullptr</span>;<br>                        classList = <span class="hljs-string">L&quot;DarkMode_Explorer::ScrollBar&quot;</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">// å·æ¢æ¢æŸ±ï¼Œæ£€æµ‹æ˜¯å¦è®¿é—®äº†åä¸º ScrollBar çš„ä¸»é¢˜ï¼Œè‹¥æ˜¯åˆ™æ›¿æ¢ä¸º DarkMode_Explorer::ScrollBar</span><br><br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">OpenNcThemeData</span>(hWnd, classList);<br>                &#125;;<br><br>                addr-&gt;u1.Function = <span class="hljs-built_in">reinterpret_cast</span>&lt;ULONG_PTR&gt;(<span class="hljs-built_in">static_cast</span>&lt;fnOpenNcThemeData&gt;(MyOpenThemeData));<br>                <span class="hljs-built_in">VirtualProtect</span>(addr, <span class="hljs-built_in">sizeof</span>(IMAGE_THUNK_DATA), oldProtect, &amp;oldProtect);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è½¬åˆ° ThemeManager.csï¼Œå£°æ˜å¯¼å…¥å‡½æ•°</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;Natives.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FixScrollBar</span>()</span>;<br></code></pre></td></tr></table></figure>
<p>è½¬åˆ°ç¨‹åºçš„å…¥å£ (Program.cs)ï¼Œåœ¨æˆ‘ä»¬ä¹‹å‰è®¾ç½® ContextMenu æ·±è‰²ä¸»é¢˜çš„é‚£ä¸ªåœ°æ–¹ä¹‹å‰è°ƒç”¨å®ƒã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><br>&#123;<br>    [<span class="hljs-meta">STAThread</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.FixScrollBar();<br>            ThemeManager.SetPreferredAppMode(PreferredAppMode.ForceDark);<br>        &#125;<br><br>        Application.EnableVisualStyles();<br>        Application.SetCompatibleTextRenderingDefault(<span class="hljs-literal">false</span>);<br>        Application.Run(<span class="hljs-keyword">new</span> Form1());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/36-undark-lv-sb.png" srcset="/img/loading.gif" lazyload></p>
<p>æœ‰ç‚¹åŒªå¤·æ‰€æ€äº†å‘¢ï¼Œå›å¤´çœ‹çœ‹æˆ‘ä»¬çš„ä»£ç æœ‰æ²¡æœ‰æ¼å†™ä»€ä¹ˆï¼Ÿ</p>
<p>â€¦ åŠ è½½äº† uxtheme.dll å’Œ comctl32.dllï¼Œç„¶åæ‰¾å…¥å£ï¼ŒOpenNcThemeData å‡½æ•°æŒ‡é’ˆä¹Ÿç†è®ºä¸Šæ¥è¯´ä¸æ˜¯ nullptr â€¦ æ²¡æœ‰é—®é¢˜å•Šï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p>
<p>äºæ˜¯ä½ æ‰“å¼€äº†æŸå·¥å…· (æˆ‘å–œæ¬¢ç”¨ System Informer)ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯å¦åŠ è½½äº†ç›¸åº”çš„ dllã€‚</p>
<p><img src="/../archive-imgs/38/39-loaded-uxtheme.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../archive-imgs/38/40-loaded-comctl32.png" srcset="/img/loading.gif" lazyload></p>
<p>ä½ å‘ç° uxtheme å·²åŠ è½½äº†ï¼Œä½† â€¦ æ€ä¹ˆæœ‰ä¸¤ä¸ª comctl32ï¼Ÿ</p>
<p>å±•å¼€æ–‡ä»¶è·¯å¾„ï¼Œä½ ä¼šå‘ç°ä¸¤ä¸ª comctl32 çš„ç‰ˆæœ¬éƒ½ä¸ä¸€æ ·ï¼Œä¸€ä¸ª v6 ä¸€ä¸ª v5ï¼</p>
<p>è¿™åˆæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿç»æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼š</p>
<ul>
<li>WinForms çš„ Application.EnableVisualStyles() ä¼šä½¿ Win32 æ§ä»¶å…·æœ‰ç°ä»£æ ·å¼ï¼Œä¹Ÿå°±æ˜¯è¦åŠ è½½ CommCtrl v6ï¼Œå¦åˆ™å°±æ˜¯å¤å¤æ ·å¼ (v5)</li>
<li>ä¼ ç»Ÿ Win32 åº”ç”¨ç¨‹åºä¸­ï¼Œè¦æƒ³è¾¾åˆ°å’Œ WinForms ä¸€æ ·çš„æ•ˆæœï¼Œå¿…é¡»è¦åœ¨æ¸…å•é‡Œå£°æ˜ CommCtrl v6</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´é‚£ä¸ª v5 æ˜¯æˆ‘ä»¬çš„ FixScrollBar å‡½æ•°åŠ è½½çš„ï¼Œé’©å­éƒ½é’©é”™åœ°æ–¹äº†ï¼Œæˆ‘ä»¬é¢„æœŸè¦é’©ä½ v6 çš„ã€‚</p>
<p>æ‰“å¼€æˆ‘ä»¬ä¹‹å‰ä¸ºæˆ‘ä»¬ C# ç¨‹åºæ·»åŠ çš„ app.manifest æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">assembly</span> <span class="hljs-attr">manifestVersion</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v1&quot;</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!-- æ·»åŠ ä»¥ä¸‹çš„ï¼Œå…¶ä»–ä¸å˜ --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependentAssembly</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">assemblyIdentity</span></span><br><span class="hljs-tag">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;win32&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Microsoft.Windows.Common-Controls&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;6.0.0.0&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">&quot;*&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;6595b64144ccf1df&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">language</span>=<span class="hljs-string">&quot;*&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependentAssembly</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">assembly</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>ä¸‹é¢å°±æ˜¯è§è¯å¥‡è¿¹çš„æ—¶åˆ»ï¼š</p>
<p><img src="/../archive-imgs/38/41-dark-lvsb.png" srcset="/img/loading.gif" lazyload></p>
<p>ç®€ç›´å¯ä»¥è¯´æ˜¯å®Œç¾ï¼ListView çš„æ·±è‰²ä¸»é¢˜å°±åˆ°æ­¤ä¸ºæ­¢äº†</p>
<p>å¦å¤–ï¼Œè¦æ³¨æ„çš„æ˜¯ FixScrollBar çš„ä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºå†…çš„æ»šåŠ¨æ¡ï¼Œè€Œä¸æ˜¯åªæœ‰è¿™ä¸ª ListViewã€‚</p>
<h3 id="ColorDialog-FontDialog"><a href="#ColorDialog-FontDialog" class="headerlink" title="ColorDialog&#x2F;FontDialog"></a>ColorDialog&#x2F;FontDialog</h3><p>è¿™ä¸¤ä¸ªå¯¹è¯æ¡†å¤§å®¶éƒ½ä¸é™Œç”Ÿå§ï¼Œå°±æ˜¯ç³»ç»Ÿå†…ç½®çš„æŒ‘é€‰é¢œè‰²ã€å­—ä½“çš„å¯¹è¯æ¡†ã€‚ä½ æœ‰æ²¡æœ‰æƒ³è¿‡æ›´æ”¹å®ƒä»¬çš„æ ·å¼æˆ–è€…è¡Œä¸ºå‘¢ï¼Ÿ</p>
<p>å¯èƒ½ä½ æƒ³è¿‡ï¼Œä½†ä½ å‘ç°å®ƒä»¬å¹¶æ²¡æœ‰ Handle å±æ€§ï¼Œä¹Ÿå°±æ˜¯è·å–ä¸åˆ° HWNDï¼Œå°±ä»€ä¹ˆä¹Ÿå¹²ä¸äº†ï¼Œäºæ˜¯ä½ æ”¾å¼ƒäº†è¿™ä¸€æƒ³æ³•ã€‚</p>
<p>ä»Šå¤©ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæƒ³æ³•å˜æˆç°å®ã€‚</p>
<p>æ‰“å¼€å¾®è½¯æ–‡æ¡£ï¼ŒæŸ¥è¯¢ <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.forms.commondialog">CommonDialog</a>ï¼Œæˆ‘ä»¬å‘ç°è¯¥ç±»æä¾›äº†ä¸€ä¸ªè™šæ–¹æ³•ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">HookProc(IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wparam, IntPtr lparam);    <span class="hljs-comment">// å®šä¹‰è¦é‡å†™çš„é€šç”¨å¯¹è¯æ¡†æŒ‚é’©è¿‡ç¨‹ï¼Œä»¥ä¾¿å‘é€šç”¨å¯¹è¯æ¡†æ·»åŠ ç‰¹å®šåŠŸèƒ½ã€‚</span><br></code></pre></td></tr></table></figure>

<p>å¹¶ä¸”è¿™ä¸ªæ–¹æ³•åœ¨ ColorDialog å’Œ FontDialog é‡Œé¢ä¹Ÿå¹¶æ²¡æœ‰å£°æ˜ä¸º sealedï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥é‡å†™ã€‚æ›´å…³é”®çš„æ˜¯ï¼Œçœ‹åˆ° hWnd å‚æ•°äº†å—ï¼Œå®ƒå°±æ˜¯å¯¹è¯æ¡†çš„å¥æŸ„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡å†™ HookProc æ¥æ‹¿åˆ°å¥æŸ„ï¼Œè€Œä¸æ˜¯ç”¨ä»€ä¹ˆ Handle å±æ€§ã€‚</p>
<p>åœ¨é‡å†™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ–°å»ºä¸€ä¸ªè¾…åŠ©ç±»ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå¯¹è¯æ¡†å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œå‘½åä¸º CommonDialogHelperã€‚è¯¥ç±»å…·æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå…è®¸æˆ‘ä»¬ä¼ å…¥å½“å‰å¯¹è¯æ¡†å®ä¾‹ï¼Œä»¥åŠ HookProc</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CommonDialogHelper</span>(<span class="hljs-params">CommonDialog dialog, HOOKPROC hook</span>) <span class="hljs-comment">// C# 12 çš„æ–°ç‰¹æ€§ ä¸»æ„é€ å‡½æ•°ï¼Œå…è®¸æˆ‘ä»¬å£°æ˜ç±»çš„åŒæ—¶å£°æ˜æ„é€ å‡½æ•°</span></span><br>&#123;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">delegate</span> IntPtr <span class="hljs-title">HOOKPROC</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span>; <span class="hljs-comment">// HOOKPROC å§”æ‰˜ï¼Œå†™åœ¨ç±»çš„å¤–é¢</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨åˆ°äº†å§”æ‰˜ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬è¿™é‡Œè¦ä¼ å…¥å¯¹è¯æ¡†çš„ HookProcï¼Œç›´æ¥å†™çš„è¯ç›¸å½“äºæ‰§è¡Œè¿™ä¸ªæ–¹æ³•å¹¶æ‹¿åˆ°è¿”å›å€¼ï¼Œä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬åªæ˜¯æƒ³å°è£…è¿™ä¸ªæ–¹æ³•ï¼Œè¿˜ä¸æ€¥ç€æ‰§è¡Œã€‚æ‰€ä»¥å°±è¦ç”¨åˆ°å§”æ‰˜äº†ï¼Œå§”æ‰˜å°±å¯ä»¥å¸®æˆ‘ä»¬å°è£…æ–¹æ³•ï¼Œç­‰æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„æ—¶å€™å†æ‹¿å‡ºæ¥æ‰§è¡Œã€‚é‚£ä¸ºä»€ä¹ˆ HOOKPROC è¦å…¨å¤§å†™å‘¢ï¼Ÿä¸€æ˜¯å› ä¸ºä½¿ç”¨ HookProc ä¼šäº§ç”Ÿæ­§ä¹‰ (é‡åäº†)ï¼ŒäºŒæ˜¯é’©å­è¿‡ç¨‹åœ¨ Win32 é‡Œå®šä¹‰ä¹Ÿæ˜¯ HOOKPROCã€‚</p>
<p>å› æ­¤æˆ‘ä»¬çš„è¾…åŠ©ç±»è¿˜è¦æä¾›ä¸€ä¸ªå¼€æ”¾çš„ HookProc æ¥ä¾›å¯¹è¯æ¡†è‡ªå·±è°ƒç”¨ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> IntPtr.Zero;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ç€æˆ‘ä»¬åˆ›å»º MyColorDialog å’Œ MyFontDialogï¼Œé‡å†™ HookProc è¿”å›æˆ‘ä»¬è‡ªå·±çš„ HookProcï¼Œå¹¶è®¾ç½®ä¸€äº›å‚æ•°ï¼Œè®©å¯¹è¯æ¡†æ›´æ˜“ä½¿ç”¨ï¼Œä»¥åŠåŠ å…¥æˆ‘ä»¬çš„è¾…åŠ©ç±»å®ä¾‹</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyColorDialog</span> : <span class="hljs-title">ColorDialog</span><br>&#123;<br>    <span class="hljs-keyword">private</span> CommonDialogHelper Helper;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyColorDialog</span>()</span><br>    &#123;<br>        AllowFullOpen = <span class="hljs-literal">true</span>;<br>        FullOpen = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">new</span> DialogResult <span class="hljs-title">ShowDialog</span>()</span><br>    &#123;<br>        Helper = <span class="hljs-keyword">new</span> CommonDialogHelper(<span class="hljs-keyword">this</span>, HookProc);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.ShowDialog();<br>        <span class="hljs-comment">// æ˜¾å¼ base å…³é”®è¯è¡¨ç¤ºæˆ‘ä»¬è°ƒç”¨çš„æ˜¯åŸ ColorDialog è‡ªå·±çš„ ShowDialogï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸åŸºç±»åŒç­¾åçš„æ–¹æ³•ã€‚</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wparam, IntPtr lparam</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Helper.HookProc(hWnd, msg, wparam, lparam);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFontDialog</span> : <span class="hljs-title">FontDialog</span><br>&#123;<br>    <span class="hljs-keyword">private</span> CommonDialogHelper Helper;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyFontDialog</span>()</span><br>    &#123;<br>        AllowVerticalFonts = <span class="hljs-literal">false</span>;<br>        FontMustExist = <span class="hljs-literal">true</span>;<br>        ScriptsOnly = <span class="hljs-literal">true</span>;<br>        ShowEffects = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">new</span> DialogResult <span class="hljs-title">ShowDialog</span>()</span><br>    &#123;<br>        Helper = <span class="hljs-keyword">new</span> CommonDialogHelper(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">base</span>.HookProc);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.ShowDialog();<br>        <span class="hljs-comment">// æ˜¾å¼ base å…³é”®è¯è¡¨ç¤ºæˆ‘ä»¬è°ƒç”¨çš„æ˜¯åŸ FontDialog è‡ªå·±çš„ ShowDialogï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸åŸºç±»åŒç­¾åçš„æ–¹æ³•ã€‚</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wparam, IntPtr lparam</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Helper.HookProc(hWnd, msg, wparam, lparam);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬åœ¨ HookProc é‡Œåº”è¯¥å†™ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œå‚è€ƒäº† System Informer çš„<a target="_blank" rel="noopener" href="https://github.com/winsiderss/systeminformer/blob/5475fef970fcbcee128cf88d957280bbcea608d0/SystemInformer/options.c#L3349-L3374">ä»£ç </a></p>
<p>æˆ‘ä»¬å¾—çŸ¥ï¼Œå½“å¯¹è¯æ¡†åˆ›å»ºæ—¶ï¼Œä¼šæœ‰ä¸€ä¸ª WM_INITDIALOG æ¶ˆæ¯ï¼Œå½“å¯¹è¯æ¡†è®¾ç½®æ§ä»¶é¢œè‰²æ—¶ï¼Œä¼šæœ‰ WM_CTLCOLOR* ç³»åˆ—æ¶ˆæ¯ï¼Œæ­¤æ—¶çš„è¿”å›å€¼è¡¨ç¤ºå¸¦æœ‰<strong>èƒŒæ™¯é¢œè‰²</strong>çš„ç”»åˆ·ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å°±ä¸ç”¨ C++ äº†ï¼Œå› ä¸º HookProc åœ¨ C# ä¾§å°±æœ‰å®ç°äº†ï¼Œä¸ç„¶æ•´ä¸ªè°ƒç”¨é“¾å°±å¤ªé•¿äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ C# é‡Œå®šä¹‰è¿™äº›æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆæ¯ç¼–å·æ€ä¹ˆæ‰¾ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬å®‰è£…çš„ Windows SDK å—ï¼Œæˆ‘ä»¬ç›´æ¥æ‰“å¼€ Everything æœç´¢ winuser.hï¼Œå°†è¿™äº›å®å®šä¹‰è½¬å†™ä¸º C# å¸¸é‡å­—æ®µï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_INITDIALOG = <span class="hljs-number">0x0110</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_CTLCOLORDLG = <span class="hljs-number">0x0136</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_CTLCOLOREDIT = <span class="hljs-number">0x0133</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_CTLCOLORSTATIC = <span class="hljs-number">0x0138</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_CTLCOLORLISTBOX = <span class="hljs-number">0x0134</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_CTLCOLORBTN = <span class="hljs-number">0x0135</span>;<br></code></pre></td></tr></table></figure>

<p>ä»¥åŠå£°æ˜å¯¼å…¥å‡½æ•°ï¼Œå®ƒä»¬æ˜¯å¤„ç† WM_CTLCOLOR* çš„å››ä»¶å¥—</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;gdi32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetBkMode</span>(<span class="hljs-params">IntPtr hdc, <span class="hljs-built_in">int</span> mode</span>)</span>;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;gdi32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetBkColor</span>(<span class="hljs-params">IntPtr hdc, <span class="hljs-built_in">int</span> color</span>)</span>;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;gdi32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetTextColor</span>(<span class="hljs-params">IntPtr hdc, <span class="hljs-built_in">int</span> color</span>)</span>;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;gdi32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateSolidBrush</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> color</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>ç”±äº CreateSolidBrush ä¼šäº§ç”Ÿä¸€ä¸ªå¥æŸ„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯¹è¯æ¡†å…³é—­çš„æ—¶å€™æ¸…ç†è¿™äº›èµ„æºï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_DESTROY = <span class="hljs-number">0x0002</span>; <span class="hljs-comment">// è¡¨ç¤ºå¯¹è¯æ¡†è¢«é”€æ¯ (å…³é—­)</span><br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;gdi32.dll&quot;</span>)</span>]<br>[<span class="hljs-meta">return: MarshalAs(UnmanagedType.Bool)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">DeleteObject</span>(<span class="hljs-params">IntPtr hObject</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>é‚£æ€ä¹ˆå¤„ç† WM_INITDIALOG å‘¢ï¼Ÿæˆ‘ä»¬åº”è¯¥åœ¨è¿™é‡Œå®Œæˆå¯¹æ§ä»¶ä¸»é¢˜çš„åº”ç”¨ï¼Œå¯æ˜¯ CommonDialog å¹¶æœªæä¾› Controls é›†åˆè®©æˆ‘ä»¬éå†æ‰€æœ‰æ§ä»¶ã€‚</p>
<p>è¿™å°±è¦ç”¨åˆ° EnumChildWindows å‡½æ•°äº†ï¼Œä»¥åŠ GetClassName è®©æˆ‘ä»¬åˆ¤æ–­æ˜¯ä»€ä¹ˆæ§ä»¶ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br>[<span class="hljs-meta">return: MarshalAs(UnmanagedType.Bool)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">EnumChildWindows</span>(<span class="hljs-params">IntPtr hWndParent, EnumChildProc lpEnumFunc, IntPtr lParam</span>)</span>;<br><br>[<span class="hljs-meta">UnmanagedFunctionPointer(CallingConvention.StdCall)</span>] <span class="hljs-comment">// è¡¨ç¤ºå‡½æ•°æŒ‡é’ˆï¼šC# çš„å§”æ‰˜å¯¹åº”çš„å°±æ˜¯ C++ çš„å‡½æ•°æŒ‡é’ˆï¼ŒStdCall</span><br>[<span class="hljs-meta">return: MarshalAs(UnmanagedType.Bool)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">delegate</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">EnumChildProc</span>(<span class="hljs-params">IntPtr hWnd, IntPtr lParam</span>)</span>;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>, CharSet = CharSet.Unicode)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetClassName</span>(<span class="hljs-params">IntPtr hWnd, StringBuilder lpClassName, <span class="hljs-built_in">int</span> nMaxCount</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨å°±å¯ä»¥æ¥å®Œæˆ HookProc äº†ï¼Œé¦–å…ˆç¼“å­˜ä¸€äº›å­—æ®µï¼Œé˜²æ­¢é‡å¤è®¡ç®—ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> StringBuilder builder = <span class="hljs-keyword">new</span>(<span class="hljs-number">256</span>); <span class="hljs-comment">// ç”¨äºä½œä¸º Win32 LPWSTR åŠ¨æ€å­—ç¬¦ä¸² çš„ç¼“å†²åŒºï¼Œå¤§å°ä¸€èˆ¬ 256</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IntPtr hBrush = CreateSolidBrush(BackColor);<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> CanUseDarkTheme = ThemeManager.CanUseDarkTheme;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> ForeColor = ColorTranslator.ToWin32(ThemeManager.DarkFore);<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> BackColor = ColorTranslator.ToWin32(ThemeManager.DarkBack);<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (msg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_INITDIALOG:<br><br>            <span class="hljs-keyword">if</span> (CanUseDarkTheme)<br>            &#123;<br>                ThemeManager.FlushWindow(hWnd);<br><br>                EnumChildWindows(hWnd, (child, _) =&gt; <span class="hljs-comment">// è¿™å°±æ˜¯ Win32 æšä¸¾å­çª—å£çš„ç”¨æ³•ï¼Œç±»ä¼¼äº for å¾ªç¯</span><br>                &#123;<br>                    ThemeManager.SetWindowTheme(child, GetThemeName(child), <span class="hljs-literal">null</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// ç»§ç»­æšä¸¾ï¼Œä¸è¦åœ</span><br>                &#125;, IntPtr.Zero);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> WM_CTLCOLORDLG:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLOREDIT:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORSTATIC:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORLISTBOX:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORBTN:<br><br>            <span class="hljs-keyword">if</span> (CanUseDarkTheme)<br>            &#123;<br>                SetBkMode(wParam, <span class="hljs-number">1</span>);<br>                SetTextColor(wParam, ForeColor);<br>                SetBkColor(wParam, BackColor);<br>                <span class="hljs-keyword">return</span> hBrush;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> IntPtr.Zero;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetThemeName</span>(<span class="hljs-params">IntPtr child</span>) <span class="hljs-comment">// åˆ¤æ–­æ§ä»¶ç±»å‹ä»¥åŠè¿”å›ä¸»é¢˜åç§°</span></span><br>&#123;<br>    GetClassName(child, builder, <span class="hljs-number">256</span>);<br>    <span class="hljs-keyword">var</span> className = builder.ToString();<br><br>    <span class="hljs-keyword">if</span> (className == <span class="hljs-string">&quot;ComboBox&quot;</span> || className == <span class="hljs-string">&quot;Edit&quot;</span>) <span class="hljs-comment">// è¡¨ç¤º ComboBox å’Œ TextBox</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;DarkMode_CFD&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>; <span class="hljs-comment">// å…¶ä»–å°±é»˜è®¤ Explorer ä¸»é¢˜</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="/../archive-imgs/38/42-dark-colordialog.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../archive-imgs/38/43-dark-fontdialog-1.png" srcset="/img/loading.gif" lazyload></p>
<p>ä¸€æ°”å‘µæˆï¼Œç®€ç›´ä¸è¦å¤ªçˆ½ã€‚</p>
<p>ä½†ï¼Œå¯¹äº FontDialogï¼Œç‘•ç–µè²Œä¼¼æœ‰ç‚¹å¤šã€‚ç‰¹åˆ«æ˜¯é‚£å‡ ä¸ªå‘ç™½çš„æ§ä»¶ï¼Œç›®å‰è¯´å®è¯æˆ‘ä¹Ÿæ²¡æœ‰åŠæ³•è§£å†³ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯å·²ç»è‡ªç»˜è¿‡çš„äº†ï¼Œè¿™å°±å¥½æ¯”ä¿®ç”µè„‘çš„å¸ˆå‚…å–œæ¬¢ä¿®ä¸€æ‰‹çš„ä¸€æ ·ã€‚å½“æ§ä»¶å·²ç»è‡ªç»˜ä¹‹åï¼Œå†æ¬¡è‡ªç»˜ï¼Œè¦ä¹ˆå·¥ä½œé‡å·¨å¤§ï¼Œè¦ä¹ˆä¹Ÿä¸ä¼šæœ‰å¥½ç»“æœï¼Œé‚£è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å°±æ”¾åœ¨è¿™ï¼Œä»¥åæœ‰æ€è·¯å†æ¥æä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬å…ˆæä¸€ä¸‹é‚£ä¸ª GroupBoxï¼Œå°±æ˜¾ç¤ºå­—ä½“é¢„è§ˆçš„é‚£ä¸ªï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ ‡é¢˜çš„æ–‡å­—æ˜¯æ²¡æœ‰é€‚åº”æ·±è‰²ä¸»é¢˜çš„ï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥è¿˜èƒ½æŠ¢æ•‘ä¸€ä¸‹ã€‚</p>
<p>æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¼¼æ›¾ç›¸è¯†ï¼Ÿé’ˆå¯¹ GroupBox æ ‡é¢˜ä¸é€‚åº”ä¸»é¢˜çš„æƒ…å†µæˆ‘ä»¬å‰é¢æ˜¯ä¸æ˜¯åˆ†æè¿‡ï¼Ÿä¹Ÿå°±æ˜¯é‡å†™ OnPaint è‡ªå·±ç”»è¾¹æ¡†å’Œæ–‡å­—å°±è§£å†³çš„ã€‚ä½†æœ‰ä¸ªå¤§å‰æï¼Œå¾—åœ¨æ‰˜ç®¡ç¯å¢ƒä¸‹ã€‚ç„¶è€Œè¿™ä¸ªå¯¹è¯æ¡†æ˜¯ Win32 çš„ï¼Œå±äºéæ‰˜ç®¡ç¯å¢ƒï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æƒ³æƒ³æˆ‘ä»¬å½“æ—¶æ˜¯ä¸æ˜¯åˆ›å»ºäº† MyGroupBox æ¥é‡å†™ OnPaintï¼Ÿ</p>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡Œå­ç±»åŒ–ï¼Œä¸èƒ½åœ¨ HookProc é‡Œç›´æ¥å¤„ç† WM_PAINTï¼Œé‚£æ˜¯å‘ç»™å¯¹è¯æ¡†çš„ï¼Œä¸æ˜¯ GroupBoxã€‚</p>
<p>é‚£æˆ‘ä»¬æ‰˜ç®¡ç¯å¢ƒæ€ä¹ˆåšå­ç±»åŒ–ï¼Œä¸Šé¢åŸºç¡€çŸ¥è¯†é‡Œä¹Ÿè¯´è¿‡äº†ã€‚æ²¡é”™ï¼ç”¨ NativeWindow ç±»ã€‚æˆ‘ä»¬åœ¨ CommonDialogHelper é‡Œå†™ä¸€ä¸ªç§æœ‰çš„åµŒå¥—ç±»ï¼Œå‘½åä¸º GroupBoxNativeWindowï¼Œå¹¶è®©å®ƒç»§æ‰¿è‡ª NativeWindowï¼Œå†ç»™å®ƒä¸ªæ„é€ å‡½æ•°ä¼ å…¥ GroupBox å¥æŸ„ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ›å»ºå®ä¾‹å°±å¼€å§‹è¿ä½œã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CommonDialogHelper</span>(<span class="hljs-params">CommonDialog dialog, HOOKPROC hook</span>)</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GroupBoxNativeWindow</span> : <span class="hljs-title">NativeWindow</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GroupBoxNativeWindow</span>(<span class="hljs-params">IntPtr hGroupBox</span>)</span><br>        &#123;<br>            AssignHandle(hGroupBox); <span class="hljs-comment">// è¿™æ˜¯ä½¿ç”¨ NativeWindow å­ç±»åŒ–çš„å¼€å§‹ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ª HWND</span><br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WndProc</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> Message m</span>)</span><br>        &#123;<br>            <span class="hljs-comment">// é‡å†™ WndProcï¼Œæˆ‘ä»¬å°±ç›¸å½“äºè¿›å…¥äº†å­ç±»åŒ–è¿‡ç¨‹</span><br><br>            <span class="hljs-keyword">base</span>.WndProc(<span class="hljs-keyword">ref</span> m);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç”±äºæˆ‘å‘ç°åœ¨éæ‰˜ç®¡ç¯å¢ƒæŒ‰ä¹‹å‰çš„æ€è·¯å®Œå…¨é‡ç»˜ GroupBox ä¼šå¯¼è‡´é—ªçƒï¼Œäºæ˜¯æˆ‘æƒ³åˆ°ä¸€ä¸ªå¾ˆå·§å¦™çš„æ–¹æ³•ï¼š</p>
<p>æˆ‘ä»¬å…ˆè®©å®ƒè‡ªå·±ç”»ï¼Œä¹Ÿå°±æ˜¯ä¿ç•™é»˜è®¤æ ·å¼ï¼Œæ¥ç€æˆ‘ä»¬å°±åªéœ€è¦åœ¨åŸæ¥æ ‡é¢˜æ–‡å­—çš„åœ°æ–¹å†ç”»ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ–‡å­—å°†åŸæœ‰çš„ç›–ä½ï¼Œä¸å°±è¡Œäº†ï¼Ÿ</p>
<p>å¤§è‡´æ­¥éª¤å°±æ˜¯ï¼š</p>
<ul>
<li>æ‹¦æˆª WM_PAINTï¼Œä½†å…ˆè®©å®ƒè‡ªå·±ç”» -&gt; è·å–æ ‡é¢˜ä»¥åŠå­—ä½“ -&gt; è·å– GroupBox æ ‡é¢˜çš„åæ ‡å’Œå¤§å° -&gt; ç”»æ–‡å­—</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> RECT <span class="hljs-comment">// è¿™ä¸ªç»“æ„å†™åœ¨ CommonDialogHelper å¤–é¢</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Left;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Top;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Right;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Bottom;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">Rectangle</span>(<span class="hljs-params">RECT r</span>)</span><br><span class="hljs-function">    <span class="hljs-comment">// æ·»åŠ éšå¼è½¬æ¢ä¸º Rectangle</span></span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Rectangle.FromLTRB(r.Left, r.Top, r.Right, r.Bottom);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CommonDialogHelper</span>(<span class="hljs-params">CommonDialog dialog, HOOKPROC hook</span>)</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GroupBoxNativeWindow</span> : <span class="hljs-title">NativeWindow</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_PAINT = <span class="hljs-number">0x000F</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_GETFONT = <span class="hljs-number">0x0031</span>;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> Handled; <span class="hljs-comment">// ä¸ºäº†é˜²æ­¢å¤šæ¬¡è§¦å‘é‡ç»˜å¯¼è‡´æ–‡å­—é‡å½±ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—æ¥è¡¨ç¤ºæ˜¯å¦å·²ç»ç”»è¿‡ä¸€æ¬¡äº†</span><br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WndProc</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> Message m</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (m.Msg == WM_PAINT)<br>            &#123;<br>                <span class="hljs-keyword">base</span>.WndProc(<span class="hljs-keyword">ref</span> m); <span class="hljs-comment">// å…ˆè®©å®ƒè‡ªå·±ç”»</span><br><br>                <span class="hljs-keyword">if</span> (!Handled) <span class="hljs-comment">// ç¡®ä¿æˆ‘ä»¬åªç”»ä¸€æ¬¡</span><br>                &#123;<br>                    IntPtr hdc;<br>                    IntPtr hWnd = Handle;<br><br>                    <span class="hljs-keyword">if</span> ((hdc = GetWindowDC(hWnd)) != IntPtr.Zero) <span class="hljs-comment">// æ‹¿åˆ° DCï¼Œç”¨äºåˆ›å»º Graphics</span><br>                    &#123;<br>                        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> g = Graphics.FromHdc(hdc);<br>                        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> font = Font.FromHfont(SendMessage(hWnd, WM_GETFONT, IntPtr.Zero, IntPtr.Zero));<br>                        <span class="hljs-comment">// è·å–å­—ä½“</span><br><br>                        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> brush = <span class="hljs-keyword">new</span> SolidBrush(ThemeManager.DarkFore); <span class="hljs-comment">// åˆ›å»ºç”»åˆ·</span><br><br>                        GetClientRect(hWnd, <span class="hljs-keyword">out</span> RECT rc);<br>                        rc.Left += <span class="hljs-number">6</span>; <span class="hljs-comment">// ç”±äºæˆ‘ä»¬æ˜¯è¦†ç›–åŸæ ‡é¢˜ï¼Œå®æµ‹åç§» 6px æœ€ä½³ï¼Œè€Œä¸æ˜¯ä¹‹å‰æˆ‘ä»¬è‡ªç»˜æ‰˜ç®¡ GroupBox çš„ 4px</span><br>                        Rectangle rect = rc; <span class="hljs-comment">// è§¦å‘éšå¼è½¬æ¢ RECT ä¸º Rectangle</span><br>                        <span class="hljs-keyword">var</span> sb = <span class="hljs-keyword">new</span> StringBuilder(GetWindowTextLength(hWnd) + <span class="hljs-number">1</span>); <span class="hljs-comment">// åˆ›å»º Win32 LPWSTR åŠ¨æ€å­—ç¬¦ä¸²çš„ç¼“å†²åŒº</span><br>                        GetWindowText(hWnd, sb, sb.Capacity); <span class="hljs-comment">// è·å– GroupBox çš„æ ‡é¢˜ï¼Œå†™å…¥ç¼“å†²åŒº</span><br>                        g.DrawString(sb.ToString(), font, brush, rect); <span class="hljs-comment">// ToString æ‹¿å‡ºæ ‡é¢˜ï¼Œç„¶åç”»å‡ºæ¥</span><br>                        ReleaseDC(hWnd, hdc); <span class="hljs-comment">// é‡Šæ”¾ DC å ç”¨çš„èµ„æº</span><br>                        Handled = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">base</span>.WndProc(<span class="hljs-keyword">ref</span> m);<br>        &#125;<br><br>        [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>, CharSet = CharSet.Unicode)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetWindowText</span>(<span class="hljs-params">IntPtr hWnd, StringBuilder lpString, <span class="hljs-built_in">int</span> nMaxCount</span>)</span>;<br><br>        [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>, CharSet = CharSet.Unicode)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetWindowTextLength</span>(<span class="hljs-params">IntPtr hWnd</span>)</span>; <span class="hljs-comment">// è·å–çª—å£æ ‡é¢˜çš„å­—ç¬¦ä¸²çš„é•¿åº¦</span><br><br>        [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">ReleaseDC</span>(<span class="hljs-params">IntPtr hWnd, IntPtr hDC</span>)</span>;<br><br>        [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br>        [<span class="hljs-meta">return: MarshalAs(UnmanagedType.Bool)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">GetClientRect</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-keyword">out</span> RECT lpRect</span>)</span>; <span class="hljs-comment">// è·å–çª—å£çš„ ClientRectangle</span><br><br>        [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">GetWindowDC</span>(<span class="hljs-params">IntPtr hWnd</span>)</span>; <span class="hljs-comment">// è·å–çª—å£çš„è®¾å¤‡ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸ç”¨äºç»˜å›¾</span><br><br>        [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">SendMessage</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬çš„å­ç±»åŒ–å·²ç»å®Œæˆäº†ï¼Œå°±å·®è·å–é‚£ä¸ª GroupBox çš„å¥æŸ„äº†ã€‚è¿™è²Œä¼¼åˆæœ‰ç‚¹æŒ‘æˆ˜ï¼Œæ€ä¹ˆè·å–ï¼Ÿ</p>
<p>ä½ å¯èƒ½ä¼šæƒ³åˆ° FindWindow(Ex) å‡½æ•°ï¼ŒæŒ‡å®šçª—å£æ ‡é¢˜æ¥è·å– HWNDï¼Œè¿™åœ¨é€»è¾‘ä¸Šè¯´å¾—è¿‡å»ã€‚ä½†æ˜¯ä½ æƒ³è¿‡ i18n å—ï¼Ÿå°±æ¯”å¦‚æˆ‘ä½¿ç”¨çš„è‹±æ–‡ç‰ˆç³»ç»Ÿä¸­ï¼Œè¿™ä¸ª GroupBox çš„æ ‡é¢˜æ˜¯ Sampleï¼Œä¸­æ–‡ç³»ç»Ÿä¸­æ˜¯ ç¤ºä¾‹ï¼Œé‚£ä½ è¯¥æ€ä¹ˆåŠï¼Ÿä½ å¯èƒ½æƒ³ï¼Œé‚£æˆ‘ä»¬å…ˆè·å–æ ‡é¢˜ï¼Œå†è·å–å¥æŸ„ä¸å°±è¡Œäº†ï¼Ÿæ³¨æ„ï¼Œæˆ‘ä»¬è¦è·å– GroupBox çš„æ ‡é¢˜æœ¬æ¥å°±è¦å…ˆè·å–å®ƒå¥æŸ„ã€‚</p>
<p>æ‰€ä»¥ä½ å‘ç°æ²¡æœ‰ï¼Œä»¥ä¸Šè¿™æ¡è·¯æ˜¯è¡Œä¸é€šçš„ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿæ–‡æ¡£ï¼</p>
<p>æ‰“å¼€æœç´¢å¼•æ“ï¼Œæœç´¢ <code>win32 get dialog control handle</code>ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ï¼š</p>
<p><img src="/../archive-imgs/38/44-google-getdlgitem.png" srcset="/img/loading.gif" lazyload></p>
<p>æ‰€ä»¥è¯´å‘€ï¼Œâ€é«˜ä¸­è®¡ç®—æœºå­¦çš„å…³é”®è¯å¤§æ³•â€+â€è‹±æ–‡æ£€ç´¢â€ çœŸçš„èƒ½åœ¨å¾ˆå¤šæ—¶å€™ç§’æœå‡ºä½ æƒ³è¦çš„ã€‚</p>
<p>ç›´æ¥ä¸€ä¸ªå¯¼å…¥</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">GetDlgItem</span>(<span class="hljs-params">IntPtr hDlg, <span class="hljs-built_in">int</span> nIDDlgItem</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>ä½†è¿™åˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªå‡½æ•°çš„åŸç†æ˜¯æŒ‡å®šå¯¹è¯æ¡†çš„ HWND å’Œæ§ä»¶çš„ ID å°±èƒ½è·å–åˆ°æ§ä»¶ HWNDï¼Œå‰è€…æˆ‘ä»¬å¯ä»¥è·å–å¾—åˆ°ï¼Œé‚£åè€…å‘¢ï¼Ÿå¯æ¶çš„æ˜¯æ–‡æ¡£é‡Œå±…ç„¶ä¹Ÿæ²¡å†™å“ªé‡Œæœ‰ IDã€‚</p>
<p>é€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼Œåœ¨ Windows SDK ä¸­ï¼ŒåŒ…å«äº† FontDialog çš„æ¨¡æ¿ (Font.Dlg) ä»¥åŠæ‰€æœ‰çš„ Common Dialogs çš„æ§ä»¶çš„ ID (dlgs.h)ã€‚é‚£æˆ‘ä»¬ç›´æ¥ Everything æœç´¢å‡ºæ¥æ‰“å¼€å°±è¡Œäº†ã€‚</p>
<p>å…ˆæ‰“å¼€ Font.Dlg çœ‹çœ‹è¿™ä¸ª GroupBox çš„ ID æ˜¯ä»€ä¹ˆï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">GROUPBOX        <span class="hljs-string">&quot;Sample&quot;</span>, grp2, <span class="hljs-number">110</span>, <span class="hljs-number">97</span>, <span class="hljs-number">116</span>, <span class="hljs-number">43</span>, WS_GROUP <br><span class="hljs-comment">// æ ¹æ®ç±»å‹ï¼Œä»¥åŠè®¾ç½®çš„æ–‡æœ¬æˆ‘ä»¬å°±èƒ½ç¡®å®šè¯¥æ§ä»¶</span><br></code></pre></td></tr></table></figure>
<p>å¥½çš„ï¼Œå®ƒçš„ ID æ˜¯ grp2ï¼Œé‚£ä¹ˆè¿™ä¸ª ID çš„å…·ä½“å€¼æ˜¯ä»€ä¹ˆï¼Ÿæ¥ç€æ‰“å¼€ dlgs.hï¼Œç›´æ¥ Ctrl+F é€šç¼‰ grp2</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> grp2        0x0431</span><br></code></pre></td></tr></table></figure>
<p>çœ‹åˆ°æ²¡ï¼Œè¿™ä¸å°±å‡ºæ¥äº†ã€‚</p>
<p>é‚£æˆ‘ä»¬ç°åœ¨å°±å¯ä»¥åœ¨ WM_INITDIALOG é‡Œé¢å¯¹å®ƒè¿›è¡Œå­ç±»åŒ–äº†ï¼Œä½†å¾—å…ˆç¡®ä¿åˆå§‹åŒ– CommonDialogHelper çš„æ˜¯ MyFontDialog (å…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨ï¼Œå› ä¸ºæ§ä»¶ ID æ˜¯å”¯ä¸€çš„)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (msg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_INITDIALOG:<br><br>            <span class="hljs-keyword">if</span> (CanUseDarkTheme)<br>            &#123;<br>                <span class="hljs-comment">// ...</span><br><br>                <span class="hljs-keyword">if</span> (dialog <span class="hljs-keyword">is</span> MyFontDialog) <span class="hljs-comment">// éªŒè¯å½“å‰å¯¹è¯æ¡†æ˜¯ä¸æ˜¯ MyFontDialog</span><br>                &#123;<br>                    IntPtr hCtrl = GetDlgItem(hWnd, <span class="hljs-number">0x0431</span>);<br><br>                    <span class="hljs-keyword">if</span> (hCtrl != IntPtr.Zero) <span class="hljs-comment">// æœ€åä¸€é“ä¿é™©ï¼Œç¡®ä¿å·²è·å–åˆ° HWND</span><br>                    &#123;<br>                        <span class="hljs-keyword">new</span> GroupBoxNativeWindow(hCtrl); <span class="hljs-comment">// å¯åŠ¨å­ç±»åŒ–</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> IntPtr.Zero;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹æ•ˆæœ</p>
<p><img src="/../archive-imgs/38/45-dark-fontdialog-2.png" srcset="/img/loading.gif" lazyload></p>
<p>éå¸¸å®Œç¾ (é™¤äº†é‚£å‡ ä¸ªç™½è‰²çš„å®åœ¨æ²¡æ³•)</p>
<p>ä½†è¿˜æ²¡å®Œï¼Œè¿˜è®°å¾—æˆ‘ä»¬åœ¨é‡å†™è¿™ä¸¤ç§å¯¹è¯æ¡†çš„ HookProc å—ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›äº† Helper çš„ HookProcï¼Œé‚£é»˜è®¤çš„ HookProc å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¿˜è¦è¡¥å…¨ switch åˆ†æ”¯ï¼Œè¿™é‡Œæˆ‘ä¸å»ºè®®åœ¨æŸäº›æ¶ˆæ¯ä¸­è¿”å›é»˜è®¤çš„ HookProcï¼Œè€Œæ˜¯å‚è€ƒ CommonDialog æºç ï¼Œè‡ªå·±å†™ä¸€é</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_SETFOCUS = <span class="hljs-number">0x0007</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> WM_COMMAND = <span class="hljs-number">0x0111</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (msg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_SETFOCUS:<br>            SetFocus(wParam);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> WM_INITDIALOG:<br>            <span class="hljs-comment">// ...</span><br>            PostMessage(hWnd, WM_SETFOCUS, IntPtr.Zero, IntPtr.Zero);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORDLG:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLOREDIT:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORSTATIC:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORLISTBOX:<br>        <span class="hljs-keyword">case</span> WM_CTLCOLORBTN:<br>            <span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> WM_COMMAND:<br>            <span class="hljs-keyword">return</span> hook(hWnd, WM_COMMAND, wParam, lParam);<br>            <span class="hljs-comment">// è¿™æ˜¯å®ç°å¯¹è¯æ¡†ä¸€äº›å…¶ä»–åŠŸèƒ½çš„å…³é”®æ‰€åœ¨ï¼Œè¿™é‡Œè°ƒç”¨é»˜è®¤çš„ HookProc å¤„ç†</span><br>        <span class="hljs-keyword">case</span> WM_DESTROY:<br>            DeleteObject(hBrush); <span class="hljs-comment">// åˆ«å¿˜äº†åˆ é™¤é‚£ä¸ªç”»åˆ·å ç”¨çš„èµ„æº</span><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> IntPtr.Zero;<br>&#125;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">SetFocus</span>(<span class="hljs-params">IntPtr hWnd</span>)</span>;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">PostMessage</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>çœ‹çœ‹æ•ˆæœ</p>
<p><img src="/../archive-imgs/38/46-helper-soe.png" srcset="/img/loading.gif" lazyload></p>
<p>è¯¶è¯¶è¯¶ï¼Œæ€ä¹ˆå †æ ˆæº¢å‡ºäº†ï¼Ÿ</p>
<p>è¿™ä¸ªå¼‚å¸¸æ˜¯æˆ‘ä»¬åœ¨è¡¥å…¨ switch ä¹‹åæŠ›å‡ºçš„ï¼Œè™½ç„¶ Visual Studio æŠŠé”™è¯¯å®šä½åœ¨ CanUseDarkTheme ä¸Šï¼Œä½†æˆ‘è§‰å¾—ä¸æ˜¯è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨è¿™ä¹‹å‰éƒ½æ˜¯å¯ä»¥çš„ã€‚</p>
<p>é‚£å°±ä»æˆ‘ä»¬æ·»åŠ çš„å†…å®¹ä¸­ä¸€ä¸ªä¸ªæ’æŸ¥ï¼š</p>
<ul>
<li>SetFocus å¯èƒ½å¼•å‘è¯¥å¼‚å¸¸å—ï¼Ÿä¸ä¼šã€‚</li>
<li>PostMessage å‘¢ï¼Ÿä¸ä¼šã€‚</li>
<li>hook(hWnd, WM_COMMAND, wParam, lParam) å‘¢ï¼Ÿè²Œä¼¼ä¹Ÿä¸ä¼š</li>
<li>DeleteObject(hBrush) å°±æ›´ä¸ä¼šäº†</li>
</ul>
<p>é‚£é—®é¢˜è‚¯å®šå°±å‡ºåœ¨ hook è¿™ä¸ªå‚æ•°ä¸Šäº†ï¼Œå®ƒæ˜¯æˆ‘ä»¬ Helper çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥å°è£…é»˜è®¤ HookProc çš„ã€‚</p>
<p>æ¥çœ‹çœ‹æˆ‘ä»¬æ˜¯æ€ä¹ˆåˆå§‹åŒ– Helper çš„ï¼Œåœ¨ MyFontDialog å’Œ MyColorDialog é‡Œï¼Œæˆ‘ä»¬éƒ½ç”¨åˆ°äº†åŒæ ·çš„ä»£ç </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">new</span> DialogResult <span class="hljs-title">ShowDialog</span>()</span><br>&#123;<br>    Helper = <span class="hljs-keyword">new</span> CommonDialogHelper(<span class="hljs-keyword">this</span>, HookProc);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.ShowDialog();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘è¯´é—®é¢˜å°±åœ¨è¿™é‡Œï¼Œä½ å‘ç°äº†å—ï¼Ÿ</p>
<p>æ²¡æœ‰ï¼Ÿé‚£æˆ‘è¯·é—® HookProc æ˜¯é»˜è®¤çš„ HookProc å—ï¼Ÿ</p>
<p>è‚¯å®šä¸æ˜¯å•Šï¼Œè¿™é‡Œéšå¼åŒ…å«äº† this å…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æŠŠæˆ‘ä»¬é‡å†™çš„ HookProc ç»™ä¼ è¿›å»äº†ï¼Œç„¶åæˆ‘ä»¬çš„ HookProc åˆå»è°ƒç”¨ Helper çš„ HookProcï¼Œèµ°åˆ° WM_COMMAND æ—¶ï¼Œåˆæ¥è°ƒç”¨æˆ‘ä»¬é‡å†™çš„ HookProcï¼Œç„¶ååˆè¿›åˆ° Helper é‡Œçš„ HookProcï¼Œâ€¦â€¦</p>
<p>æ˜¯ä¸æ˜¯è¿™ä¸ªå°±æ˜¯å¯¼è‡´å †æ ˆæº¢å‡ºçš„ç½ªé­ç¥¸é¦–ï¼Œå¯¹å˜›ï¼Œä¸¤ä¸ªæ–¹æ³•ï¼Œä½ è°ƒç”¨æˆ‘ï¼Œæˆ‘è°ƒç”¨ä½ ï¼Œé‚£å’±è°ä¹Ÿåˆ«æƒ³è·³å‡ºå»äº†ã€‚é‚£æ­£ç¡®çš„å†™æ³•æ˜¯ä»€ä¹ˆï¼Ÿâ€”â€” åŠ ä¸Š base å…³é”®å­—</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">new</span> DialogResult <span class="hljs-title">ShowDialog</span>()</span><br>&#123;<br>    Helper = <span class="hljs-keyword">new</span> CommonDialogHelper(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">base</span>.HookProc);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.ShowDialog();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å†æ¥è¿è¡Œçœ‹çœ‹ï¼Œéå¸¸å¥½ï¼Œæ²¡é”™äº†ã€‚</p>
<p>é‚£æœ¬æ–‡å°±åˆ°è¿™é‡Œï¼Œä¸‹æœŸå†è§~</p>
<h2 id="å¯èƒ½çš„ç–‘é—®"><a href="#å¯èƒ½çš„ç–‘é—®" class="headerlink" title="å¯èƒ½çš„ç–‘é—®"></a>å¯èƒ½çš„ç–‘é—®</h2><h3 id="ä¸ºä»€ä¹ˆè¦åœ¨-OnHandleCreated-æ–¹æ³•é‡Œé¢è°ƒç”¨-APIï¼Œä¸èƒ½åœ¨æ„é€ å‡½æ•°é‡Œé¢å—ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦åœ¨-OnHandleCreated-æ–¹æ³•é‡Œé¢è°ƒç”¨-APIï¼Œä¸èƒ½åœ¨æ„é€ å‡½æ•°é‡Œé¢å—ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦åœ¨ OnHandleCreated æ–¹æ³•é‡Œé¢è°ƒç”¨ APIï¼Œä¸èƒ½åœ¨æ„é€ å‡½æ•°é‡Œé¢å—ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦åœ¨ OnHandleCreated æ–¹æ³•é‡Œé¢è°ƒç”¨ APIï¼Œä¸èƒ½åœ¨æ„é€ å‡½æ•°é‡Œé¢å—ï¼Ÿ</h3><ol>
<li>ä¸ºäº†é¿å…æœ‰æ—¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦é‡ç»˜å¯¼è‡´å¥æŸ„ä¹Ÿé‡æ–°åˆ›å»ºçš„æç«¯æƒ…å†µï¼Œæ‰€æœ‰æ¨èæœ€å¥½åœ¨ OnHandleCreated é‡Œè°ƒç”¨ APIï¼Œä¸ç„¶ä¸€æ—¦å¥æŸ„é‡æ–°åˆ›å»ºï¼Œä¸»é¢˜å°±æ²¡äº†ã€‚</li>
<li>æ­¤æ—¶è·å–å¥æŸ„æ˜¯æœ€å¥½çš„ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­è·å–å¥æŸ„ä¼šå¯¼è‡´å…¶æå‰è¢«åˆ›å»ºï¼Œå¯èƒ½ä¼šæœ‰æ½œåœ¨çš„åæœã€‚</li>
</ol>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ç”±äºåŸç”Ÿæ·±è‰²ä¸»é¢˜æ˜¯ç³»ç»Ÿè‡ªå¸¦çš„åŠŸèƒ½ï¼Œæ‰€ä»¥åªè¦ä½ çš„çª—å£æ¡†æ¶æˆ–æ§ä»¶éƒ½æ˜¯åŸç”Ÿç±»å‹çš„è¯ï¼Œç†è®ºä¸Šä¸å…‰ C# å¯ä»¥ï¼Œå…¶ä»–ç¼–ç¨‹è¯­è¨€æ¯”å¦‚ C&#x2F;C++ ç­‰ä¹Ÿå¯ä»¥å®ç°åŸç”Ÿæ·±è‰²ä¸»é¢˜ã€‚</p>
<h2 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h2><ul>
<li>Win32 Dark Mode<br><a target="_blank" rel="noopener" href="https://gist.github.com/rounk-ctrl/b04e5622e30e0d62956870d5c22b7017">https://gist.github.com/rounk-ctrl/b04e5622e30e0d62956870d5c22b7017</a></li>
<li>ysc3839&#x2F;win32-darkmode: Example application shows how to use undocumented dark mode API introduced in Windows 10 1809.<br><a target="_blank" rel="noopener" href="https://github.com/ysc3839/win32-darkmode">https://github.com/ysc3839/win32-darkmode</a></li>
<li>BlueMystical&#x2F;Dark-Mode-Forms: Apply Dark Mode to all Controls in a Form [WinForms]<br><a target="_blank" rel="noopener" href="https://github.com/BlueMystical/Dark-Mode-Forms">https://github.com/BlueMystical/Dark-Mode-Forms</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Windows/" class="print-no-link">#Windows</a>
      
        <a href="/tags/CSharp/" class="print-no-link">#CSharp</a>
      
        <a href="/tags/WinForms/" class="print-no-link">#WinForms</a>
      
        <a href="/tags/Cpp/" class="print-no-link">#Cpp</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ä»é›¶å¼€å§‹è®©ä½ çš„ WinForms åº”ç”¨ç¨‹åºä¹Ÿç”¨ä¸ŠåŸç”Ÿæ·±è‰²ä¸»é¢˜</div>
      <div>https://wanghaonie.github.io/posts/00d12b183e8c/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>WangHaonie</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2025-07-23 08:31:03</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2025-07-24 14:44:33</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - éå•†ä¸šæ€§ä½¿ç”¨">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - ç›¸åŒæ–¹å¼å…±äº«">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/d1afa7a5de7f/" title="ã€C#ã€‘for å’Œ foreach å¾ªç¯çš„é€‰æ‹©">
                        <span class="hidden-mobile">ã€C#ã€‘for å’Œ foreach å¾ªç¯çš„é€‰æ‹©</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span> Hexo </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span> Fluid </span></a><br> <div><a> <span id="site-runtime">æ­£åœ¨åŠ è½½ç½‘ç«™è¿è¡Œæ—¶é—´ï¼Œè¯·ç¨å€™...</span> <script src="/js/runtime.js"></script> </a></div> 
    </div>
  
  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a rel="nofollow noopener">
      Copyright Â© 2023-2025 WangHaonie
    </a>
  </span>
  
    
      <span>
        <a
          href="https://icp.gov.moe/?keyword=20229939"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/icon_moeicp.png" srcset="/img/loading.gif" lazyload/>
          
          <span>èŒICPå¤‡20229939å·</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>




  
<script src="/js/customstyles.js"></script>
<script src="/js/subsiteredirect.js"></script>
<script src="/js/bgribbon.js"></script>
<script src="/js/curfireworks.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
