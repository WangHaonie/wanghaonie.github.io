

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="WangHaonie">
  <meta name="keywords" content="">
  
    <meta name="description" content="文章较长，请耐心阅读~ 文章还没写完呢，敬请期待  前言如果你不喜欢 WinForms 仅仅是因为它不支持深色主题的话，那一定要看看这篇文章。要注意的是：  最新版 .NET 貌似已经支持深色模式，但本文只针对低版本 .NET； 推荐有一定 Win32&amp;#x2F;C++ 编程经验的朋友们阅读，没有也没关系，很简单的； 原生深色主题作用范围有限 (毕竟不是公开的)，不能达到 100% 覆盖，且仅支持">
  
  
  
  <title>从零开始让你的 WinForms 应用程序也用上原生深色主题 | WangHaonie 的博客</title>
  <link rel="stylesheet" href="/css/frosted.css">
  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wanghaonie.github.io","root":"/","version":"1.9.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true,"scope":"home"},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":"G-N644FC8JLJ"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-N644FC8JLJ", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-N644FC8JLJ');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WangHaonie 的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span id="wanghaonie-nav" candidate-icon="🧿🔔📅🚩🧡">🎉更多</span>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                
                <span>🏠主页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                
                <span>😁关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                
                <span>🏷️标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                
                <span>📖文章</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                
                <span>🌏分站</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2gh()" href="#" target="_self">
                    
                    <span>🌎主站：GitHub Pages</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2lan()" href="#" target="_self">
                    
                    <span>🌎主站：本地局域网</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2v()" href="#" target="_self">
                    
                    <span>🌎分站：Vercel</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" onclick="redir2n()" href="#" target="_self">
                    
                    <span>🌎分站：Netlify</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/reward" target="_self">
                
                <span>💰打赏</span>
              </a>
            </li>
          
        <!--
        -->
        <!--
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        -->
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" false
     style="background: url('/null') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">从零开始让你的 WinForms 应用程序也用上原生深色主题</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-23 08:31" pubdate>
          2025-07-23 08:31:03
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          43 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">从零开始让你的 WinForms 应用程序也用上原生深色主题</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：几秒前
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p class="note note-danger">文章较长，请耐心阅读~</p>
<p class="note note-warning">文章还没写完呢，敬请期待</p>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果你不喜欢 WinForms 仅仅是因为它不支持深色主题的话，那一定要看看这篇文章。要注意的是：</p>
<ul>
<li>最新版 .NET 貌似已经支持深色模式，但本文只针对低版本 .NET；</li>
<li>推荐有一定 Win32&#x2F;C++ 编程经验的朋友们阅读，没有也没关系，很简单的；</li>
<li>原生深色主题作用范围有限 (毕竟不是公开的)，不能达到 100% 覆盖，且仅支持 <strong>Windows 10 1903 及以上</strong> 系统。本文将对以下类型的控件的深色主题进行讨论，其他控件请自行尝试 <strong>套用类似的方法</strong> 或者 <strong>查阅相关资料</strong> 或者 <strong>直接使用第三方 UI 库</strong> 或者 <strong>转向 WPF</strong> 或者 <strong>放弃</strong>。😅</li>
<li>理论上来说深色主题支持热重载，即在运行时开启或关闭深色主题。但我不推荐，我采用的是用户更改主题时询问是否重启应用程序，若你有需求也可以尝试一下。</li>
<li>以下所有详细实现都能在 <a target="_blank" rel="noopener" href="https://github.com/WangHaonie/PlainCEETimer">PlainCEETimer</a> 中找到。</li>
</ul>
<h2 id="支持的控件"><a href="#支持的控件" class="headerlink" title="支持的控件"></a>支持的控件</h2><h3 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h3><p>修改 <code>ForeColor</code> 和 <code>BackColor</code> 属性就能实现。</p>
<ul>
<li>Form (除标题栏以外)</li>
<li>Panel</li>
<li>GroupBox (除标题以外)</li>
<li>Label (跟随父容器自动适应)</li>
<li>LinkLabel (跟随父容器自动适应)</li>
<li>PictureBox (跟随父容器自动适应)</li>
</ul>
<h3 id="原生支持"><a href="#原生支持" class="headerlink" title="原生支持"></a>原生支持</h3><p>调用 Win32 API 即可实现。</p>
<ul>
<li>Form (标题栏)</li>
<li>ContextMenu</li>
<li>Button</li>
<li>TextBox</li>
<li>CheckBox</li>
<li>RadioButton</li>
<li>ComboBox</li>
<li>TreeView</li>
<li>NumericUpDown</li>
<li>ListView (列表部分)</li>
<li><del>TabControl</del> (换用 TreeView)</li>
<li><del>ContextMenuStrip</del> (换用 ContextMenu)</li>
</ul>
<h3 id="自绘实现"><a href="#自绘实现" class="headerlink" title="自绘实现"></a>自绘实现</h3><p>重写 <code>OnPaint</code> 等方法才能实现</p>
<ul>
<li>GroupBox</li>
</ul>
<h3 id="Hook-实现"><a href="#Hook-实现" class="headerlink" title="Hook 实现"></a>Hook 实现</h3><ul>
<li>重写 <code>HookProc</code> 拦截相关消息即可实现<ul>
<li>ColorDialog</li>
<li>FontDialog</li>
</ul>
</li>
<li>子类化即可实现<ul>
<li>ListView (列表头)</li>
</ul>
</li>
<li>需要借助 IAT Hook 才能实现<ul>
<li>ScrollBar</li>
</ul>
</li>
</ul>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="窗口句柄"><a href="#窗口句柄" class="headerlink" title="窗口句柄"></a>窗口句柄</h3><p>窗口句柄 (hWnd, Handle of Window)，可以理解为用于表示窗口的一种唯一标识符，所有的控件和窗口在创建时都会被分配一个全新的 HWND，有了它我们就可以在上面进行一切我们想做的事情。它在 Win32 中类型为 HWND，在 C# WinForms 中对应实现了 IWin32Window 的对象的 Handle 属性，类型为 IntPtr。</p>
<p>另外，Win32 中 窗口 和 控件 的概念是模糊的，也就是说 控件即窗口，窗口即控件。这也就是为什么 WinForms 里 Form 和其他大多数控件都继承自 Control？因为 WinForms 本质就是对 Win32 的封装，类似于 MFC，架构什么的肯定要与 Win32 一致。</p>
<p>不过只要有了 HWND，我们就能得知对方究竟是窗口还是控件。</p>
<h3 id="消息循环"><a href="#消息循环" class="headerlink" title="消息循环"></a>消息循环</h3><p>消息循环是 Win32 中每个控件的核心。有了它，控件才能获取系统、用户对它的指示，从而做出相应的回应。</p>
<p>消息的载体在 Win32 和 WinForms 中都被定义为 MSG&#x2F;Message 类型，它是一种结构体 (struct)，主要字段有：</p>
<table>
<thead>
<tr>
<th>Win32 声明</th>
<th>WinForms 声明</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>HWND hwnd</td>
<td>IntPtr HWnd</td>
<td>消息接收方的句柄</td>
</tr>
<tr>
<td>UINT message</td>
<td>int Msg</td>
<td>消息编号，区分是什么消息</td>
</tr>
<tr>
<td>WPARAM wParam</td>
<td>IntPtr WParam</td>
<td>可大致理解为附加的小型数据</td>
</tr>
<tr>
<td>LPARAM lParam</td>
<td>IntPtr LParam</td>
<td>可大致理解为附加的大型数据</td>
</tr>
<tr>
<td>&lt;消息函数返回值&gt;</td>
<td>IntPtr Result</td>
<td>该消息的处理结果</td>
</tr>
</tbody></table>
<p>你可能注意到 消息编号 在 Win32 是 UINT (C# 里也有 uint)，在 WinForms 里是 int，难道不会出错吗？</p>
<p>这个问题我只能说 Win32 里多半又是什么历史遗留下来的原因，才用 UINT。但可以肯定的是，Win32 使用的消息，范围都不会超出 int 的最大值，而在 C# 中 int 又是很常用的类型，所以就理所当然的变成了 int，这样也不会溢出。</p>
<h3 id="窗口过程"><a href="#窗口过程" class="headerlink" title="窗口过程"></a>窗口过程</h3><p>窗口过程 (WndProc, Window Procedure)，就是该窗口用于处理消息的 “工厂”，在 Win32 里对应 WNDPROC，他一般长这个样子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">LRESULT CALLBACK <span class="hljs-title">WndProc</span><span class="hljs-params">(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (uMsg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_CREATE:<br>            <span class="hljs-comment">// 准备创建窗口</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 表示已被处理</span><br><br>        <span class="hljs-comment">// 其他消息</span><br><br>        <span class="hljs-keyword">case</span> WM_DESTROY:<br>            <span class="hljs-comment">// 窗口已销毁</span><br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 跳出 switch，走外面的语句</span><br><br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">DefWindowProc</span>(hWnd, uMsg, wParam, lParam); <span class="hljs-comment">// 让默认的消息函数处理上方未处理的消息</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 被 break 跳到这里</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 WinForms 里，他长这个样子：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WndProc</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> Message m</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (m.Msg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_CREATE:<br>            <span class="hljs-comment">// 准备创建窗口</span><br>            m.Result = IntPtr.Zero; <span class="hljs-comment">// 表示已被处理</span><br>            <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-comment">// 其他消息</span><br><br>        <span class="hljs-keyword">case</span> WM_DESTROY:<br>            <span class="hljs-comment">// 窗口已销毁</span><br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 跳出 switch，走外面的语句</span><br><br>        <span class="hljs-literal">default</span>:<br>            m.Result = DefWindowProc(hWnd, uMsg, wParam, lParam); <span class="hljs-comment">// 让默认的消息函数处理上方未处理的消息</span><br>            <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    m.Result = IntPtr.Zero; <span class="hljs-comment">// 被 break 跳到这里</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>可见尽管两者的函数签名不同，但内部都干着同样的事，当然以上代码仅供参考，实际会比这更复杂。</p>
<h3 id="钩子过程"><a href="#钩子过程" class="headerlink" title="钩子过程"></a>钩子过程</h3><p>钩子过程 (HookProc, Hook Procedure) 有两种含义，一是通过 SetWindowsHookEx 函数设置的全局钩子，二是 Common Dialogs 的 ColorDialog、FontDialog 模板 (CHOOSECOLOR、CHOOSEFONT) 提供的一个私有的类似于 WndProc 的东西，仅供自己使用，与前者是两个不同的概念。本文主要讨论后者。</p>
<p>在 WinForms 里，它通常长这个样子，非常类似于 Win32 的 WndProc</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> IntPtr <span class="hljs-title">HookProc</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> msg, IntPtr wparam, IntPtr lparam</span>)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (msg)<br>	&#123;<br>        <span class="hljs-comment">// ... 处理各消息</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> IntPtr.Zero; <span class="hljs-comment">// 表示已处理</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="子类化"><a href="#子类化" class="headerlink" title="子类化"></a>子类化</h3><p>子类化 (Subclassing) 的作用有点类似于钩子，只不过它多用于钩住窗口中的子控件。在通常用于无法通过常规手段更改控件样式时使用。</p>
<p>因为上面说了，每个控件&#x2F;窗口都有一个独立的 WndProc，而我们在窗口中处理控件样式时只能获取到本窗体的 WndProc，虽然能收到一些发送给控件的消息，但有关控件样式的消息就必须拦截控件自己的 WndProc，所以 子类化 就相当于在窗口中监听所有系统发送给控件的消息 (因为系统给控件发送消息不会经过所在窗体的 WndProc)，从而进行更多自定义的功能。</p>
<p>在 Win32 中，我们通常使用 CommCtrl.h 提供的 SetWindowSubclass 和 RemoveWindowSubclass 来对窗体进行&#x2F;移除子类化。</p>
<p>但在 WinForms 中，我们不需要导入这两个函数来子类化，.NET 为我们提供了类似子类化的功能，叫 NativeWindow 类。它继承自 Component，是对 Win32 窗口的低级封装 (只提供 WndProc，不提供或提供少量其他功能就叫低级封装)，也就是传入 句柄 给 NativeWindow，我们相当于获取到了目标窗口的实例，而这个类也提供了 WndProc 虚方法，可供我们重写，来达到子类化的效果。</p>
<h3 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h3><p>调用约定 (CallingConvention) 简单理解以下就行了，就是调用本机函数的方式 (好比你上网的方式，WiFi，移动数据等，但不用纠结有什么区别，保持一致就行)，WinAPI 默认就是 StdCall，C# 里 Interop 的 [DllImport] 默认也是 StdCall，后面我们导出函数也要声明为 StdCall。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="安装-C-工具集-v143"><a href="#安装-C-工具集-v143" class="headerlink" title="安装 C++ (工具集 v143)"></a>安装 C++ (工具集 v143)</h3><p>某些 Interop，我们交给 C++ 会更好，用 C# 的话过于麻烦甚至无法完成。所以需要用到 C++，安装方法可以到网上查询，记得安装 Windows 11 SDK (10.0.22621.0)。</p>
<p class="note note-warning">不要觉得难以维护什么的，毕竟需要同时编写 C# 和 C++，要知道 "工欲善其事，必先利其器"，这些都是写好一个软件的关键，有助于增强用户体验的我们怎么能不做呢？Visual Studio 里一个解决方案多个项目的也不少见，难道不是吗？</p>

<p>右键<strong>解决方案</strong>，选择 添加 &gt;新项目</p>
<p><img src="/../archive-imgs/38/2-create-cpp-dll-pre.png" srcset="/img/loading.gif" lazyload></p>
<p>找到 动态链接库 (C++)</p>
<p><img src="/archive-imgs/38/2-create-cpp-dll.png" srcset="/img/loading.gif" lazyload></p>
<p>命名为 <code>MyApp.Natives</code> 然后创建就行了，这样我们的解决方案里就有两个项目了。</p>
<p><img src="/archive-imgs/38/3-cs-cpp-proj.png" srcset="/img/loading.gif" lazyload></p>
<p>接着把 C++ 项目设置为 C# 的依赖项，可以使我们编译 C# 时，先编译 C++：右键 C# 项目，选择 构建依赖 &gt;项目依赖<br><img src="/archive-imgs/38/4-assoc-cs-to-cpp.png" srcset="/img/loading.gif" lazyload></p>
<p>把 C++ 项目勾选上<br><img src="/archive-imgs/38/5-assoc-cs-to-cpp-dep.png" srcset="/img/loading.gif" lazyload></p>
<p>当然这也要求两个项目的输出目录是一样的，这里我就只设置 C++ 了，因为 C# 的设置过了。右键 C++ 项目选择属性，第一个页面就是<br><img src="/archive-imgs/38/6-set-cpp-out-dir.png" srcset="/img/loading.gif" lazyload></p>
<p>为了后面编译 C++ 不会错误，我们先设置链接器。</p>
<p>右键 C++ 项目选择属性 &gt;链接器 &gt;输入 &gt;编辑</p>
<p><img src="/archive-imgs/38/7-cpp-linker.png" srcset="/img/loading.gif" lazyload></p>
<p>填入这两个静态链接库，注意不要删上面的那两个，最后点击保存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">uxtheme.lib<br>comctl32.lib<br>ucrt.lib<br></code></pre></td></tr></table></figure>

<p><img src="/archive-imgs/38/8-edit-cpp-linker.png" srcset="/img/loading.gif" lazyload></p>
<p>然后找到这个 dllmain.cpp，右键把它删除，因为我们主要用于导出函数供 C# 调用，不需要指定入口</p>
<p><img src="/../archive-imgs/38/17-del-cppdll-main.png" srcset="/img/loading.gif" lazyload></p>
<p>接着打开 pch.h，我们添加一个宏定义，方便我们导出调用约定为 StdCall 的函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> cexport(type) extern <span class="hljs-string">&quot;C&quot;</span> __declspec(dllexport) type WINAPI</span><br></code></pre></td></tr></table></figure>

<p><img src="/../archive-imgs/38/18-add-cpp-export-macro.png" srcset="/img/loading.gif" lazyload></p>
<p>大概就先这样，后面要用。</p>
<h3 id="C-版本"><a href="#C-版本" class="headerlink" title="C# 版本"></a>C# 版本</h3><p>由于面向 .NET Framework 4.8 或其他版本，且本文部分代码使用新特性写着比较舒服，建议将 C# 版本升级到 preview。</p>
<p>VSCode 或记事本打开项目文件 <code>XXX.csproj</code>，更改以下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Project</span> <span class="hljs-attr">ToolsVersion</span>=<span class="hljs-string">&quot;15.0&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Import</span> <span class="hljs-attr">Project</span>=<span class="hljs-string">&quot;$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props&quot;</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;Exists(&#x27;$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props&#x27;)&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>preview<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span> <span class="hljs-comment">&lt;!-- 新建一个 PropertyGroup 加入这行 --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;&#x27;$(Configuration)|$(Platform)&#x27; == &#x27;Debug|x64&#x27;&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>7.3<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span> <span class="hljs-comment">&lt;!-- 删除这行 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;&#x27;$(Configuration)|$(Platform)&#x27; == &#x27;Release|x64&#x27;&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>7.3<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span> <span class="hljs-comment">&lt;!-- 删除这行 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- ... --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- ... --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="应用程序清单文件"><a href="#应用程序清单文件" class="headerlink" title="应用程序清单文件"></a>应用程序清单文件</h3><p>用于确保我们可以正确获取到当前系统版本 (微软的吊特性)，可以在 Visual Studio 右键 C# 项目的 Properties 文件夹，点击添加，选择 <code>应用程序清单 (仅 Windows)</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">assembly</span> <span class="hljs-attr">manifestVersion</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v1&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">assemblyIdentity</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0.0&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;MyApplication.app&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">compatibility</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:compatibility.v1&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;35138b9a-5d96-4fbd-8e2d-a2440225f93a&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 表示支持 Windows 7 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 表示支持 Windows 8 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;1f676c76-80e1-4239-95bb-83d0f6d0da78&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 表示支持 Windows 8.1 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">supportedOS</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">&quot;&#123;8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a&#125;&quot;</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 表示支持 Windows 10/11 --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">compatibility</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">application</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">windowsSettings</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dpiAware</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/SMI/2005/WindowsSettings&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">dpiAware</span>&gt;</span> <span class="hljs-comment">&lt;!-- 不想支持高 DPI 的话可以删除这段 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">longPathAware</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/SMI/2016/WindowsSettings&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">longPathAware</span>&gt;</span> <span class="hljs-comment">&lt;!-- 这是启用 Windows 的路径过长感知，保持默认即可 --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">windowsSettings</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- 以下后面会用到，先加上 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependentAssembly</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">assemblyIdentity</span></span><br><span class="hljs-tag">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;win32&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Microsoft.Windows.Common-Controls&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;6.0.0.0&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">&quot;*&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;6595b64144ccf1df&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">language</span>=<span class="hljs-string">&quot;*&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependentAssembly</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">assembly</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="代码布局"><a href="#代码布局" class="headerlink" title="代码布局"></a>代码布局</h3><p>推荐将所有有关主题的代码放在一个单独的静态类里，比如 ThemeManager：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThemeManager</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> CanUseDarkTheme &#123; <span class="hljs-keyword">get</span>; <span class="hljs-comment">/* private set; */</span> &#125; <span class="hljs-comment">// 指示是否要用深色主题</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkFore &#123; <span class="hljs-keyword">get</span>; &#125; = Color.White; <span class="hljs-comment">// 文字颜色</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkForeLink &#123; <span class="hljs-keyword">get</span>; &#125; = Color.FromArgb(<span class="hljs-number">153</span>, <span class="hljs-number">235</span>, <span class="hljs-number">255</span>); <span class="hljs-comment">// 超链接颜色</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkBack &#123; <span class="hljs-keyword">get</span>; &#125; = Color.FromArgb(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>); <span class="hljs-comment">// 背景颜色</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color DarkBorder &#123; <span class="hljs-keyword">get</span>; &#125; = Color.FromArgb(<span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>); <span class="hljs-comment">// 边框颜色</span><br><br>    <span class="hljs-comment">// 系统构建号，用于版本判断</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> OSBuild =&gt; field == <span class="hljs-number">0</span> ? field = Environment.OSVersion.Version.Build : field; <span class="hljs-comment">// 获取当前系统版本的构建号</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> Windows10_1903 = <span class="hljs-number">18362</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> Windows10_20H1 = <span class="hljs-number">18985</span>;<br><br>    <span class="hljs-comment">// 一些 WinAPI Interop，后面会介绍</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>窗体&#x2F;控件的话最好单独继承出来，方便复用各自的主题：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFormBase</span> : <span class="hljs-title">Form</span><br>&#123;<br>    <span class="hljs-comment">// 然你应用程序所有窗体继承自 MyFormBase</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-comment">/* sealed */</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyButton</span> : <span class="hljs-title">Button</span> <span class="hljs-comment">// 其他控件也是，可选是否密封 sealed</span><br>&#123;<br>    <span class="hljs-comment">// 之后直接使用自己封装的 MyButton 而不是 .NET 的</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>下面我们就正式开始挨个对控件应用深色主题了。</p>
<h3 id="Form"><a href="#Form" class="headerlink" title="Form"></a>Form</h3><p>窗体的深色主题非常简单，只需要设置 ForeColor、BackColor 就行了：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFormBase</span> : <span class="hljs-title">Form</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyFormBase</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Form1</span> : <span class="hljs-title">MyFormBase</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Form1</span>()</span><br>    &#123;<br>        InitializeComponent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此时编译并打开 Form1，你会发现窗体标题栏没有变黑，这是因为 Form，即窗口，由系统管理，.NET 管不到，所以要引入 WinAPI。</p>
<p>转到 ThemeManager，添加以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> DWMWA_USE_IMMERSIVE_DARK_MODE_BEFORE_20H1 = <span class="hljs-number">19</span>; <span class="hljs-comment">// ≥ 1903 且 ≤ 20H1</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> DWMWA_USE_IMMERSIVE_DARK_MODE = <span class="hljs-number">20</span>; <span class="hljs-comment">// 20H1 之后</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FlushWindow</span>(<span class="hljs-params">Form form</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (OSBuild &gt;= Windows10_1903)<br>    &#123;<br>        <span class="hljs-keyword">var</span> type = OSBuild &gt;= Windows10_20H1 ? DWMWA_USE_IMMERSIVE_DARK_MODE : DWMWA_USE_IMMERSIVE_DARK_MODE_BEFORE_20H1;<br>        <span class="hljs-keyword">var</span> enable = <span class="hljs-number">1</span>; <span class="hljs-comment">// 1 表示启用，0 禁用</span><br>        DwmSetWindowAttribute(form.Handle, type, <span class="hljs-keyword">ref</span> enable, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">int</span>));<br>    &#125;<br>&#125;<br><br>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;dwmapi.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">DwmSetWindowAttribute</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">int</span> dwAttribute, <span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> pvAttribute, <span class="hljs-built_in">int</span> cbAttribute</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>回到 MyFormBase，重写 OnHandleCreated (表示当窗口句柄 (HWND) 创建时，此时可以拿到 Handle)，并密封防止子类修改 (根据具体需求决定)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFormBase</span> : <span class="hljs-title">Form</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.FlushWindow(<span class="hljs-keyword">this</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终效果：</p>
<p><img src="/archive-imgs/38/1-dark-form.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Panel-Label-LinkLabel-PictureBox"><a href="#Panel-Label-LinkLabel-PictureBox" class="headerlink" title="Panel&#x2F;Label&#x2F;LinkLabel&#x2F;PictureBox"></a>Panel&#x2F;Label&#x2F;LinkLabel&#x2F;PictureBox</h3><p>这些控件都能跟随 <code>Form</code> 的前背景颜色，只不过 <code>LinkLabel</code> 要手动设置 <code>LinkColor</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyLinkLabel</span> : <span class="hljs-title">LinkLabel</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyLinkLabel</span>()</span><br>    &#123;<br>        AutoSize = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            LinkColor = ThemeManager.DarkForeLink;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终效果：</p>
<p><img src="/archive-imgs/38/9-dark-panel-label-link-picbox.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="GroupBox"><a href="#GroupBox" class="headerlink" title="GroupBox"></a>GroupBox</h3><p>GroupBox 的表现有点奇怪，我们先来看看默认效果：</p>
<p><img src="/archive-imgs/38/10-undark-gbox.png" srcset="/img/loading.gif" lazyload></p>
<p>可见标题依旧是黑色的，但里面的 Label 却正常，这说明 ForeColor、BackColor 只对它的子控件生效，不包括标题的颜色。还有一个细节不知道你发现没有，这个边框的颜色太白了，使得整个控件显得有点复古，但边框颜色也不能更改，怎么办呢？</p>
<p>这种情况下就要请出我们万能的 自绘 了，全称 自定义绘制 (Owner Draw)，也就是利用 GDI&#x2F;GDI+ 自己画控件的样式，虽然听着麻烦，但实际也能接受。也不用担心会有性能问题，因为控件本来也是这么画出来的，只不过都是系统预设而已，我们自己画说不定比系统还高效。</p>
<p>首先我们创建一个 MyGroupBox 继承自 GroupBox</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyGroupBox</span> : <span class="hljs-title">GroupBox</span><br>&#123;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后重写 OnPaint 方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnPaint</span>(<span class="hljs-params">PaintEventArgs e</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>    &#123;<br>        <span class="hljs-keyword">var</span> g = e.Graphics; <span class="hljs-comment">// 获取 Graphics，用来画画</span><br>        <span class="hljs-keyword">var</span> client = ClientSize; <span class="hljs-comment">// 获取 GroupBox 的客户区大小</span><br>        <span class="hljs-keyword">var</span> text = Text; <span class="hljs-comment">// 获取标题</span><br>        <span class="hljs-keyword">var</span> font = Font; <span class="hljs-comment">// 获取字体</span><br>        <span class="hljs-keyword">var</span> textHeight = TextRenderer.MeasureText(g, text, font, client).Height / <span class="hljs-number">2</span> + <span class="hljs-number">2</span>; <span class="hljs-comment">// 获取标题渲染后的高度</span><br>        <span class="hljs-keyword">var</span> rect = <span class="hljs-keyword">new</span> Rectangle(<span class="hljs-number">0</span>, textHeight, client.Width, client.Height - textHeight); <span class="hljs-comment">// 表示 GroupBox 的边框位置和大小</span><br>        <span class="hljs-keyword">var</span> textRect = Rectangle.Inflate(ClientRectangle, <span class="hljs-number">-4</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 让标题向右偏移一点，不然太靠前了</span><br><br>        ControlPaint.DrawBorder(g, rect, ThemeManager.DarkBorder, ButtonBorderStyle.Solid); <span class="hljs-comment">// GDI+ 画边框，颜色用我们定义的，看起来是深灰色</span><br>        TextRenderer.DrawText(g, text, font, textRect, ForeColor, BackColor, TextFormatFlags.Top | TextFormatFlags.Left | TextFormatFlags.LeftAndRightPadding | TextFormatFlags.EndEllipsis); <span class="hljs-comment">// GDI 画文字，并使用设置的 ForeColor, BackColor</span><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.OnPaint(e); <span class="hljs-comment">// 不是深色模式就交给系统来画</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看效果：</p>
<p><img src="/archive-imgs/38/11-dark-gbox.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="ContextMenu"><a href="#ContextMenu" class="headerlink" title="ContextMenu"></a>ContextMenu</h3><p>不同于 ContextMenuStrip，ContextMenu 是 WinForms 对 Win32 原生快捷菜单的低级封装 (因为继承自 Component 而不是 Control)，外观也比 Strip 好看很多。本文只对 ContextMenu 的深色主题进行讨论，同时如果你对右键菜单没有放置特殊控件的需求的话，也建议迁移到 ContextMenu。</p>
<p>有关如何创建 ContextMenu，可以看看<a href="https://wanghaonie.github.io/posts/95b4fdac793d/">这篇</a>文章。</p>
<p>ContextMenu 的深色主题可以用系统提供的 API，这是一个未公开的 API，不排除微软有可能在未来修改&#x2F;删除它的可能，但现阶段没有问题，那我们就悄悄的用。调用之后整个应用程序范围内的 ContextMenu 全部都有深色主题了。</p>
<p>转到 ThemeManager，添加以下 WinAPI 以及枚举。由于这个函数没有公开，且通过一些手段发现它在 uxtheme.dll 中导出的序号为 135，故需要显式指定 EntryPoint，用 # 表示让 CLR (.NET 运行时) 将 135 当作序号去调用函数而不是名称。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThemeManager</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br><br>    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;uxtheme.dll&quot;</span>, EntryPoint = <span class="hljs-string">&quot;#135&quot;</span>)</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetPreferredAppMode</span>(<span class="hljs-params">PreferredAppMode preferredAppMode</span>)</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> PreferredAppMode <span class="hljs-comment">// 我们一般把枚举写在类的外面，避免嵌套，不然在访问的时候还要加类名</span><br>&#123;<br>    Default,<br>    AllowDark,<br>    ForceDark, <span class="hljs-comment">// 一般用这个枚举，表示强制将应用程序主题设置为深色，值为 2</span><br>    ForceLight,<br>    Max<br>&#125;<br></code></pre></td></tr></table></figure>

<p>转到程序的入口 (Program.cs)，在 Main 方法中的 Application 系列方法之前调用它。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><br>&#123;<br>    [<span class="hljs-meta">STAThread</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.SetPreferredAppMode(PreferredAppMode.ForceDark);<br>        &#125;<br><br>        Application.EnableVisualStyles();<br>        Application.SetCompatibleTextRenderingDefault(<span class="hljs-literal">false</span>);<br>        Application.Run(<span class="hljs-keyword">new</span> Form1());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>右键窗体标题栏就能看到了，这是最终效果：</p>
<p><img src="/archive-imgs/38/12-dark-contextmenu.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h3><p>按钮的深色主题的应用就简单很多了，只需在 ThemeManager 里添加以下 WinAPI</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;uxtheme.dll&quot;</span>, CharSet = CharSet.Unicode)</span>] <span class="hljs-comment">// Unicode 表示传入的字符串都被当作 宽字符 处理</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SetWindowTheme</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">string</span> pszSubAppName, <span class="hljs-built_in">string</span> pszSubIdList</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>然后创建 MyButton 继承自 Button，重写 OnHandleCreated</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PlainButton</span> : <span class="hljs-title">Button</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PlainButton</span>(<span class="hljs-params">ContextMenu menu</span>)</span><br>    &#123;<br>        FlatStyle = FlatStyle.System; <span class="hljs-comment">// 让按钮使用系统样式</span><br>        UseVisualStyleBackColor = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>“DarkMode_Explorer” 是系统内置的 (位于 aero.msstyles 文件) 包含深色 Button 的主题的名称；第三个参数按理来说应该传入 “Button”，但传入 null 会让 API 自己去判断用哪个，所以也可以直接传 null。</p>
<p>看看效果：</p>
<p><img src="/../archive-imgs/38/13-dark-button.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="RadioButton-CheckBox"><a href="#RadioButton-CheckBox" class="headerlink" title="RadioButton&#x2F;CheckBox"></a>RadioButton&#x2F;CheckBox</h3><p>这两个控件其实也和 Button 差不多，但在禁用状态时，文字会看不清，可能是 WinForms 封装时某些代码干扰了主题运作，所以就单独提出来了。</p>
<p>由于这两个控件在 WinForms&#x2F;Win32 中都继承自 ButtonBase&#x2F;Button，所以我们可以创建一个辅助类来侧载。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyButtonBase</span> <span class="hljs-comment">// 注意，不用继承自任何基类</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ButtonBase Target;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyButtonBase</span>(<span class="hljs-params">ButtonBase target</span>)</span><br>    &#123;<br>        target.UseVisualStyleBackColor = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            Target = target;<br>            Target.EnabledChanged += Button_EnabledChanged; <span class="hljs-comment">// 绑定启用状态更改事件</span><br>            UpdateStyle();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Button_EnabledChanged</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs e</span>)</span><br>    &#123;<br>        UpdateStyle();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateStyle</span>()</span><br>    &#123;<br>        Target.FlatStyle = Target.Enabled ? FlatStyle.Standard : FlatStyle.System;<br>        ThemeManager.SetWindowTheme(Target.Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// 根据多次试验，我发现当启用时使用 Standard 主题，禁用时用 System 主题可以有效解决文字看不清的问题</span><br>        <span class="hljs-comment">// 记得要再次调用 API 刷新主题。</span><br>    &#125;<br><br>    ~MyButtonBase()<br>    &#123;<br>        <span class="hljs-keyword">if</span> (Target != <span class="hljs-literal">null</span>)<br>        &#123;<br>            Target.EnabledChanged -= Button_EnabledChanged; <span class="hljs-comment">// 析构函数解绑事件，也可以不用</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>同样我们也需要创建 MyRadioButton 和 MyCheckBox，然后在构造函数中直接创建辅助类实例就完成了</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyRadioButton</span> : <span class="hljs-title">RadioButton</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyRadioButton</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> MyButtonBase(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyCheckBox</span> : <span class="hljs-title">CheckBox</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyCheckBox</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> MyButtonBase(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看效果：</p>
<p><img src="/../archive-imgs/38/14-dark-rb-cb.png" srcset="/img/loading.gif" lazyload></p>
<p>你会发现在禁用状态下，文字会更偏向左侧，但这在 Win32 中是没有的，WinForms 的话也只能暂时这样了。</p>
<h3 id="TextBox-ComboBox"><a href="#TextBox-ComboBox" class="headerlink" title="TextBox&#x2F;ComboBox"></a>TextBox&#x2F;ComboBox</h3><p>这两玩意儿也比较好搞，不过除了需要调用 API，还需要设置 ForeColor、BackColor。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyComboBox</span> : <span class="hljs-title">ComboBox</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyComboBox</span>()</span><br>    &#123;<br>        DropDownStyle = ComboBoxStyle.DropDownList; <span class="hljs-comment">// 表示 ComboBox 应具有下拉菜单</span><br>        FlatStyle = FlatStyle.System;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_CFD&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyTextBox</span> : <span class="hljs-title">TextBox</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_CFD&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意包含它们两个的深色主题的名称是 “DarkMode_CFD”。</p>
<p>看看效果：</p>
<p><img src="/../archive-imgs/38/15-dark-textbox-combobox.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="TreeView-TabControl"><a href="#TreeView-TabControl" class="headerlink" title="TreeView&#x2F;TabControl"></a>TreeView&#x2F;TabControl</h3><p>可能大家很少用这个控件，这里提出来也是利用它作为垂直导航栏来代替 TabControl，因为 TabControl 的深色主题不好搞，详见 <a href="https://wanghaonie.github.io/posts/818a54b277f2/">摆脱 TabControl，教你打造高颜值原生样式的垂直导航栏</a>。</p>
<p>当然我们也可以直接用，首先我们创建 MyTreeView</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyTreeView</span> : <span class="hljs-title">TreeView</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>); <br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看效果：</p>
<p><img src="/../archive-imgs/38/16-dark-treeview.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="NumericUpDown"><a href="#NumericUpDown" class="headerlink" title="NumericUpDown"></a>NumericUpDown</h3><p>NumericUpDown 是本文中遇到的第一个复合控件，也就是说它由两个控件组成：UpDownEdit 和 UpDownButtons，当然这两个类型是专有的，所以我们不能在公开类型里找到。</p>
<p><img src="/../archive-imgs/38/19-nud-components.png" srcset="/img/loading.gif" lazyload></p>
<p>但这并不代表我们不能通过代码获得它们的实例，当然也不需要反射。想想，如果是你，要将多个控件放在一个容器里面，你会怎么做？</p>
<p>是不是往 Controls 集合里塞就对了？所以我们直接遍历 NumericUpDown 的 Controls 集合就能看到它俩了。</p>
<p>首先老规矩，创建 MyNumericUpDown，设置必要属性，重写 OnHandleCreated：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyNumericUpDown</span> : <span class="hljs-title">NumericUpDown</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyNumericUpDown</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>        &#125;<br><br>        TextAlign = HorizontalAlignment.Right;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们先试着在 OnHandleCreated 里遍历一下，看看有没有收获。顺便在 foreach 这里打个断点</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>&#123;<br>    <span class="hljs-keyword">foreach</span> (Control control <span class="hljs-keyword">in</span> Controls) <span class="hljs-comment">// &lt;- 断点</span><br>    &#123;<br>        <br>    &#125;<br><br>    <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看效果</p>
<p><img src="/../archive-imgs/38/20-nud-components-vsbpoint.png" srcset="/img/loading.gif" lazyload></p>
<p>可见确实由两个控件组成，分别是 UpDownButtons 和 UpDownEdit。</p>
<p>那我们就直接应用主题。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">foreach</span> (Control control <span class="hljs-keyword">in</span> Controls) <span class="hljs-comment">// &lt;- 断点</span><br>&#123;<br>    ThemeManager.SetWindowTheme(control.Handle, <span class="hljs-string">&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其实 DarkMode_CFD 也可以，但只对 UpDownEdit 生效，使用 DarkMode_Explorer 的话两者都可以被应用深色主题。</p>
<p>看看效果：</p>
<p><img src="/../archive-imgs/38/21-dark-nud.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="ListView"><a href="#ListView" class="headerlink" title="ListView"></a>ListView</h3><p>ListView 就比较复杂了，因为它也是复合控件，标题栏就是一个控件 (SysHeader32)，列表就是 ListView 本身，我们还是按照老办法来看看 Controls 集合。</p>
<p>还是先创建 MyListView，设置必要属性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyListView</span> : <span class="hljs-title">ListView</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyListView</span>()</span><br>    &#123;<br>        View = View.Details; <span class="hljs-comment">// 列表详细视图</span><br>        FullRowSelect = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 整行选择</span><br>        HideSelection = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 失去焦点不隐藏选中项</span><br>        ShowItemToolTips = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 内容超出范围显示 ToolTip</span><br>        BorderStyle = BorderStyle.None; <span class="hljs-comment">// 不显示白色边框，这个看具体需求</span><br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ForeColor = ThemeManager.DarkFore;<br>            BackColor = ThemeManager.DarkBack;<br>        &#125;<br><br>        SetStyle(ControlStyles.AllPaintingInWmPaint | ControlStyles.OptimizedDoubleBuffer, <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// 开启双缓冲，防止闪烁与卡顿</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> b = Controls; <span class="hljs-comment">// &lt;- 打断点</span><br><br>        <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>        &#123;<br>            ThemeManager.SetWindowTheme(Handle, <span class="hljs-string">&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意 ListView 的主题名称应该是 DarkMode_ItemsView。</p>
<p>看看 Controls 集合：</p>
<p><img src="/../archive-imgs/38/22-listview-controls.png" srcset="/img/loading.gif" lazyload></p>
<p>这不天塌了？Controls 里啥也没有，标题栏根本就没在 Controls 里，为什么？</p>
<p>这是因为标题栏是 ListView 底层动态创建的控件，WinForms 根本没有封装，自然就看不到了。那我们怎么看到？</p>
<p>还记得我们安装的 C++ 吗，它会自带 Spy++，我们可以用这个工具探测一下，在 Visual Studio 工具栏：工具 &gt;Spy++</p>
<p><img src="/../archive-imgs/38/23-listviewheader-spyxx.png" srcset="/img/loading.gif" lazyload></p>
<p>这不，它在这呢。同时你也可以看到，标题栏根本没有被应用主题。</p>
<p>显然，如果能获取到标题栏的句柄的话，一切都好办了。你可能会想到用 EnumChildWindows 函数枚举子窗口，只能说有思路了，但不够。</p>
<p>如果你在搜索引擎里搜索 listview get header，你会发现：</p>
<p><img src="/../archive-imgs/38/24-google-lvh.png" srcset="/img/loading.gif" lazyload></p>
<p>好家伙，居然有一个跟关键词一模一样的函数 (其实是宏)，这也太棒了。<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/commctrl/nf-commctrl-listview_getheader">点</a>进去看看。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">返回值<br>类型：HWND<br><br>返回标头控件的句柄。<br></code></pre></td></tr></table></figure>
<p>看到这行描述没有？—— 返回标头控件的句柄。</p>
<p>那么这个宏是怎么实现的呢？其实就是用 SendMessage 给 ListView 发了一个 LVM_GETHEADER 消息，然后该函数的返回值就是标题栏的句柄。</p>
<p>可能这对刚接触消息循环的朋友比较难懂，那我们来仿生一下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">(你调用了 SendMessage ...)<br><br>SendMessage: @ListView，交出你标题栏的句柄。<br>(SendMessage 向 ListView 的 HWND 发送了 LVM_GETHEADER 消息 ...)<br><br>ListView: 收到，哥们儿！<br>(ListView 内部获取标题栏的 HWND 并传给了 SendMessage ...)<br><br>(你拿到了 SendMessage 的返回值，它就是标题栏的 HWND)<br></code></pre></td></tr></table></figure>

<p>上述操作在 WinAPI 里很常见，需要新手朋友们加深理解，以及适应这种机制。</p>
<p>现在我们就可以转到 C++ 了，因为 ListView 深色主题本来就很复杂。</p>
<p>右键我们的 Natives 项目，选择添加 &gt;新项<br><img src="/../archive-imgs/38/25-cpp-new-item.png" srcset="/img/loading.gif" lazyload></p>
<p>选择头文件 (*.h)，命名为 ListViewHelper<br><img src="/../archive-imgs/38/26-cpp-new-h.png" srcset="/img/loading.gif" lazyload></p>
<p>头文件第一行默认就是 <code>#pragma once</code>，它是用于防止多次引用的，不要删除</p>
<p>同样方式我们添加一个源文件 (*.cpp)，也命名为 ListViewHelper，并加上预编译头 (Visual Studio 规定的) 和我们 ListViewHelper.h</p>
<p><img src="/../archive-imgs/38/27-created-h-cpp.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;pch.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ListViewHelper.h&quot;</span></span><br></code></pre></td></tr></table></figure>
<p><img src="/../archive-imgs/38/28-cpp-add-include.png" srcset="/img/loading.gif" lazyload></p>
<p>转到头文件，添加引用，以及声明导出函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Uxtheme.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;CommCtrl.h&gt;</span></span><br><br><span class="hljs-built_in">cexport</span>(<span class="hljs-type">void</span>) <span class="hljs-built_in">SetListViewTheme</span>(HWND hListView);<br></code></pre></td></tr></table></figure>
<p>参数 hListView 的命名方式表示 Handle of ListView，跟 hWnd (Handle of Window) 保持一致的格式即可，有助于提高可读性</p>
<p>转到源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetListViewTheme</span><span class="hljs-params">(HWND hListView)</span> <span class="hljs-comment">// 保持签名与头文件声明的一致</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">SetWindowTheme</span>(hListView, <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// 应用到 ListView 自己</span><br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetHeader</span>(hListView), <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// 应用到标题栏</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于 Win32 新手朋友们，请注意：</p>
<ul>
<li>C# 的 null 在 C++ 里对应 nullptr</li>
<li>C# 的 string <strong>在这里</strong>对应 C++ 的 LPCWSTR (底层类型 <code>const w_char*</code>，宽字符，Unicode)，书写时需要在 <code>&quot;&quot;</code> 左侧加上 <code>L</code>：<code>L&quot;&quot;</code></li>
</ul>
<p>转到 C# 项目，在 ThemeManager 里，声明导入函数：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;Natives.dll&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetListViewTheme</span>(<span class="hljs-params">IntPtr hListView</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>转到 MyListView，删除之前的，直接更改为：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ThemeManager.CanUseDarkTheme)<br>    &#123;<br>        ThemeManager.SetListViewTheme(Handle);<br>    &#125;<br><br>    <span class="hljs-keyword">base</span>.OnHandleCreated(e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看效果</p>
<p><img src="/../archive-imgs/38/29-half-dark-listview.png" srcset="/img/loading.gif" lazyload></p>
<p>有点尴尬，你就说有没有主题吧，只是文字没有适应罢了。</p>
<p>那我们还得继续，怎么办呢？直接反手就是个子类化，这里参考了 <a target="_blank" rel="noopener" href="https://github.com/ysc3839/win32-darkmode/blob/master/win32-darkmode/ListViewUtil.h">ysc3839&#x2F;win32-darkmode</a> 的代码。</p>
<p>转到 ListViewHelper.cpp，我们写一个函数表示子类化过程，要写在 SetListViewTheme 前面</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> LRESULT CALLBACK <span class="hljs-title">ListViewSubclass</span><span class="hljs-params">(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam, UINT_PTR uIdSubclass, DWORD_PTR)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (uMsg)<br>    &#123;<br>        <span class="hljs-keyword">case</span> WM_NOTIFY:<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">reinterpret_cast</span>&lt;LPNMHDR&gt;(lParam)-&gt;code == NM_CUSTOMDRAW)<br>            &#123;<br>                LPNMCUSTOMDRAW nmcd = <span class="hljs-built_in">reinterpret_cast</span>&lt;LPNMCUSTOMDRAW&gt;(lParam);<br><br>                <span class="hljs-keyword">switch</span> (nmcd-&gt;dwDrawStage)<br>                &#123;<br>                    <span class="hljs-keyword">case</span> CDDS_PREPAINT:<br>                        <span class="hljs-keyword">return</span> CDRF_NOTIFYITEMDRAW;<br>                    <span class="hljs-keyword">case</span> CDDS_ITEMPREPAINT:<br>                        <span class="hljs-built_in">SetTextColor</span>(nmcd-&gt;hdc, <span class="hljs-built_in">RGB</span>(<span class="hljs-number">222</span>, <span class="hljs-number">222</span>, <span class="hljs-number">222</span>));<br>                        <span class="hljs-comment">// (222, 222, 222) 这个颜色跟 Windows 资源管理器的 ListView 的标题栏的文字颜色一样的，表现为浅灰色</span><br>                        <span class="hljs-keyword">return</span> CDRF_DODEFAULT;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> WM_NCDESTROY:<br>        &#123;<br>            <span class="hljs-built_in">RemoveWindowSubclass</span>(hWnd, ListViewSubclass, uIdSubclass);<br>            <span class="hljs-comment">// 记得在 ListView 关闭时移除子类化函数</span><br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">DefSubclassProc</span>(hWnd, uMsg, wParam, lParam); <span class="hljs-comment">// 让 DefSubclassProc 处理我们没有处理的消息</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>原理其实也相当于自绘，只不过比较高明，这也是微软推荐的方式，而不是重写 OnPaint (WM_PAINT)。</p>
<p>转到 SetListViewTheme 函数，启用子类化</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetListViewTheme</span><span class="hljs-params">(HWND hListView)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">SetWindowSubclass</span>(hListView, ListViewSubclass, <span class="hljs-built_in">reinterpret_cast</span>&lt;UINT_PTR&gt;(hListView), <span class="hljs-number">0</span>);<br><br>	<span class="hljs-built_in">SetWindowTheme</span>(hListView, <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetHeader</span>(hListView), <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>看看效果</p>
<p><img src="/../archive-imgs/38/30-dark-listview-no-tt.png" srcset="/img/loading.gif" lazyload></p>
<p>你以为就完了吗，如果我们把内容弄长一点，然后鼠标放上去，你就会发现…</p>
<p><img src="/../archive-imgs/38/31-undark-listview-tt.png" srcset="/img/loading.gif" lazyload></p>
<p>惊不惊喜，意不意外！还有一个控件呢！</p>
<p>这是什么？它的学名叫 ToolTip，用于… emmm … 反正就长这样，但它实际上是一个窗口。那么这个玩意儿的句柄怎么获取，然后应用深色主题呢？老样子，先看文档，文档没有再想其他办法。</p>
<p>转到我们之前找到的 ListView_GetHeader 的<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/commctrl/nf-commctrl-listview_getheader">页面</a>，看看左侧，这是什么？你不觉得对它有个很微妙的感觉吗，感觉有什么好东西就要来了？</p>
<p><img src="/../archive-imgs/38/32-msdoc-lv-get-tt-mac.png" srcset="/img/loading.gif" lazyload></p>
<p>直接点进去，看看它是干什么的</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">返回值<br>类型：HWND<br><br>返回工具提示 (ToolTip) 控件的句柄。<br></code></pre></td></tr></table></figure>
<p>看吧，果然，这不就是我们想要的？开搞！</p>
<p>转到 ListViewHelper.cpp 的 SetListViewTheme 那里：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetListViewTheme</span><span class="hljs-params">(HWND hListView)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">SetWindowSubclass</span>(hListView, ListViewSubclass, <span class="hljs-built_in">reinterpret_cast</span>&lt;UINT_PTR&gt;(hListView), <span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(hListView, <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetHeader</span>(hListView), <span class="hljs-string">L&quot;DarkMode_ItemsView&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>	<span class="hljs-built_in">SetWindowTheme</span>(<span class="hljs-built_in">ListView_GetToolTips</span>(hListView), <span class="hljs-string">L&quot;DarkMode_Explorer&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看效果：</p>
<p><img src="/../archive-imgs/38/33-dark-listview-tt.png" srcset="/img/loading.gif" lazyload></p>
<p>大功告成，ListView 就到此为止。</p>
<h2 id="可能的疑问"><a href="#可能的疑问" class="headerlink" title="可能的疑问"></a>可能的疑问</h2><h3 id="为什么要在-OnHandleCreated-方法里面调用-API，不能在构造函数里面吗？"><a href="#为什么要在-OnHandleCreated-方法里面调用-API，不能在构造函数里面吗？" class="headerlink" title="为什么要在 OnHandleCreated 方法里面调用 API，不能在构造函数里面吗？"></a>为什么要在 OnHandleCreated 方法里面调用 API，不能在构造函数里面吗？</h3><ol>
<li>为了避免有时在运行过程中需要重绘导致句柄也重新创建的极端情况，所有推荐最好在 OnHandleCreated 里调用 API，不然一旦句柄重新创建</li>
</ol>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>由于原生深色主题是系统自带的功能，所以只要你的窗口框架或控件都是原生类型的话，理论上不光 C# 可以，其他编程语言比如 C&#x2F;C++ 等也可以实现原生深色主题。</p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Win32 Dark Mode<br><a target="_blank" rel="noopener" href="https://gist.github.com/rounk-ctrl/b04e5622e30e0d62956870d5c22b7017">https://gist.github.com/rounk-ctrl/b04e5622e30e0d62956870d5c22b7017</a></li>
<li>ysc3839&#x2F;win32-darkmode: Example application shows how to use undocumented dark mode API introduced in Windows 10 1809.<br><a target="_blank" rel="noopener" href="https://github.com/ysc3839/win32-darkmode">https://github.com/ysc3839/win32-darkmode</a></li>
<li>BlueMystical&#x2F;Dark-Mode-Forms: Apply Dark Mode to all Controls in a Form [WinForms]<br><a target="_blank" rel="noopener" href="https://github.com/BlueMystical/Dark-Mode-Forms">https://github.com/BlueMystical/Dark-Mode-Forms</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Windows/" class="print-no-link">#Windows</a>
      
        <a href="/tags/CSharp/" class="print-no-link">#CSharp</a>
      
        <a href="/tags/WinForms/" class="print-no-link">#WinForms</a>
      
        <a href="/tags/Cpp/" class="print-no-link">#Cpp</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>从零开始让你的 WinForms 应用程序也用上原生深色主题</div>
      <div>https://wanghaonie.github.io/posts/00d12b183e8c/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>WangHaonie</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025-07-23 08:31:03</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025-07-23 23:22:43</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/d1afa7a5de7f/" title="【C#】for 和 foreach 循环的选择">
                        <span class="hidden-mobile">【C#】for 和 foreach 循环的选择</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span> Hexo </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span> Fluid </span></a><br> <div><a> <span id="site-runtime">正在加载网站运行时间，请稍候...</span> <script src="/js/runtime.js"></script> </a></div> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a rel="nofollow noopener">
      Copyright © 2023-2025 WangHaonie
    </a>
  </span>
  
    
      <span>
        <a
          href="https://icp.gov.moe/?keyword=20229939"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/icon_moeicp.png" srcset="/img/loading.gif" lazyload/>
          
          <span>萌ICP备20229939号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>




  
<script src="/js/customstyles.js"></script>
<script src="/js/subsiteredirect.js"></script>
<script src="/js/bgribbon.js"></script>
<script src="/js/curfireworks.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
